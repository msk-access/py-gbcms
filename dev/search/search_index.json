{"config":{"lang":["en"],"separator":"[\\s\\-,:!=\\[\\]()\"/]+|(?!\\b)(?=[A-Z][a-z])|\\,(?!\\d)|&[lg]t;","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"Home","text":""},{"location":"#py-gbcms","title":"py-gbcms","text":"<p>Get Base Counts Multi-Sample \u2014 High-performance variant counting from BAM files</p> <p> </p>"},{"location":"#what-it-does","title":"What It Does","text":"<p>GBCMS extracts allele counts and variant metrics at specified positions in BAM files:</p> <pre><code>flowchart LR\n    subgraph Input\n        VCF[VCF/MAF]\n        BAM[BAM Files]\n    end\n\n    subgraph Output\n        Counts[Allele Counts]\n        Metrics[VAF, Strand Bias]\n    end\n\n    VCF --&gt; Engine[gbcms]\n    BAM --&gt; Engine\n    Engine --&gt; Counts\n    Engine --&gt; Metrics\n</code></pre>  Use mouse to pan and zoom"},{"location":"#key-metrics","title":"Key Metrics","text":"Metric Formula Description VAF <code>AD / (RD + AD)</code> Variant Allele Frequency Strand Bias Fisher's exact test Detect sequencing artifacts Fragment Counts Deduplicated pairs PCR-aware counting"},{"location":"#quick-start","title":"Quick Start","text":"<pre><code># Install\npip install py-gbcms\n\n# Run\ngbcms run --variants variants.vcf --bam sample.bam --fasta ref.fa --output-dir results/\n</code></pre> <p>\u2192 Full Installation Guide | \u2192 CLI Examples</p>"},{"location":"#choose-your-workflow","title":"Choose Your Workflow","text":"<pre><code>flowchart TD\n    Start[How many samples?] --&gt; Few{1-10 samples}\n    Start --&gt; Many{10+ samples}\n\n    Few --&gt; CLI([Use CLI]):::cli\n    Many --&gt; HPC{HPC cluster?}\n\n    HPC --&gt; |Yes| Nextflow([Use Nextflow]):::nf\n    HPC --&gt; |No| CLI\n\n    classDef cli fill:#4caf50,color:white,stroke:#388e3c,stroke-width:2px;\n    classDef nf fill:#2196f3,color:white,stroke:#1565c0,stroke-width:2px;\n</code></pre>  Use mouse to pan and zoom  Workflow Best For Guide CLI 1-10 samples, local/single server Quick Start Nextflow 10+ samples, HPC/SLURM Nextflow Guide"},{"location":"#architecture","title":"Architecture","text":"<p>Python/Rust hybrid for maximum performance:</p> <pre><code>flowchart TB\n    subgraph Python [\ud83d\udc0d Python]\n        CLI[CLI] --&gt; Pipeline[Orchestration]\n        Pipeline --&gt; IO[VCF/MAF I/O]\n    end\n\n    subgraph Rust [\ud83e\udd80 Rust]\n        Counter[BAM Counting]\n        Stats[Fisher Test]\n    end\n\n    Pipeline --&gt; Counter\n    Counter --&gt; Stats\n\n    classDef pythonStyle fill:#3776ab,color:#fff,stroke:#2c5f8a,stroke-width:2px;\n    classDef rustStyle fill:#dea584,color:#000,stroke:#c48a6a,stroke-width:2px;\n    class Python pythonStyle;\n    class Rust rustStyle;\n</code></pre>  Use mouse to pan and zoom  <p>\u2192 Technical Details | \u2192 Variant Counting</p>"},{"location":"#documentation","title":"Documentation","text":"Section Description Getting Started Installation and first run CLI Reference Command-line usage Nextflow Pipeline HPC workflow Reference Architecture and formats Variant Counting How each variant type is counted Development Contributing guide"},{"location":"CHANGELOG/","title":"Changelog","text":""},{"location":"CHANGELOG/#changelog","title":"Changelog","text":"<p>All notable changes to this project will be documented in this file.</p> <p>The format is based on Keep a Changelog, and this project adheres to Semantic Versioning.</p>"},{"location":"CHANGELOG/#230-2026-02-06","title":"[2.3.0] - 2026-02-06","text":""},{"location":"CHANGELOG/#added","title":"\u2728 Added","text":"<ul> <li>Nextflow BAI Auto-Discovery: Checks <code>.bam.bai</code> and <code>.bai</code> extensions automatically</li> <li>Documentation Modernization: Hierarchical navigation, glightbox, panzoom, abbreviations</li> <li>Performance Benchmarks: cfDNA duplex sample metrics in documentation</li> <li>RHEL 8 Installation Guide: Conda-based source installation for legacy Linux</li> </ul>"},{"location":"CHANGELOG/#changed","title":"\ud83d\udd04 Changed","text":"<ul> <li>Dockerfile: Added <code>procps</code>, <code>bash</code>, OCI labels, <code>maturin[patchelf]</code>, selective COPY</li> <li>Nextflow Config: <code>--platform linux/amd64</code>, shell config, local profile, observability (trace/report/timeline/dag)</li> <li>MkDocs: Switched to <code>navigation.sections</code>, 20+ abbreviations with hover tooltips</li> <li>GitHub Actions: Consolidated deploy-docs workflows, added caching and PR validation</li> <li>CI Wheels: Migrated from <code>manylinux_2_28</code> to <code>manylinux_2_34</code> (AlmaLinux 9 with OpenSSL 3.0+)</li> </ul>"},{"location":"CHANGELOG/#fixed","title":"\ud83d\udd27 Fixed","text":"<ul> <li>Nextflow: Empty <code>--suffix</code> argument no longer causes failures</li> <li>Admonitions: Converted GitHub-style alerts to MkDocs syntax</li> <li>CI Build: Resolved <code>curl-sys</code> OpenSSL version conflict by switching to manylinux_2_34</li> </ul>"},{"location":"CHANGELOG/#220-2026-02-04","title":"[2.2.0] - 2026-02-04","text":""},{"location":"CHANGELOG/#added_1","title":"\u2728 Added","text":"<ul> <li>Multi-platform Wheel Publishing: Maturin-based CI builds for Linux (x86_64, aarch64), macOS (Intel, Apple Silicon), and Windows</li> <li>Structured Logging: New <code>utils/logging.py</code> module with Rich console output, timing utilities, and log file support</li> <li>Mermaid Diagrams: Architecture documentation with interactive flowcharts</li> <li>Release Guide: Comprehensive <code>docs/RELEASE.md</code> with git-flow workflow</li> </ul>"},{"location":"CHANGELOG/#changed_1","title":"\ud83d\udd04 Changed","text":"<ul> <li>Folder Restructure: Moved Rust code to <code>rust/</code> (bundled as <code>gbcms._rs</code>)</li> <li>Config Hierarchy: Nested Pydantic models (<code>ReadFilters</code>, <code>QualityThresholds</code>, <code>OutputConfig</code>) for better organization</li> <li>Code Quality: Added <code>__all__</code> exports, docstrings, and type hints across all modules</li> <li>StrEnum: Modern enum pattern with Python 3.10 backport</li> </ul>"},{"location":"CHANGELOG/#documentation","title":"\ud83d\udcda Documentation","text":"<ul> <li>New <code>docs/ARCHITECTURE.md</code> with system diagrams</li> <li>New <code>docs/DEVELOPMENT.md</code> (developer guide)</li> <li>New <code>docs/TESTING.md</code> (testing guide)</li> <li>Updated MkDocs with mermaid2 plugin and snippet includes</li> </ul>"},{"location":"CHANGELOG/#212-2025-11-25","title":"[2.1.2] - 2025-11-25","text":""},{"location":"CHANGELOG/#fixed_1","title":"\ud83d\udd27 Fixed","text":"<ul> <li>PyPI Distribution: Fixed source distribution size issue by correctly excluding large files (tests, docs, etc.) via <code>pyproject.toml</code> configuration.</li> </ul>"},{"location":"CHANGELOG/#211-2025-11-25-yanked","title":"[2.1.1] - 2025-11-25 [YANKED]","text":"<p>Yanked Release</p> <p>This release was yanked from PyPI due to a source distribution size limit error. Use 2.1.2 instead.</p>"},{"location":"CHANGELOG/#fixed_2","title":"\ud83d\udd27 Fixed","text":"<ul> <li>PyPI Distribution: Added MANIFEST.in (failed to work with Hatchling) to reduce source distribution size</li> <li>Documentation: Added comprehensive Installation guide</li> <li>Documentation: Unified Contributing guide (merged code + docs contributions)</li> <li>Documentation: Added Changelog to documentation navigation</li> </ul>"},{"location":"CHANGELOG/#210-2025-11-25","title":"[2.1.0] - 2025-11-25","text":""},{"location":"CHANGELOG/#added_2","title":"\u2728 Added","text":""},{"location":"CHANGELOG/#nextflow-workflow","title":"Nextflow Workflow","text":"<ul> <li>Production-ready Nextflow workflow for processing multiple samples in parallel</li> <li>SLURM cluster support with customizable queue configuration</li> <li>Per-sample suffix support via optional <code>suffix</code> column in samplesheet</li> <li>Docker and Singularity profiles for containerized execution</li> <li>Automatic BAI index discovery with validation</li> <li>Resume capability for failed workflow runs</li> <li>Resource management with automatic retry and scaling</li> <li>Comprehensive documentation in <code>docs/NEXTFLOW.md</code> and <code>nextflow/README.md</code></li> </ul>"},{"location":"CHANGELOG/#documentation_1","title":"Documentation","text":"<ul> <li>Usage pattern comparison guide (<code>docs/WORKFLOWS.md</code>) for choosing between CLI and Nextflow</li> <li>MkDocs integration for beautiful GitHub Pages documentation</li> <li>Local documentation preview with live reload (<code>mkdocs serve</code>)</li> <li>Staging deployment from <code>develop</code> branch for testing docs</li> <li>Production deployment from <code>main</code> branch</li> <li>Reorganized documentation structure with clear CLI vs Nextflow separation</li> <li>CLI Quick Start guide (<code>docs/quick-start.md</code>)</li> </ul>"},{"location":"CHANGELOG/#changed_2","title":"\ud83d\udd27 Changed","text":"<ul> <li>Documentation workflow: docs now live on <code>main</code> branch with automated deployment</li> <li>GitBook integration: configured to read from <code>main</code> branch</li> <li>Nextflow module: improved parameter passing with meta.suffix support</li> </ul>"},{"location":"CHANGELOG/#documentation_2","title":"\ud83d\udcdd Documentation","text":"<ul> <li>Complete Nextflow workflow guide with SLURM examples</li> <li>Per-sample suffix usage examples</li> <li>Git-flow documentation workflow guide</li> <li>Local preview instructions</li> <li>Updated README with clear usage pattern separation</li> </ul>"},{"location":"CHANGELOG/#200-2025-11-21","title":"[2.0.0] - 2025-11-21","text":""},{"location":"CHANGELOG/#major-rewrite","title":"\ud83d\ude80 Major Rewrite","text":"<p>Version 2.0.0 represents a complete rewrite of py-gbcms with a focus on performance, correctness, and modern architecture.</p>"},{"location":"CHANGELOG/#added_3","title":"\u2728 Added","text":""},{"location":"CHANGELOG/#core-features","title":"Core Features","text":"<ul> <li>Rust-based Counting Engine: Hybrid Python/Rust architecture for 20x+ performance improvement</li> <li>Strand Bias Statistics: Fisher's exact test p-values and odds ratios for both reads (<code>SB_PVAL</code>, <code>SB_OR</code>) and fragments (<code>FSB_PVAL</code>, <code>FSB_OR</code>)</li> <li>Fragment-Level Counting: Majority-rule fragment counting with strand-specific counts (<code>RDF</code>, <code>ADF</code>)</li> <li>Variant Allele Fractions: Read-level (<code>VAF</code>) and fragment-level (<code>FAF</code>) allele fraction calculations</li> <li>Thread Control: Explicit control over parallelism via <code>--threads</code> argument (default: 1)</li> </ul>"},{"location":"CHANGELOG/#inputoutput","title":"Input/Output","text":"<ul> <li>VCF Output Format: Standard VCF with comprehensive INFO and FORMAT fields</li> <li>MAF Output Format: Extended MAF with custom columns for strand counts and statistics</li> <li>Column Preservation: Input MAF columns are preserved in output</li> <li>Multiple BAM Support: Process multiple samples via <code>--bam-list</code> or repeated <code>--bam</code> arguments</li> <li>Sample ID Override: Explicit sample naming via <code>--bam sample_id:path</code> syntax</li> </ul>"},{"location":"CHANGELOG/#filters","title":"Filters","text":"<ul> <li><code>--filter-duplicates</code>: Filter duplicate reads (default: enabled)</li> <li><code>--filter-secondary</code>: Filter secondary alignments</li> <li><code>--filter-supplementary</code>: Filter supplementary alignments</li> <li><code>--filter-qc-failed</code>: Filter reads that failed QC</li> <li><code>--filter-improper-pair</code>: Filter improperly paired reads</li> <li><code>--filter-indel</code>: Filter reads with indels in CIGAR</li> </ul>"},{"location":"CHANGELOG/#cli-usability","title":"CLI &amp; Usability","text":"<ul> <li>Modern CLI: Built with Typer and Rich for beautiful terminal output</li> <li>Progress Tracking: Real-time progress bars and status indicators</li> <li>Direct Invocation: Use <code>gbcms run</code> instead of <code>python -m gbcms.cli</code></li> <li>Output Customization: <code>--suffix</code> flag for output filename customization</li> <li>Flexible Input: Support for both VCF and MAF input formats</li> </ul>"},{"location":"CHANGELOG/#infrastructure","title":"Infrastructure","text":"<ul> <li>Docker Support: Production-ready multi-stage Dockerfile with optimized layers</li> <li>Type Safety: Full type annotations with mypy support</li> <li>Type Stubs: Provided <code>.pyi</code> stub file for Rust extension</li> <li>Comprehensive Tests: Extended test suite with accuracy and filter validation</li> <li>CI/CD: GitHub Actions workflows for testing, linting, and releases</li> </ul>"},{"location":"CHANGELOG/#changed_3","title":"\ud83d\udd04 Changed","text":""},{"location":"CHANGELOG/#architecture","title":"Architecture","text":"<ul> <li>Migrated from pure Python to hybrid Python/Rust architecture</li> <li>Core counting logic implemented in Rust using <code>rust-htslib</code></li> <li>Data parallelism over variants with per-thread BAM readers</li> </ul>"},{"location":"CHANGELOG/#output-formats","title":"Output Formats","text":"<ul> <li>VCF FORMAT fields: Strand-specific counts now use comma-separated values (e.g., <code>RD=5,3</code> for forward,reverse)</li> <li>MAF columns: Standardized column names (<code>t_ref_count_forward</code>, <code>t_alt_count_reverse</code>, etc.)</li> <li>Coordinate System: Internal 0-based indexing with correct conversion for VCF (1-based) and MAF output</li> </ul>"},{"location":"CHANGELOG/#performance","title":"Performance","text":"<ul> <li>Speed: 20x+ faster than v1.x on typical datasets</li> <li>Memory: Efficient per-thread BAM readers with minimal overhead</li> <li>Scalability: Configurable thread pool for optimal resource usage</li> </ul>"},{"location":"CHANGELOG/#dependencies","title":"Dependencies","text":"<ul> <li>Python: Updated to require Python \u22653.10</li> <li>Rust: pyo3 0.27.1, rust-htslib 0.51.0, statrs 0.18.0</li> <li>Python Packages: pysam \u22650.21.0, typer \u22650.9.0, rich \u226513.0.0, pydantic \u22652.0.0</li> </ul>"},{"location":"CHANGELOG/#removed","title":"\ud83d\uddd1\ufe0f Removed","text":"<ul> <li>Legacy Python Counting: Pure Python implementation removed in favor of Rust</li> <li>Old CLI: Deprecated <code>python -m gbcms.cli</code> entry point</li> <li>Unused Dependencies: Removed <code>cyvcf2</code> and <code>numba</code> (no longer needed)</li> <li>Pre-commit Hooks: Removed in favor of explicit linting in CI</li> </ul>"},{"location":"CHANGELOG/#fixed_3","title":"\ud83d\udc1b Fixed","text":"<ul> <li>Correct handling of complex variants (MNPs, DelIns)</li> <li>Proper strand assignment for fragment counting</li> <li>Reference validation against FASTA for all variant types</li> <li>Thread-safe BAM access with per-thread readers</li> </ul>"},{"location":"CHANGELOG/#documentation_3","title":"\ud83d\udcda Documentation","text":"<ul> <li>Complete rewrite of all documentation</li> <li>New guides: <code>INSTALLATION.md</code>, <code>CLI_FEATURES.md</code>, <code>INPUT_OUTPUT.md</code></li> <li>Comprehensive API documentation</li> <li>Docker usage examples</li> <li>Contributing guidelines updated</li> </ul>"},{"location":"CHANGELOG/#technical-details","title":"\ud83d\udd27 Technical Details","text":""},{"location":"CHANGELOG/#rust-components","title":"Rust Components","text":"<ul> <li><code>gbcms._rs</code>: PyO3-based Rust extension (bundled in wheel)</li> <li>Fisher's exact test via <code>statrs</code> crate</li> <li>Rayon-based parallelism with configurable thread pools</li> <li>Safe memory management with Rust's ownership model</li> </ul>"},{"location":"CHANGELOG/#testing","title":"Testing","text":"<ul> <li>16 comprehensive test cases</li> <li>Accuracy validation with synthetic BAM files</li> <li>Filter validation for all read flag combinations</li> <li>Integration tests with real-world data</li> </ul>"},{"location":"CHANGELOG/#breaking-changes","title":"\u26a0\ufe0f Breaking Changes","text":"<p>Version 2.0.0 is not backward compatible with 1.x. Key breaking changes:</p> <ol> <li>CLI syntax: Use <code>gbcms run</code> instead of <code>python -m gbcms.cli</code></li> <li>Output format: VCF/MAF column structures have changed</li> <li>Default behavior: Only duplicate filtering enabled by default (was: all filters)</li> <li>Dependencies: Requires Rust toolchain for installation from source</li> <li>Python version: Minimum Python 3.10 (was: 3.8)</li> </ol>"},{"location":"CHANGELOG/#installation","title":"\ud83d\udce6 Installation","text":"<pre><code># From PyPI (includes pre-built wheels)\npip install py-gbcms\n\n# From source (requires Rust)\npip install git+https://github.com/msk-access/py-gbcms.git\n\n# Docker\ndocker pull ghcr.io/msk-access/py-gbcms:2.0.0\n</code></pre>"},{"location":"CHANGELOG/#acknowledgments","title":"\ud83d\ude4f Acknowledgments","text":"<p>This rewrite was designed and implemented with a focus on correctness, performance, and modern best practices in bioinformatics software development.</p>"},{"location":"CHANGELOG/#1x-legacy","title":"[1.x] - Legacy","text":"<p>Previous versions (1.x) used a pure Python implementation. See git history for details.</p>"},{"location":"CONTRIBUTING/","title":"Contributing to GetBaseCounts","text":""},{"location":"CONTRIBUTING/#contributing-to-getbasecounts","title":"Contributing to GetBaseCounts","text":"<p>Thank you for your interest in contributing to GetBaseCounts! This document provides guidelines and instructions for contributing.</p>"},{"location":"CONTRIBUTING/#development-setup","title":"Development Setup","text":"<ol> <li> <p>Clone the repository </p><pre><code>git clone https://github.com/msk-access/py-gbcms.git\ncd py-gbcms\n</code></pre><p></p> </li> <li> <p>Install uv (if not already installed)    </p><pre><code>curl -LsSf https://astral.sh/uv/install.sh | sh\n</code></pre><p></p> </li> <li> <p>Install development dependencies </p><pre><code>uv pip install -e \".[dev]\"\n</code></pre><p></p> </li> </ol>"},{"location":"CONTRIBUTING/#development-workflow","title":"Development Workflow","text":""},{"location":"CONTRIBUTING/#running-tests","title":"Running Tests","text":"<pre><code># Run all tests\npytest\n\n# Run with coverage\npytest --cov=gbcms --cov-report=html\n\n# Run specific test file\npytest tests/test_counter.py\n\n# Run with verbose output\npytest -v\n</code></pre>"},{"location":"CONTRIBUTING/#code-quality","title":"Code Quality","text":"<pre><code># Format code\nblack src/ tests/\n\n# Lint code\nruff check src/ tests/\n\n# Fix linting issues automatically\nruff check --fix src/ tests/\n\n# Type checking\nmypy src/\n</code></pre>"},{"location":"CONTRIBUTING/#building-and-testing-docker","title":"Building and Testing Docker","text":"<pre><code># Build Docker image\ndocker build -t gbcms:latest .\n</code></pre>"},{"location":"CONTRIBUTING/#code-style","title":"Code Style","text":"<ul> <li>Follow PEP 8 style guidelines</li> <li>Use type hints for all function signatures</li> <li>Write docstrings for all public functions and classes</li> <li>Keep functions focused and single-purpose</li> <li>Maximum line length: 100 characters</li> </ul>"},{"location":"CONTRIBUTING/#testing-guidelines","title":"Testing Guidelines","text":"<ul> <li>Write tests for all new features</li> <li>Maintain or improve code coverage</li> <li>Use descriptive test names</li> <li>Use fixtures for common test setup</li> <li>Test edge cases and error conditions</li> </ul>"},{"location":"CONTRIBUTING/#pull-request-process","title":"Pull Request Process","text":"<ol> <li> <p>Create a feature branch </p><pre><code>git checkout -b feature/your-feature-name\n</code></pre><p></p> </li> <li> <p>Make your changes</p> </li> <li>Write code following the style guidelines</li> <li>Add tests for new functionality</li> <li> <p>Update documentation as needed</p> </li> <li> <p>Run tests and linters </p><pre><code>make test\nmake lint\n</code></pre><p></p> </li> <li> <p>Commit your changes </p><pre><code>git add .\ngit commit -m \"Description of your changes\"\n</code></pre><p></p> </li> <li> <p>Push to your fork </p><pre><code>git push origin feature/your-feature-name\n</code></pre><p></p> </li> <li> <p>Create a Pull Request</p> </li> <li>Provide a clear description of the changes</li> <li>Reference any related issues</li> <li>Ensure all CI checks pass</li> </ol>"},{"location":"CONTRIBUTING/#reporting-issues","title":"Reporting Issues","text":"<p>When reporting issues, please include:</p> <ul> <li>Python version</li> <li>Operating system</li> <li>Steps to reproduce</li> <li>Expected behavior</li> <li>Actual behavior</li> <li>Error messages or logs</li> </ul>"},{"location":"CONTRIBUTING/#feature-requests","title":"Feature Requests","text":"<p>We welcome feature requests! Please:</p> <ul> <li>Check if the feature already exists</li> <li>Provide a clear use case</li> <li>Describe the expected behavior</li> <li>Consider submitting a PR if you can implement it</li> </ul>"},{"location":"CONTRIBUTING/#code-of-conduct","title":"Code of Conduct","text":"<ul> <li>Be respectful and inclusive</li> <li>Welcome newcomers</li> <li>Focus on constructive feedback</li> <li>Help others learn and grow</li> </ul>"},{"location":"CONTRIBUTING/#questions","title":"Questions?","text":"<p>Feel free to open an issue for questions or reach out to the maintainers.</p> <p>Thank you for contributing!</p>"},{"location":"cli/","title":"Overview","text":""},{"location":"cli/#cli-reference","title":"CLI Reference","text":"<p>The <code>gbcms</code> command-line interface provides a single powerful command for variant counting.</p>"},{"location":"cli/#commands","title":"Commands","text":"Command Description run Count alleles at variant positions"},{"location":"cli/#quick-example","title":"Quick Example","text":"<pre><code>gbcms run \\\n    --variants mutations.maf \\\n    --bam sample1:sample1.bam \\\n    --bam sample2:sample2.bam \\\n    --fasta reference.fa \\\n    --output-dir results/\n</code></pre>"},{"location":"cli/#getting-help","title":"Getting Help","text":"<pre><code>gbcms --help\ngbcms run --help\n</code></pre>"},{"location":"cli/#related","title":"Related","text":"<ul> <li>Quick Start \u2014 Common usage patterns</li> <li>Nextflow Pipeline \u2014 For processing many samples</li> <li>Input Formats \u2014 VCF/MAF specifications</li> </ul>"},{"location":"cli/run/","title":"Run Command","text":""},{"location":"cli/run/#gbcms-run","title":"gbcms run","text":"<p>Count alleles at variant positions across one or more BAM files.</p>"},{"location":"cli/run/#synopsis","title":"Synopsis","text":"<pre><code>gbcms run [OPTIONS] --variants &lt;FILE&gt; --bam &lt;NAME:PATH&gt;... --fasta &lt;FILE&gt;\n</code></pre>"},{"location":"cli/run/#required-arguments","title":"Required Arguments","text":"Option Description <code>--variants</code> VCF or MAF file with variant positions <code>--bam</code> BAM file in <code>name:path</code> format (can repeat) <code>--fasta</code> Reference FASTA file (with .fai index)"},{"location":"cli/run/#output-options","title":"Output Options","text":"Option Default Description <code>--output-dir</code> <code>.</code> Output directory <code>--format</code> <code>vcf</code> Output format (<code>vcf</code> or <code>maf</code>) <code>--suffix</code> <code>''</code> Suffix for output filenames <code>--threads</code> <code>1</code> Number of threads"},{"location":"cli/run/#filtering-options","title":"Filtering Options","text":"Option Default Description <code>--min-mapq</code> <code>20</code> Minimum MAPQ <code>--min-baseq</code> <code>0</code> Minimum BASEQ <code>--filter-duplicates</code> <code>true</code> Filter duplicate reads <code>--filter-secondary</code> <code>false</code> Filter secondary alignments <code>--filter-supplementary</code> <code>false</code> Filter supplementary alignments <code>--filter-qc-failed</code> <code>false</code> Filter QC failed reads <code>--filter-improper-pair</code> <code>false</code> Filter improperly paired reads <code>--filter-indel</code> <code>false</code> Filter reads with indels"},{"location":"cli/run/#examples","title":"Examples","text":""},{"location":"cli/run/#single-bam","title":"Single BAM","text":"<pre><code>gbcms run \\\n    --variants mutations.vcf \\\n    --bam sample:sample.bam \\\n    --fasta reference.fa \\\n    --output-dir results/\n</code></pre>"},{"location":"cli/run/#multiple-bams","title":"Multiple BAMs","text":"<pre><code>gbcms run \\\n    --variants mutations.maf \\\n    --bam tumor:tumor.bam \\\n    --bam normal:normal.bam \\\n    --fasta reference.fa \\\n    --format maf\n</code></pre>"},{"location":"cli/run/#with-filtering","title":"With Filtering","text":"<pre><code>gbcms run \\\n    --variants mutations.vcf \\\n    --bam sample:sample.bam \\\n    --fasta reference.fa \\\n    --filter-duplicates \\\n    --min-mapq 30\n</code></pre>"},{"location":"cli/run/#output","title":"Output","text":"<p>The command produces a VCF or MAF file with:</p> <ul> <li>Allele counts (reference and alternate depth)</li> <li>VAF (variant allele frequency)</li> <li>Strand bias (Fisher's exact test)</li> <li>Fragment counts (deduplicated)</li> </ul>"},{"location":"cli/run/#related","title":"Related","text":"<ul> <li>Quick Start \u2014 Common patterns</li> <li>Nextflow Pipeline \u2014 For many samples</li> <li>Input Formats \u2014 VCF/MAF specs</li> <li>Variant Counting \u2014 How each variant type is counted</li> </ul>"},{"location":"development/changelog/","title":"Changelog","text":""},{"location":"development/changelog/#changelog","title":"Changelog","text":"<p>All notable changes to py-gbcms are documented here.</p> <p>Full History</p> <p>See GitHub Releases for complete release notes.</p>"},{"location":"development/changelog/#changelog_1","title":"Changelog","text":"<p>All notable changes to this project will be documented in this file.</p> <p>The format is based on Keep a Changelog, and this project adheres to Semantic Versioning.</p>"},{"location":"development/changelog/#230-2026-02-06","title":"[2.3.0] - 2026-02-06","text":""},{"location":"development/changelog/#added","title":"\u2728 Added","text":"<ul> <li>Nextflow BAI Auto-Discovery: Checks <code>.bam.bai</code> and <code>.bai</code> extensions automatically</li> <li>Documentation Modernization: Hierarchical navigation, glightbox, panzoom, abbreviations</li> <li>Performance Benchmarks: cfDNA duplex sample metrics in documentation</li> <li>RHEL 8 Installation Guide: Conda-based source installation for legacy Linux</li> </ul>"},{"location":"development/changelog/#changed","title":"\ud83d\udd04 Changed","text":"<ul> <li>Dockerfile: Added <code>procps</code>, <code>bash</code>, OCI labels, <code>maturin[patchelf]</code>, selective COPY</li> <li>Nextflow Config: <code>--platform linux/amd64</code>, shell config, local profile, observability (trace/report/timeline/dag)</li> <li>MkDocs: Switched to <code>navigation.sections</code>, 20+ abbreviations with hover tooltips</li> <li>GitHub Actions: Consolidated deploy-docs workflows, added caching and PR validation</li> <li>CI Wheels: Migrated from <code>manylinux_2_28</code> to <code>manylinux_2_34</code> (AlmaLinux 9 with OpenSSL 3.0+)</li> </ul>"},{"location":"development/changelog/#fixed","title":"\ud83d\udd27 Fixed","text":"<ul> <li>Nextflow: Empty <code>--suffix</code> argument no longer causes failures</li> <li>Admonitions: Converted GitHub-style alerts to MkDocs syntax</li> <li>CI Build: Resolved <code>curl-sys</code> OpenSSL version conflict by switching to manylinux_2_34</li> </ul>"},{"location":"development/changelog/#220-2026-02-04","title":"[2.2.0] - 2026-02-04","text":""},{"location":"development/changelog/#added_1","title":"\u2728 Added","text":"<ul> <li>Multi-platform Wheel Publishing: Maturin-based CI builds for Linux (x86_64, aarch64), macOS (Intel, Apple Silicon), and Windows</li> <li>Structured Logging: New <code>utils/logging.py</code> module with Rich console output, timing utilities, and log file support</li> <li>Mermaid Diagrams: Architecture documentation with interactive flowcharts</li> <li>Release Guide: Comprehensive <code>docs/RELEASE.md</code> with git-flow workflow</li> </ul>"},{"location":"development/changelog/#changed_1","title":"\ud83d\udd04 Changed","text":"<ul> <li>Folder Restructure: Moved Rust code to <code>rust/</code> (bundled as <code>gbcms._rs</code>)</li> <li>Config Hierarchy: Nested Pydantic models (<code>ReadFilters</code>, <code>QualityThresholds</code>, <code>OutputConfig</code>) for better organization</li> <li>Code Quality: Added <code>__all__</code> exports, docstrings, and type hints across all modules</li> <li>StrEnum: Modern enum pattern with Python 3.10 backport</li> </ul>"},{"location":"development/changelog/#documentation","title":"\ud83d\udcda Documentation","text":"<ul> <li>New <code>docs/ARCHITECTURE.md</code> with system diagrams</li> <li>New <code>docs/DEVELOPMENT.md</code> (developer guide)</li> <li>New <code>docs/TESTING.md</code> (testing guide)</li> <li>Updated MkDocs with mermaid2 plugin and snippet includes</li> </ul>"},{"location":"development/changelog/#212-2025-11-25","title":"[2.1.2] - 2025-11-25","text":""},{"location":"development/changelog/#fixed_1","title":"\ud83d\udd27 Fixed","text":"<ul> <li>PyPI Distribution: Fixed source distribution size issue by correctly excluding large files (tests, docs, etc.) via <code>pyproject.toml</code> configuration.</li> </ul>"},{"location":"development/changelog/#211-2025-11-25-yanked","title":"[2.1.1] - 2025-11-25 [YANKED]","text":"<p>Yanked Release</p> <p>This release was yanked from PyPI due to a source distribution size limit error. Use 2.1.2 instead.</p>"},{"location":"development/changelog/#fixed_2","title":"\ud83d\udd27 Fixed","text":"<ul> <li>PyPI Distribution: Added MANIFEST.in (failed to work with Hatchling) to reduce source distribution size</li> <li>Documentation: Added comprehensive Installation guide</li> <li>Documentation: Unified Contributing guide (merged code + docs contributions)</li> <li>Documentation: Added Changelog to documentation navigation</li> </ul>"},{"location":"development/changelog/#210-2025-11-25","title":"[2.1.0] - 2025-11-25","text":""},{"location":"development/changelog/#added_2","title":"\u2728 Added","text":""},{"location":"development/changelog/#nextflow-workflow","title":"Nextflow Workflow","text":"<ul> <li>Production-ready Nextflow workflow for processing multiple samples in parallel</li> <li>SLURM cluster support with customizable queue configuration</li> <li>Per-sample suffix support via optional <code>suffix</code> column in samplesheet</li> <li>Docker and Singularity profiles for containerized execution</li> <li>Automatic BAI index discovery with validation</li> <li>Resume capability for failed workflow runs</li> <li>Resource management with automatic retry and scaling</li> <li>Comprehensive documentation in <code>docs/NEXTFLOW.md</code> and <code>nextflow/README.md</code></li> </ul>"},{"location":"development/changelog/#documentation_1","title":"Documentation","text":"<ul> <li>Usage pattern comparison guide (<code>docs/WORKFLOWS.md</code>) for choosing between CLI and Nextflow</li> <li>MkDocs integration for beautiful GitHub Pages documentation</li> <li>Local documentation preview with live reload (<code>mkdocs serve</code>)</li> <li>Staging deployment from <code>develop</code> branch for testing docs</li> <li>Production deployment from <code>main</code> branch</li> <li>Reorganized documentation structure with clear CLI vs Nextflow separation</li> <li>CLI Quick Start guide (<code>docs/quick-start.md</code>)</li> </ul>"},{"location":"development/changelog/#changed_2","title":"\ud83d\udd27 Changed","text":"<ul> <li>Documentation workflow: docs now live on <code>main</code> branch with automated deployment</li> <li>GitBook integration: configured to read from <code>main</code> branch</li> <li>Nextflow module: improved parameter passing with meta.suffix support</li> </ul>"},{"location":"development/changelog/#documentation_2","title":"\ud83d\udcdd Documentation","text":"<ul> <li>Complete Nextflow workflow guide with SLURM examples</li> <li>Per-sample suffix usage examples</li> <li>Git-flow documentation workflow guide</li> <li>Local preview instructions</li> <li>Updated README with clear usage pattern separation</li> </ul>"},{"location":"development/changelog/#200-2025-11-21","title":"[2.0.0] - 2025-11-21","text":""},{"location":"development/changelog/#major-rewrite","title":"\ud83d\ude80 Major Rewrite","text":"<p>Version 2.0.0 represents a complete rewrite of py-gbcms with a focus on performance, correctness, and modern architecture.</p>"},{"location":"development/changelog/#added_3","title":"\u2728 Added","text":""},{"location":"development/changelog/#core-features","title":"Core Features","text":"<ul> <li>Rust-based Counting Engine: Hybrid Python/Rust architecture for 20x+ performance improvement</li> <li>Strand Bias Statistics: Fisher's exact test p-values and odds ratios for both reads (<code>SB_PVAL</code>, <code>SB_OR</code>) and fragments (<code>FSB_PVAL</code>, <code>FSB_OR</code>)</li> <li>Fragment-Level Counting: Majority-rule fragment counting with strand-specific counts (<code>RDF</code>, <code>ADF</code>)</li> <li>Variant Allele Fractions: Read-level (<code>VAF</code>) and fragment-level (<code>FAF</code>) allele fraction calculations</li> <li>Thread Control: Explicit control over parallelism via <code>--threads</code> argument (default: 1)</li> </ul>"},{"location":"development/changelog/#inputoutput","title":"Input/Output","text":"<ul> <li>VCF Output Format: Standard VCF with comprehensive INFO and FORMAT fields</li> <li>MAF Output Format: Extended MAF with custom columns for strand counts and statistics</li> <li>Column Preservation: Input MAF columns are preserved in output</li> <li>Multiple BAM Support: Process multiple samples via <code>--bam-list</code> or repeated <code>--bam</code> arguments</li> <li>Sample ID Override: Explicit sample naming via <code>--bam sample_id:path</code> syntax</li> </ul>"},{"location":"development/changelog/#filters","title":"Filters","text":"<ul> <li><code>--filter-duplicates</code>: Filter duplicate reads (default: enabled)</li> <li><code>--filter-secondary</code>: Filter secondary alignments</li> <li><code>--filter-supplementary</code>: Filter supplementary alignments</li> <li><code>--filter-qc-failed</code>: Filter reads that failed QC</li> <li><code>--filter-improper-pair</code>: Filter improperly paired reads</li> <li><code>--filter-indel</code>: Filter reads with indels in CIGAR</li> </ul>"},{"location":"development/changelog/#cli-usability","title":"CLI &amp; Usability","text":"<ul> <li>Modern CLI: Built with Typer and Rich for beautiful terminal output</li> <li>Progress Tracking: Real-time progress bars and status indicators</li> <li>Direct Invocation: Use <code>gbcms run</code> instead of <code>python -m gbcms.cli</code></li> <li>Output Customization: <code>--suffix</code> flag for output filename customization</li> <li>Flexible Input: Support for both VCF and MAF input formats</li> </ul>"},{"location":"development/changelog/#infrastructure","title":"Infrastructure","text":"<ul> <li>Docker Support: Production-ready multi-stage Dockerfile with optimized layers</li> <li>Type Safety: Full type annotations with mypy support</li> <li>Type Stubs: Provided <code>.pyi</code> stub file for Rust extension</li> <li>Comprehensive Tests: Extended test suite with accuracy and filter validation</li> <li>CI/CD: GitHub Actions workflows for testing, linting, and releases</li> </ul>"},{"location":"development/changelog/#changed_3","title":"\ud83d\udd04 Changed","text":""},{"location":"development/changelog/#architecture","title":"Architecture","text":"<ul> <li>Migrated from pure Python to hybrid Python/Rust architecture</li> <li>Core counting logic implemented in Rust using <code>rust-htslib</code></li> <li>Data parallelism over variants with per-thread BAM readers</li> </ul>"},{"location":"development/changelog/#output-formats","title":"Output Formats","text":"<ul> <li>VCF FORMAT fields: Strand-specific counts now use comma-separated values (e.g., <code>RD=5,3</code> for forward,reverse)</li> <li>MAF columns: Standardized column names (<code>t_ref_count_forward</code>, <code>t_alt_count_reverse</code>, etc.)</li> <li>Coordinate System: Internal 0-based indexing with correct conversion for VCF (1-based) and MAF output</li> </ul>"},{"location":"development/changelog/#performance","title":"Performance","text":"<ul> <li>Speed: 20x+ faster than v1.x on typical datasets</li> <li>Memory: Efficient per-thread BAM readers with minimal overhead</li> <li>Scalability: Configurable thread pool for optimal resource usage</li> </ul>"},{"location":"development/changelog/#dependencies","title":"Dependencies","text":"<ul> <li>Python: Updated to require Python \u22653.10</li> <li>Rust: pyo3 0.27.1, rust-htslib 0.51.0, statrs 0.18.0</li> <li>Python Packages: pysam \u22650.21.0, typer \u22650.9.0, rich \u226513.0.0, pydantic \u22652.0.0</li> </ul>"},{"location":"development/changelog/#removed","title":"\ud83d\uddd1\ufe0f Removed","text":"<ul> <li>Legacy Python Counting: Pure Python implementation removed in favor of Rust</li> <li>Old CLI: Deprecated <code>python -m gbcms.cli</code> entry point</li> <li>Unused Dependencies: Removed <code>cyvcf2</code> and <code>numba</code> (no longer needed)</li> <li>Pre-commit Hooks: Removed in favor of explicit linting in CI</li> </ul>"},{"location":"development/changelog/#fixed_3","title":"\ud83d\udc1b Fixed","text":"<ul> <li>Correct handling of complex variants (MNPs, DelIns)</li> <li>Proper strand assignment for fragment counting</li> <li>Reference validation against FASTA for all variant types</li> <li>Thread-safe BAM access with per-thread readers</li> </ul>"},{"location":"development/changelog/#documentation_3","title":"\ud83d\udcda Documentation","text":"<ul> <li>Complete rewrite of all documentation</li> <li>New guides: <code>INSTALLATION.md</code>, <code>CLI_FEATURES.md</code>, <code>INPUT_OUTPUT.md</code></li> <li>Comprehensive API documentation</li> <li>Docker usage examples</li> <li>Contributing guidelines updated</li> </ul>"},{"location":"development/changelog/#technical-details","title":"\ud83d\udd27 Technical Details","text":""},{"location":"development/changelog/#rust-components","title":"Rust Components","text":"<ul> <li><code>gbcms._rs</code>: PyO3-based Rust extension (bundled in wheel)</li> <li>Fisher's exact test via <code>statrs</code> crate</li> <li>Rayon-based parallelism with configurable thread pools</li> <li>Safe memory management with Rust's ownership model</li> </ul>"},{"location":"development/changelog/#testing","title":"Testing","text":"<ul> <li>16 comprehensive test cases</li> <li>Accuracy validation with synthetic BAM files</li> <li>Filter validation for all read flag combinations</li> <li>Integration tests with real-world data</li> </ul>"},{"location":"development/changelog/#breaking-changes","title":"\u26a0\ufe0f Breaking Changes","text":"<p>Version 2.0.0 is not backward compatible with 1.x. Key breaking changes:</p> <ol> <li>CLI syntax: Use <code>gbcms run</code> instead of <code>python -m gbcms.cli</code></li> <li>Output format: VCF/MAF column structures have changed</li> <li>Default behavior: Only duplicate filtering enabled by default (was: all filters)</li> <li>Dependencies: Requires Rust toolchain for installation from source</li> <li>Python version: Minimum Python 3.10 (was: 3.8)</li> </ol>"},{"location":"development/changelog/#installation","title":"\ud83d\udce6 Installation","text":"<pre><code># From PyPI (includes pre-built wheels)\npip install py-gbcms\n\n# From source (requires Rust)\npip install git+https://github.com/msk-access/py-gbcms.git\n\n# Docker\ndocker pull ghcr.io/msk-access/py-gbcms:2.0.0\n</code></pre>"},{"location":"development/changelog/#acknowledgments","title":"\ud83d\ude4f Acknowledgments","text":"<p>This rewrite was designed and implemented with a focus on correctness, performance, and modern best practices in bioinformatics software development.</p>"},{"location":"development/changelog/#1x-legacy","title":"[1.x] - Legacy","text":"<p>Previous versions (1.x) used a pure Python implementation. See git history for details.</p>"},{"location":"development/contributing/","title":"Contributing","text":""},{"location":"development/contributing/#contributing","title":"Contributing","text":"<p>Thank you for your interest in contributing to py-gbcms!</p> <p>Full Guide</p> <p>See the main contributing guide for complete details.</p>"},{"location":"development/contributing/#contributing-to-getbasecounts","title":"Contributing to GetBaseCounts","text":"<p>Thank you for your interest in contributing to GetBaseCounts! This document provides guidelines and instructions for contributing.</p>"},{"location":"development/contributing/#development-setup","title":"Development Setup","text":"<ol> <li> <p>Clone the repository </p><pre><code>git clone https://github.com/msk-access/py-gbcms.git\ncd py-gbcms\n</code></pre><p></p> </li> <li> <p>Install uv (if not already installed)    </p><pre><code>curl -LsSf https://astral.sh/uv/install.sh | sh\n</code></pre><p></p> </li> <li> <p>Install development dependencies </p><pre><code>uv pip install -e \".[dev]\"\n</code></pre><p></p> </li> </ol>"},{"location":"development/contributing/#development-workflow","title":"Development Workflow","text":""},{"location":"development/contributing/#running-tests","title":"Running Tests","text":"<pre><code># Run all tests\npytest\n\n# Run with coverage\npytest --cov=gbcms --cov-report=html\n\n# Run specific test file\npytest tests/test_counter.py\n\n# Run with verbose output\npytest -v\n</code></pre>"},{"location":"development/contributing/#code-quality","title":"Code Quality","text":"<pre><code># Format code\nblack src/ tests/\n\n# Lint code\nruff check src/ tests/\n\n# Fix linting issues automatically\nruff check --fix src/ tests/\n\n# Type checking\nmypy src/\n</code></pre>"},{"location":"development/contributing/#building-and-testing-docker","title":"Building and Testing Docker","text":"<pre><code># Build Docker image\ndocker build -t gbcms:latest .\n</code></pre>"},{"location":"development/contributing/#code-style","title":"Code Style","text":"<ul> <li>Follow PEP 8 style guidelines</li> <li>Use type hints for all function signatures</li> <li>Write docstrings for all public functions and classes</li> <li>Keep functions focused and single-purpose</li> <li>Maximum line length: 100 characters</li> </ul>"},{"location":"development/contributing/#testing-guidelines","title":"Testing Guidelines","text":"<ul> <li>Write tests for all new features</li> <li>Maintain or improve code coverage</li> <li>Use descriptive test names</li> <li>Use fixtures for common test setup</li> <li>Test edge cases and error conditions</li> </ul>"},{"location":"development/contributing/#pull-request-process","title":"Pull Request Process","text":"<ol> <li> <p>Create a feature branch </p><pre><code>git checkout -b feature/your-feature-name\n</code></pre><p></p> </li> <li> <p>Make your changes</p> </li> <li>Write code following the style guidelines</li> <li>Add tests for new functionality</li> <li> <p>Update documentation as needed</p> </li> <li> <p>Run tests and linters </p><pre><code>make test\nmake lint\n</code></pre><p></p> </li> <li> <p>Commit your changes </p><pre><code>git add .\ngit commit -m \"Description of your changes\"\n</code></pre><p></p> </li> <li> <p>Push to your fork </p><pre><code>git push origin feature/your-feature-name\n</code></pre><p></p> </li> <li> <p>Create a Pull Request</p> </li> <li>Provide a clear description of the changes</li> <li>Reference any related issues</li> <li>Ensure all CI checks pass</li> </ol>"},{"location":"development/contributing/#reporting-issues","title":"Reporting Issues","text":"<p>When reporting issues, please include:</p> <ul> <li>Python version</li> <li>Operating system</li> <li>Steps to reproduce</li> <li>Expected behavior</li> <li>Actual behavior</li> <li>Error messages or logs</li> </ul>"},{"location":"development/contributing/#feature-requests","title":"Feature Requests","text":"<p>We welcome feature requests! Please:</p> <ul> <li>Check if the feature already exists</li> <li>Provide a clear use case</li> <li>Describe the expected behavior</li> <li>Consider submitting a PR if you can implement it</li> </ul>"},{"location":"development/contributing/#code-of-conduct","title":"Code of Conduct","text":"<ul> <li>Be respectful and inclusive</li> <li>Welcome newcomers</li> <li>Focus on constructive feedback</li> <li>Help others learn and grow</li> </ul>"},{"location":"development/contributing/#questions","title":"Questions?","text":"<p>Feel free to open an issue for questions or reach out to the maintainers.</p> <p>Thank you for contributing!</p>"},{"location":"development/developer-guide/","title":"Developer Guide","text":""},{"location":"development/developer-guide/#developer-guide","title":"Developer Guide","text":"<p>Guide for contributing to py-gbcms.</p>"},{"location":"development/developer-guide/#setup","title":"Setup","text":"Modern Linux (Ubuntu 22.04+, RHEL 9+)Legacy Linux (RHEL 8 / HPC)macOS <pre><code># Clone\ngit clone https://github.com/msk-access/py-gbcms.git\ncd py-gbcms\n\n# Virtual environment\npython -m venv .venv\nsource .venv/bin/activate\n\n# Install Rust (if not installed)\ncurl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh\n\n# Install (builds Rust extension)\nmaturin develop --release\n\n# Verify\ngbcms --version\n</code></pre> <pre><code># Clone\ngit clone https://github.com/msk-access/py-gbcms.git\ncd py-gbcms\n\n# Create conda environment with build dependencies\n# Note: clangdev (not clang) provides headers needed by bindgen\nconda create -n gbcms-dev python=3.11 clangdev rust -c conda-forge\nconda activate gbcms-dev\n\n# Set libclang path for the Rust build\nexport LIBCLANG_PATH=$CONDA_PREFIX/lib\n\n# Install maturin and build\npip install maturin\nmaturin develop --release\n\n# Verify\ngbcms --version\n</code></pre> <pre><code># Clone\ngit clone https://github.com/msk-access/py-gbcms.git\ncd py-gbcms\n\n# Install Rust (if not installed)\ncurl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh\n\n# Virtual environment\npython -m venv .venv\nsource .venv/bin/activate\n\n# Install (builds Rust extension)\nmaturin develop --release\n\n# Verify\ngbcms --version\n</code></pre>"},{"location":"development/developer-guide/#project-structure","title":"Project Structure","text":"<pre><code>flowchart LR\n    subgraph Python[\"src/gbcms/\"]\n        CLI[cli.py] --&gt; Pipeline[pipeline.py]\n        Pipeline --&gt; IO[io/]\n        Pipeline --&gt; Models[models/]\n    end\n\n    subgraph Rust[\"rust/src/\"]\n        Lib[lib.rs] --&gt; Count[counting.rs]\n        Count --&gt; Stats[stats.rs]\n    end\n\n    Pipeline --&gt; Rust\n</code></pre>  Use mouse to pan and zoom"},{"location":"development/developer-guide/#build-commands","title":"Build Commands","text":"<pre><code># Development (fast)\nmaturin develop\n\n# Release (optimized)\nmaturin develop --release\n\n# Build wheel\nmaturin build --release --out dist\n</code></pre>"},{"location":"development/developer-guide/#code-standards","title":"Code Standards","text":""},{"location":"development/developer-guide/#python","title":"Python","text":"Standard Requirement Type hints All public functions Docstrings Google style Exports <code>__all__</code> in every module Logging Use <code>logging</code>, not <code>print()</code> Config Pydantic models"},{"location":"development/developer-guide/#rust","title":"Rust","text":"Standard Requirement Docs <code>///</code> on public items Errors <code>anyhow::Result</code> Logging <code>log</code> crate"},{"location":"development/developer-guide/#git-workflow-git-flow","title":"Git Workflow (git-flow)","text":"<pre><code>gitGraph\n    commit id: \"main\"\n    branch develop\n    commit id: \"develop\"\n    branch feature/new-thing\n    commit id: \"work\"\n    checkout develop\n    merge feature/new-thing\n    branch release/2.3.0\n    commit id: \"bump\"\n    checkout main\n    merge release/2.3.0 tag: \"2.3.0\"\n    checkout develop\n    merge release/2.3.0\n</code></pre>  Use mouse to pan and zoom  Branch Purpose <code>main</code> Production releases <code>develop</code> Integration <code>feature/*</code> New features <code>release/*</code> Release candidates <code>hotfix/*</code> Production fixes"},{"location":"development/developer-guide/#quality-checklist","title":"Quality Checklist","text":"<p>Before committing:</p> <ul> <li> <code>make lint</code> passes</li> <li> <code>pytest</code> passes</li> <li> Type hints complete</li> <li> Docstrings added</li> <li> No dead code</li> </ul>"},{"location":"development/developer-guide/#environment-variables","title":"Environment Variables","text":"Variable Default Description <code>GBCMS_LOG_LEVEL</code> INFO Logging level <code>RUST_LOG</code> \u2014 Rust logging <pre><code>GBCMS_LOG_LEVEL=DEBUG RUST_LOG=debug gbcms run ...\n</code></pre>"},{"location":"development/release-guide/","title":"Release Guide","text":""},{"location":"development/release-guide/#release-guide","title":"Release Guide","text":"<p>This guide documents the complete release process for py-gbcms using git-flow workflow.</p>"},{"location":"development/release-guide/#pre-release-checklist","title":"Pre-Release Checklist","text":"<p>Before starting a release, ensure:</p> <ul> <li> All CI checks pass on <code>develop</code></li> <li> All features for the release are merged to <code>develop</code></li> <li> No blocking issues in milestone</li> </ul>"},{"location":"development/release-guide/#version-locations","title":"Version Locations","text":"<p>All these files must be updated with the new version:</p> File Location Format <code>pyproject.toml</code> Line 3 <code>version = \"X.Y.Z\"</code> <code>src/gbcms/__init__.py</code> Line 11 <code>__version__ = \"X.Y.Z\"</code> <code>rust/Cargo.toml</code> Line 3 <code>version = \"X.Y.Z\"</code> <code>nextflow/modules/local/gbcms/run/main.nf</code> Line 7 <code>container \"ghcr.io/msk-access/py-gbcms:X.Y.Z\"</code> <code>CHANGELOG.md</code> Top section <code>## [X.Y.Z] - YYYY-MM-DD</code>"},{"location":"development/release-guide/#release-workflow","title":"Release Workflow","text":"<pre><code>flowchart LR\n    develop --&gt;|1. Create release branch| release/X.Y.Z\n    release/X.Y.Z --&gt;|2. Update versions| release/X.Y.Z\n    release/X.Y.Z --&gt;|3. PR to main| main\n    main --&gt;|4. Tag triggers CI| CI\n    CI --&gt; PyPI\n    CI --&gt; Docker/GHCR\n    CI --&gt; gh-pages\n    main --&gt;|5. Merge back| develop\n</code></pre>  Use mouse to pan and zoom"},{"location":"development/release-guide/#step-by-step-instructions","title":"Step-by-Step Instructions","text":""},{"location":"development/release-guide/#1-create-release-branch","title":"1. Create Release Branch","text":"<pre><code># From develop\ngit checkout develop\ngit pull origin develop\n\n# Create release branch\ngit checkout -b release/X.Y.Z\n</code></pre>"},{"location":"development/release-guide/#2-update-version-numbers","title":"2. Update Version Numbers","text":"<p>Update all version locations listed above. Use this command to verify:</p> <pre><code># Check current versions\ngrep -E \"^version|^__version__\" pyproject.toml src/gbcms/__init__.py rust/Cargo.toml\ngrep \"container\" nextflow/modules/local/gbcms/run/main.nf\n</code></pre>"},{"location":"development/release-guide/#3-update-changelogmd","title":"3. Update CHANGELOG.md","text":"<p>Add new section at top:</p> <pre><code>## [X.Y.Z] - YYYY-MM-DD\n\n### \u2728 Added\n- New feature description\n\n### \ud83d\udd27 Fixed\n- Bug fix description\n\n### \ud83d\udd04 Changed\n- Changes description\n</code></pre>"},{"location":"development/release-guide/#4-run-pre-release-checks","title":"4. Run Pre-Release Checks","text":"<pre><code># Lint\nmake lint\n\n# Format\nmake format\n\n# Tests\nmake test\n\n# Local build test\nmake docker-build\n</code></pre>"},{"location":"development/release-guide/#5-commit-and-push","title":"5. Commit and Push","text":"<pre><code>git add -A\ngit commit -m \"chore: bump version to X.Y.Z\"\ngit push origin release/X.Y.Z\n</code></pre>"},{"location":"development/release-guide/#6-create-pr-releasexyz-main","title":"6. Create PR: release/X.Y.Z \u2192 main","text":"<ul> <li>Title: <code>Release X.Y.Z</code></li> <li>Describe changes from CHANGELOG</li> <li>Wait for CI to pass</li> </ul>"},{"location":"development/release-guide/#7-merge-to-main-creates-tag","title":"7. Merge to main (creates tag)","text":"<p>After PR approval: - Squash and merge to <code>main</code> - Create tag: <code>git tag X.Y.Z &amp;&amp; git push origin X.Y.Z</code></p>"},{"location":"development/release-guide/#8-ci-release-pipeline","title":"8. CI Release Pipeline","text":"<p>The tag triggers <code>.github/workflows/release.yml</code>:</p> <ol> <li>Build wheels (Linux x86_64, aarch64; macOS x86_64, arm64; Windows)</li> <li>Publish to PyPI (via maturin)</li> <li>Build Docker image \u2192 push to <code>ghcr.io/msk-access/py-gbcms:X.Y.Z</code></li> <li>Deploy docs \u2192 GitHub Pages (versioned via <code>mike</code> as <code>X.Y.Z</code> / <code>stable</code>)</li> </ol>"},{"location":"development/release-guide/#9-merge-main-back-to-develop","title":"9. Merge main back to develop","text":"<pre><code>git checkout develop\ngit pull origin develop\ngit merge main\ngit push origin develop\n</code></pre>"},{"location":"development/release-guide/#10-cleanup","title":"10. Cleanup","text":"<pre><code># Delete local release branch\ngit branch -d release/X.Y.Z\n\n# Delete remote release branch (optional)\ngit push origin --delete release/X.Y.Z\n</code></pre>"},{"location":"development/release-guide/#hotfix-workflow","title":"Hotfix Workflow","text":"<p>For critical production fixes:</p> <pre><code># Create hotfix from main\ngit checkout main\ngit checkout -b hotfix/X.Y.Z\n\n# Fix, commit, push\ngit add -A\ngit commit -m \"fix: critical issue description\"\ngit push origin hotfix/X.Y.Z\n\n# PR to main, then merge back to develop\n</code></pre>"},{"location":"development/release-guide/#automation-scripts","title":"Automation Scripts","text":""},{"location":"development/release-guide/#git-flow-helpersh","title":"git-flow-helper.sh","text":"<p>Interactive helper for git-flow operations:</p> <pre><code>./git-flow-helper.sh\n# Options:\n# 1) Create feature branch\n# 2) Create release branch\n# 3) Show git status\n# 4) Cleanup merged branches\n</code></pre>"},{"location":"development/release-guide/#makefile-targets","title":"Makefile Targets","text":"Target Description <code>make lint</code> Run ruff and mypy <code>make format</code> Run black and ruff --fix <code>make test</code> Run pytest <code>make test-cov</code> Run tests with coverage <code>make docker-build</code> Build Docker image locally"},{"location":"development/release-guide/#ci-workflows","title":"CI Workflows","text":"Workflow Trigger Purpose <code>test.yml</code> Push to develop/main, PR Run tests <code>release.yml</code> Tag push <code>X.Y.Z</code> Build wheels, publish PyPI, Docker <code>deploy-docs.yml</code> Push to main or develop (docs/) Deploy versioned docs via <code>mike</code> (<code>stable</code> from main, <code>dev</code> from develop)"},{"location":"development/release-guide/#troubleshooting","title":"Troubleshooting","text":""},{"location":"development/release-guide/#pypi-upload-fails","title":"PyPI Upload Fails","text":"<ul> <li>Check if version already exists on PyPI (versions cannot be overwritten)</li> <li>Verify <code>PYPI_TOKEN</code> secret is set in GitHub repository</li> </ul>"},{"location":"development/release-guide/#docker-build-fails","title":"Docker Build Fails","text":"<ul> <li>Check <code>Dockerfile</code> paths match the new folder structure</li> <li>Verify rust/Cargo.toml version matches</li> </ul>"},{"location":"development/release-guide/#docs-build-fails","title":"Docs Build Fails","text":"<ul> <li>Verify <code>mkdocs-mermaid2-plugin</code> is installed in workflow</li> <li>Check snippet paths are correct (relative to root)</li> </ul>"},{"location":"development/testing-guide/","title":"Testing Guide","text":""},{"location":"development/testing-guide/#testing-guide","title":"Testing Guide","text":"<p>This guide covers running tests, adding new tests, and accuracy validation for py-gbcms.</p>"},{"location":"development/testing-guide/#running-tests","title":"Running Tests","text":""},{"location":"development/testing-guide/#quick-test","title":"Quick Test","text":"<pre><code># Run all tests\npytest -v\n\n# Run with coverage\npytest --cov=gbcms --cov-report=html\n\n# Run specific test file\npytest tests/test_accuracy.py -v\n</code></pre>"},{"location":"development/testing-guide/#test-categories","title":"Test Categories","text":"Category Files Purpose Accuracy <code>test_accuracy.py</code> SNP, indel, complex variant counting CLI <code>test_cli_sample_id.py</code> Command-line parsing Filters <code>test_filters.py</code> Read filtering logic MAF <code>test_maf_*.py</code> MAF column preservation Pipeline <code>test_pipeline_v2.py</code> End-to-end workflow Strand <code>test_strand_counts.py</code> Strand-specific counts"},{"location":"development/testing-guide/#test-structure","title":"Test Structure","text":"<pre><code>tests/\n\u251c\u2500\u2500 test_accuracy.py        # Variant type accuracy\n\u251c\u2500\u2500 test_cli_sample_id.py   # CLI argument parsing\n\u251c\u2500\u2500 test_filters.py         # Read filtering\n\u251c\u2500\u2500 test_maf_preservation.py\n\u251c\u2500\u2500 test_maf_reader.py\n\u251c\u2500\u2500 test_pipeline_v2.py\n\u2514\u2500\u2500 test_strand_counts.py\n</code></pre>"},{"location":"development/testing-guide/#writing-tests","title":"Writing Tests","text":""},{"location":"development/testing-guide/#basic-test-template","title":"Basic Test Template","text":"<pre><code>import pytest\nfrom pathlib import Path\n\ndef test_my_feature(tmp_path):\n    \"\"\"Test description.\"\"\"\n    # Arrange\n    input_file = tmp_path / \"input.txt\"\n    input_file.write_text(\"test data\")\n\n    # Act\n    result = my_function(input_file)\n\n    # Assert\n    assert result.success\n    assert result.count == 42\n</code></pre>"},{"location":"development/testing-guide/#accuracy-test-template","title":"Accuracy Test Template","text":"<pre><code>def test_snp_accuracy():\n    \"\"\"Verify SNP counting against known BAM.\"\"\"\n    # Create variant\n    variant = Variant(\"chr1\", 100, \"A\", \"T\", \"SNP\")\n\n    # Run counting\n    results = count_bam(bam_path, [variant], fasta_path)\n\n    # Validate\n    assert results[0].ref_count == 50\n    assert results[0].alt_count == 10\n</code></pre>"},{"location":"development/testing-guide/#manual-validation","title":"Manual Validation","text":""},{"location":"development/testing-guide/#using-samtools-for-spot-check","title":"Using samtools for Spot-Check","text":"<pre><code># Check counts at specific position\nsamtools mpileup -r chr1:100-100 -q 20 \\\n    -f ref.fa sample.bam 2&gt;/dev/null | \\\n    awk '{print \"DP=\"$4}'\n</code></pre>"},{"location":"development/testing-guide/#comparing-with-gbcms-output","title":"Comparing with gbcms Output","text":"<pre><code># Run gbcms\ngbcms run -v variants.maf -b sample.bam -f ref.fa -o output/\n\n# Check output\nawk -F'\\t' 'NR==2 {print \"REF=\"$41, \"ALT=\"$42}' output/*.maf\n</code></pre>"},{"location":"development/testing-guide/#accuracy-validation","title":"Accuracy Validation","text":""},{"location":"development/testing-guide/#variant-types-tested","title":"Variant Types Tested","text":"Type Test Status SNP <code>test_snp_accuracy</code> \u2705 Insertion <code>test_insertion_accuracy</code> \u2705 Deletion <code>test_deletion_accuracy</code> \u2705 Complex <code>test_complex_accuracy</code> \u2705 MNP <code>test_mnp_accuracy</code> \u2705"},{"location":"development/testing-guide/#real-world-validation","title":"Real-World Validation","text":"<pre><code># Compare gbcms vs samtools for a SNP\n# Position: chr1:11168293 G&gt;A\n\n# gbcms output\nawk -F'\\t' '$5==\"1\" &amp;&amp; $6==\"11168293\" {print \"REF=\"$41, \"ALT=\"$42}' output.maf\n\n# samtools output\nsamtools mpileup -r 1:11168293-11168293 -q 20 -f ref.fa sample.bam | \\\n    awk '{gsub(/\\^.|\\$/,\"\",$5); print \"DP=\"$4, \"Pileup=\"$5}'\n</code></pre>"},{"location":"development/testing-guide/#coverage-targets","title":"Coverage Targets","text":"Module Target Current cli.py 80% 79% pipeline.py 70% 29% io/input.py 85% 82% io/output.py 90% 96% models/core.py 90% 90% <p>Run coverage report:</p> <pre><code>pytest --cov=gbcms --cov-report=html\nopen htmlcov/index.html\n</code></pre>"},{"location":"getting-started/","title":"Overview","text":""},{"location":"getting-started/#getting-started","title":"Getting Started","text":"<p>Welcome to py-gbcms! This section will help you get up and running quickly.</p>"},{"location":"getting-started/#what-youll-learn","title":"What You'll Learn","text":"<ul> <li>Installation \u2014 Install via PyPI, Docker, or from source</li> <li>Quick Start \u2014 Run your first variant counting job</li> </ul>"},{"location":"getting-started/#prerequisites","title":"Prerequisites","text":"<ul> <li>Python 3.9+</li> <li>BAM file(s) with index (.bai)</li> <li>Reference FASTA with index (.fai)</li> <li>VCF or MAF file with variant positions</li> </ul>"},{"location":"getting-started/#next-steps","title":"Next Steps","text":"<p>Once installed, try the Quick Start guide to run your first job.</p> <p>For processing many samples in parallel, see the Nextflow Pipeline.</p>"},{"location":"getting-started/installation/","title":"Installation","text":""},{"location":"getting-started/installation/#installation","title":"Installation","text":""},{"location":"getting-started/installation/#quick-install","title":"Quick Install","text":"PyPI (Recommended)DockerFrom Source <pre><code>pip install py-gbcms\ngbcms --version\n</code></pre> <p>System Requirements</p> <p>PyPI wheels require glibc 2.34+ (Ubuntu 22.04+, RHEL 9+, Debian 12+). For older systems, see Legacy Linux.</p> <pre><code>docker pull ghcr.io/msk-access/py-gbcms:2.3.0\ndocker run --rm ghcr.io/msk-access/py-gbcms:2.3.0 gbcms --help\n</code></pre> <pre><code>git clone https://github.com/msk-access/py-gbcms.git\ncd py-gbcms\npip install -e \".[dev]\"\n</code></pre>"},{"location":"getting-started/installation/#requirements","title":"Requirements","text":"Component Requirement Python 3.10+ OS Linux (glibc 2.34+), macOS, Windows (WSL2) Memory 4GB+ (8GB for large BAMs)"},{"location":"getting-started/installation/#for-nextflow-workflow","title":"For Nextflow Workflow","text":"<ul> <li>Nextflow 21.10.3+</li> <li>Docker or Singularity</li> </ul>"},{"location":"getting-started/installation/#legacy-linux-rhel-8-hpc","title":"Legacy Linux (RHEL 8 / HPC)","text":"<p>For RHEL 8, CentOS 8, or HPC systems with glibc &lt; 2.34:</p> Conda + Source (Recommended)Singularity (HPC)Docker <pre><code># Create conda environment with build dependencies\n# Note: clangdev (not clang) provides headers needed by bindgen\nconda create -n gbcms python=3.11 clangdev rust -c conda-forge\nconda activate gbcms\n\n# Set libclang path for the Rust build\nexport LIBCLANG_PATH=$CONDA_PREFIX/lib\n\n# Install from source\ngit clone https://github.com/msk-access/py-gbcms.git\ncd py-gbcms\npip install .\n</code></pre> <pre><code>singularity pull docker://ghcr.io/msk-access/py-gbcms:2.3.0\nsingularity exec py-gbcms_2.3.0.sif gbcms --help\n\n# With data binding\nsingularity exec -B /path/to/data:/data py-gbcms_2.3.0.sif gbcms run \\\n  --variants /data/variants.vcf --bam /data/sample.bam \\\n  --fasta /data/ref.fa --output-dir /data/results/\n</code></pre> <pre><code>docker pull ghcr.io/msk-access/py-gbcms:2.3.0\ndocker run --rm -v $(pwd):/data ghcr.io/msk-access/py-gbcms:2.3.0 gbcms --help\n</code></pre> <p>Why not pip install?</p> <p>PyPI wheels require glibc 2.34+. On RHEL 8 (glibc 2.28), pip falls back to  source compilation which requires Rust and clang headers. The conda environment provides these dependencies.</p>"},{"location":"getting-started/installation/#verification","title":"Verification","text":"<pre><code># Check installation\ngbcms --version\n# Expected: 2.3.0\n\n# Test help\ngbcms --help\n</code></pre>"},{"location":"getting-started/installation/#docker-usage","title":"Docker Usage","text":"<pre><code>docker run --rm \\\n  -v $(pwd):/data \\\n  ghcr.io/msk-access/py-gbcms:2.3.0 \\\n  gbcms run \\\n    --variants /data/variants.vcf \\\n    --bam /data/sample.bam \\\n    --fasta /data/reference.fa \\\n    --output-dir /data/results/\n</code></pre> <p>Docker Volume</p> <p>Use <code>-v</code> to mount your data directory.</p>"},{"location":"getting-started/installation/#troubleshooting","title":"Troubleshooting","text":""},{"location":"getting-started/installation/#module-not-found","title":"Module Not Found","text":"<pre><code>pip uninstall py-gbcms &amp;&amp; pip install py-gbcms\n</code></pre>"},{"location":"getting-started/installation/#bam-index-missing","title":"BAM Index Missing","text":"<pre><code>samtools index sample.bam\n</code></pre>"},{"location":"getting-started/installation/#docker-permission-denied","title":"Docker Permission Denied","text":"<pre><code>sudo usermod -aG docker $USER &amp;&amp; newgrp docker\n</code></pre>"},{"location":"getting-started/installation/#glibc-version-error","title":"glibc Version Error","text":"<p>If you see <code>GLIBC_2.34 not found</code>, use the Legacy Linux instructions.</p>"},{"location":"getting-started/installation/#upgrade","title":"Upgrade","text":"<pre><code>pip install --upgrade py-gbcms\n</code></pre>"},{"location":"getting-started/installation/#next-steps","title":"Next Steps","text":"<ul> <li>CLI Quick Start \u2014 Command examples</li> <li>Nextflow Guide \u2014 HPC pipeline</li> </ul>"},{"location":"getting-started/quickstart/","title":"Quick Start","text":""},{"location":"getting-started/quickstart/#cli-quick-start","title":"CLI Quick Start","text":"<p>Process variants with the standalone CLI.</p> <p>Many samples on HPC? Use Nextflow instead.</p>"},{"location":"getting-started/quickstart/#basic-usage","title":"Basic Usage","text":"<pre><code>gbcms run \\\n    --variants variants.vcf \\\n    --bam sample.bam \\\n    --fasta reference.fa \\\n    --output-dir results/\n</code></pre> <p>Output: <code>results/sample.vcf</code></p>"},{"location":"getting-started/quickstart/#common-options","title":"Common Options","text":""},{"location":"getting-started/quickstart/#output-format","title":"Output Format","text":"<pre><code># VCF output (default)\ngbcms run -v variants.vcf -b sample.bam -f ref.fa -o out/ --format vcf\n\n# MAF output\ngbcms run -v variants.maf -b sample.bam -f ref.fa -o out/ --format maf\n</code></pre>"},{"location":"getting-started/quickstart/#multiple-samples","title":"Multiple Samples","text":"<pre><code># Using BAM list file\necho \"sample1 /path/to/sample1.bam\" &gt; bam_list.txt\necho \"sample2 /path/to/sample2.bam\" &gt;&gt; bam_list.txt\n\ngbcms run \\\n    --variants variants.vcf \\\n    --bam-list bam_list.txt \\\n    --fasta reference.fa \\\n    --output-dir results/\n</code></pre>"},{"location":"getting-started/quickstart/#custom-sample-id","title":"Custom Sample ID","text":"<pre><code>gbcms run \\\n    --variants variants.vcf \\\n    --bam MySample:sample.bam \\\n    --fasta reference.fa \\\n    --output-dir results/\n</code></pre> Output: <code>results/MySample.vcf</code>"},{"location":"getting-started/quickstart/#quality-filters","title":"Quality Filters","text":"<pre><code>gbcms run \\\n    --variants variants.vcf \\\n    --bam sample.bam \\\n    --fasta reference.fa \\\n    --output-dir results/ \\\n    --min-mapq 30 \\\n    --min-baseq 20 \\\n    --filter-duplicates \\\n    --filter-secondary\n</code></pre>"},{"location":"getting-started/quickstart/#threading","title":"Threading","text":"<pre><code>gbcms run ... --threads 8\n</code></pre>"},{"location":"getting-started/quickstart/#complete-example","title":"Complete Example","text":"<pre><code>gbcms run \\\n    --variants variants.vcf \\\n    --bam TumorSample:tumor.bam \\\n    --fasta hg38.fa \\\n    --output-dir genotyped/ \\\n    --format vcf \\\n    --suffix .genotyped \\\n    --threads 8 \\\n    --min-mapq 30 \\\n    --min-baseq 20 \\\n    --filter-duplicates \\\n    --filter-secondary \\\n    --filter-supplementary\n</code></pre> <p>Output: <code>genotyped/TumorSample.genotyped.vcf</code></p>"},{"location":"getting-started/quickstart/#docker","title":"Docker","text":"<pre><code>docker run --rm -v $(pwd):/data ghcr.io/msk-access/py-gbcms:2.3.0 \\\n    gbcms run \\\n    --variants /data/variants.vcf \\\n    --bam /data/sample.bam \\\n    --fasta /data/reference.fa \\\n    --output-dir /data/results/\n</code></pre>"},{"location":"getting-started/quickstart/#cli-reference","title":"CLI Reference","text":"<pre><code>gbcms run --help\n</code></pre> Option Default Description <code>--variants</code> Required VCF or MAF file <code>--bam</code> Required BAM file(s) <code>--fasta</code> Required Reference FASTA <code>--output-dir</code> Required Output directory <code>--format</code> vcf Output format (vcf/maf) <code>--min-mapq</code> 20 Minimum mapping quality <code>--min-baseq</code> 0 Minimum base quality <code>--threads</code> 1 Number of threads"},{"location":"getting-started/quickstart/#next-steps","title":"Next Steps","text":"<ul> <li>Nextflow \u2014 Process many samples in parallel</li> <li>Architecture \u2014 How it works</li> <li>Variant Counting \u2014 How each variant type is counted</li> </ul>"},{"location":"includes/abbreviations/","title":"Abbreviations","text":""},{"location":"nextflow/","title":"Overview","text":""},{"location":"nextflow/#nextflow-pipeline","title":"Nextflow Pipeline","text":"<p>Run py-gbcms at scale on HPC clusters with automatic parallelization.</p>"},{"location":"nextflow/#overview","title":"Overview","text":"<p>The Nextflow workflow provides:</p> <ul> <li>Automatic parallelization across samples</li> <li>SLURM/HPC integration with resource management  </li> <li>Containerization with Docker/Singularity</li> <li>Resume capability for failed runs</li> </ul>"},{"location":"nextflow/#quick-start","title":"Quick Start","text":"<pre><code>nextflow run nextflow/main.nf \\\n    --input samplesheet.csv \\\n    --variants variants.vcf \\\n    --fasta reference.fa \\\n    -profile docker\n</code></pre>"},{"location":"nextflow/#documentation","title":"Documentation","text":"Page Description Samplesheet Input CSV format Parameters All configuration options Examples Common usage patterns"},{"location":"nextflow/#related","title":"Related","text":"<ul> <li>CLI Reference \u2014 For processing few samples</li> <li>Troubleshooting \u2014 Common issues</li> </ul>"},{"location":"nextflow/examples/","title":"Examples","text":""},{"location":"nextflow/examples/#nextflow-examples","title":"Nextflow Examples","text":"<p>Common usage patterns for the py-gbcms Nextflow pipeline.</p>"},{"location":"nextflow/examples/#basic-usage","title":"Basic Usage","text":""},{"location":"nextflow/examples/#local-with-docker","title":"Local with Docker","text":"<pre><code>nextflow run nextflow/main.nf \\\n    --input samplesheet.csv \\\n    --variants variants.vcf \\\n    --fasta reference.fa \\\n    --outdir results \\\n    -profile docker\n</code></pre>"},{"location":"nextflow/examples/#slurm-cluster","title":"SLURM Cluster","text":"<pre><code>nextflow run nextflow/main.nf \\\n    --input samplesheet.csv \\\n    --variants variants.vcf \\\n    --fasta reference.fa \\\n    --outdir results \\\n    -profile slurm\n</code></pre>"},{"location":"nextflow/examples/#maf-output","title":"MAF Output","text":"<pre><code>nextflow run nextflow/main.nf \\\n    --input samplesheet.csv \\\n    --variants input.maf \\\n    --fasta reference.fa \\\n    --format maf \\\n    -profile docker\n</code></pre>"},{"location":"nextflow/examples/#strict-filtering","title":"Strict Filtering","text":"<p>Enable all quality filters:</p> <pre><code>nextflow run nextflow/main.nf \\\n    --input samplesheet.csv \\\n    --variants variants.vcf \\\n    --fasta reference.fa \\\n    --filter_duplicates true \\\n    --filter_secondary true \\\n    --filter_supplementary true \\\n    --filter_qc_failed true \\\n    -profile docker\n</code></pre>"},{"location":"nextflow/examples/#resume-failed-run","title":"Resume Failed Run","text":"<pre><code>nextflow run nextflow/main.nf \\\n    --input samplesheet.csv \\\n    --variants variants.vcf \\\n    --fasta reference.fa \\\n    -profile docker \\\n    -resume\n</code></pre>"},{"location":"nextflow/examples/#custom-resource-limits","title":"Custom Resource Limits","text":"<pre><code>nextflow run nextflow/main.nf \\\n    --input samplesheet.csv \\\n    --variants variants.vcf \\\n    --fasta reference.fa \\\n    --max_cpus 8 \\\n    --max_memory 32.GB \\\n    -profile docker\n</code></pre>"},{"location":"nextflow/examples/#related","title":"Related","text":"<ul> <li>Samplesheet \u2014 Input format</li> <li>Parameters \u2014 All options</li> <li>CLI Quick Start \u2014 For few samples</li> </ul>"},{"location":"nextflow/parameters/","title":"Parameters","text":""},{"location":"nextflow/parameters/#nextflow-parameters","title":"Nextflow Parameters","text":"<p>Complete reference for all pipeline parameters.</p>"},{"location":"nextflow/parameters/#required-parameters","title":"Required Parameters","text":"Parameter Description <code>--input</code> Path to samplesheet CSV <code>--variants</code> Path to VCF/MAF variants file <code>--fasta</code> Reference FASTA (with .fai index)"},{"location":"nextflow/parameters/#output-options","title":"Output Options","text":"Parameter Default Description <code>--outdir</code> <code>results</code> Output directory <code>--format</code> <code>vcf</code> Output format (<code>vcf</code> or <code>maf</code>) <code>--suffix</code> <code>''</code> Suffix for output filenames"},{"location":"nextflow/parameters/#filtering-options","title":"Filtering Options","text":"Parameter Default Description <code>--min_mapq</code> <code>20</code> Minimum MAPQ <code>--min_baseq</code> <code>0</code> Minimum BASEQ <code>--filter_duplicates</code> <code>true</code> Filter duplicate reads <code>--filter_secondary</code> <code>false</code> Filter secondary alignments <code>--filter_supplementary</code> <code>false</code> Filter supplementary alignments <code>--filter_qc_failed</code> <code>false</code> Filter QC failed reads <code>--filter_improper_pair</code> <code>false</code> Filter improperly paired reads <code>--filter_indel</code> <code>false</code> Filter reads with indels"},{"location":"nextflow/parameters/#resource-limits","title":"Resource Limits","text":"Parameter Default Description <code>--max_cpus</code> <code>16</code> Maximum CPUs per job <code>--max_memory</code> <code>128.GB</code> Maximum memory per job <code>--max_time</code> <code>240.h</code> Maximum runtime per job"},{"location":"nextflow/parameters/#performance-benchmarks","title":"Performance Benchmarks","text":"<p>Representative metrics from cfDNA duplex BAM samples:</p> Sample Type BAM Size Variants Runtime CPUs ctDNA (plasma) 1.3 GB 608 ~25s 4 Plasma control 776 MB 608 ~20s 4"},{"location":"nextflow/parameters/#execution-profiles","title":"Execution Profiles","text":"Profile Description <code>docker</code> Local with Docker containers <code>singularity</code> HPC with Singularity <code>slurm</code> SLURM cluster with Singularity <code>local</code> No container (requires local install)"},{"location":"nextflow/parameters/#related","title":"Related","text":"<ul> <li>Samplesheet \u2014 Input format</li> <li>Examples \u2014 Usage patterns</li> <li>CLI Reference \u2014 Underlying command</li> </ul>"},{"location":"nextflow/samplesheet/","title":"Samplesheet","text":""},{"location":"nextflow/samplesheet/#samplesheet-format","title":"Samplesheet Format","text":"<p>The samplesheet is a CSV file defining input samples for the Nextflow pipeline.</p>"},{"location":"nextflow/samplesheet/#basic-format","title":"Basic Format","text":"<pre><code>sample,bam,bai\nsample1,/path/to/sample1.bam,/path/to/sample1.bam.bai\nsample2,/path/to/sample2.bam,\nsample3,/path/to/sample3.bam,/path/to/sample3.bam.bai\n</code></pre>"},{"location":"nextflow/samplesheet/#columns","title":"Columns","text":"Column Required Description <code>sample</code> Yes Sample identifier (used in output filenames) <code>bam</code> Yes Path to BAM file <code>bai</code> No Path to BAM index (auto-discovers <code>.bam.bai</code> or <code>.bai</code>) <code>suffix</code> No Per-sample output suffix"},{"location":"nextflow/samplesheet/#bai-auto-discovery","title":"BAI Auto-Discovery","text":"<p>If <code>bai</code> column is empty, the pipeline checks for:</p> <ol> <li><code>&lt;bam&gt;.bai</code> (e.g., <code>sample.bam.bai</code>)</li> <li><code>&lt;bam_without_extension&gt;.bai</code> (e.g., <code>sample.bai</code>)</li> </ol> <p>Tip</p> <p>Leave the <code>bai</code> column empty to use auto-discovery.</p>"},{"location":"nextflow/samplesheet/#per-sample-suffix","title":"Per-Sample Suffix","text":"<p>For samples with multiple BAM types:</p> <pre><code>sample,bam,bai,suffix\nsample1,/path/to/sample1.duplex.bam,,-duplex\nsample1,/path/to/sample1.simplex.bam,,-simplex\nsample1,/path/to/sample1.unfiltered.bam,,-unfiltered\n</code></pre> <p>Output files: <code>sample1-duplex.maf</code>, <code>sample1-simplex.maf</code>, <code>sample1-unfiltered.maf</code></p>"},{"location":"nextflow/samplesheet/#related","title":"Related","text":"<ul> <li>Parameters \u2014 All pipeline options</li> <li>Examples \u2014 Common usage patterns</li> <li>Troubleshooting \u2014 Common issues</li> </ul>"},{"location":"reference/architecture/","title":"Architecture","text":""},{"location":"reference/architecture/#architecture","title":"Architecture","text":"<p>py-gbcms uses a hybrid Python/Rust architecture for maximum performance.</p>"},{"location":"reference/architecture/#system-overview","title":"System Overview","text":"<pre><code>flowchart TB\n    subgraph Python [\ud83d\udc0d Python Layer]\n        CLI[CLI - cli.py] --&gt; Pipeline[Orchestration - pipeline.py]\n        Pipeline --&gt; Reader[Input Adapters]\n        Pipeline --&gt; Writer[Output Writers]\n    end\n\n    subgraph Rust [\ud83e\udd80 Rust Layer]\n        Counter[count_bam - counting.rs] --&gt; CIGAR[CIGAR Parser]\n        Counter --&gt; Stats[Strand Bias - stats.rs]\n    end\n\n    Pipeline --&gt;|PyO3| Counter\n    Counter --&gt;|BaseCounts| Pipeline\n\n    classDef pythonStyle fill:#3776ab,color:#fff,stroke:#2c5f8a,stroke-width:2px;\n    classDef rustStyle fill:#dea584,color:#000,stroke:#c48a6a,stroke-width:2px;\n    class Python pythonStyle;\n    class Rust rustStyle;\n</code></pre>  Use mouse to pan and zoom"},{"location":"reference/architecture/#data-flow","title":"Data Flow","text":"<pre><code>flowchart LR\n    subgraph Input\n        VCF[VCF/MAF]\n        BAM[BAM Files]\n        FASTA[Reference]\n    end\n\n    subgraph Process\n        Load[Load Variants]\n        Validate[Validate vs Ref]\n        Count[Count Reads]\n    end\n\n    subgraph Output\n        Result[VCF/MAF + Counts]\n    end\n\n    VCF --&gt; Load --&gt; Validate\n    FASTA --&gt; Validate\n    Validate --&gt; Count\n    BAM --&gt; Count\n    Count --&gt; Result\n</code></pre>  Use mouse to pan and zoom"},{"location":"reference/architecture/#coordinate-system","title":"Coordinate System","text":"<p>All coordinates normalized to 0-based, half-open internally:</p> <pre><code>flowchart LR\n    VCF[\"VCF (1-based)\"] --&gt;|\"-1\"| Internal[\"Internal (0-based)\"]\n    MAF[\"MAF (1-based)\"] --&gt;|\"-1\"| Internal\n    Internal --&gt;|\"to Rust\"| Rust[\"gbcms._rs\"]\n    Rust --&gt;|\"+1\"| Output[\"Output (1-based)\"]\n</code></pre>  Use mouse to pan and zoom  Format System Example VCF input 1-based chr1:100 Internal 0-based chr1:99 Output 1-based chr1:100"},{"location":"reference/architecture/#formulas","title":"Formulas","text":""},{"location":"reference/architecture/#variant-allele-frequency-vaf","title":"Variant Allele Frequency (VAF)","text":"<pre><code>VAF = AD / (RD + AD)\n</code></pre> <p>Where: - AD = Alternate allele read count - RD = Reference allele read count</p>"},{"location":"reference/architecture/#strand-bias-fishers-exact-test","title":"Strand Bias (Fisher's Exact Test)","text":"<pre><code>         |  Forward  Reverse  |\n    -----+--------------------+\n    Ref  |    a        b      |\n    Alt  |    c        d      |\n    -----+--------------------+\n\n    p-value = Fisher's exact test on 2\u00d72 contingency table\n</code></pre> <p>Low p-value (&lt; 0.05) indicates potential strand bias artifact.</p>"},{"location":"reference/architecture/#module-structure","title":"Module Structure","text":"<pre><code>src/gbcms/\n\u251c\u2500\u2500 cli.py           # Typer CLI\n\u251c\u2500\u2500 pipeline.py      # Orchestration\n\u251c\u2500\u2500 core/\n\u2502   \u2514\u2500\u2500 kernel.py    # Coordinate normalization\n\u251c\u2500\u2500 io/\n\u2502   \u251c\u2500\u2500 input.py     # VcfReader, MafReader\n\u2502   \u2514\u2500\u2500 output.py    # VcfWriter, MafWriter\n\u251c\u2500\u2500 models/\n\u2502   \u2514\u2500\u2500 core.py      # Pydantic config\n\u2514\u2500\u2500 utils/\n    \u2514\u2500\u2500 logging.py   # Structured logging\n\nrust/src/\n\u251c\u2500\u2500 lib.rs           # PyO3 module (_rs)\n\u251c\u2500\u2500 counting.rs      # BAM processing, FragmentEvidence, QNAME hashing\n\u251c\u2500\u2500 stats.rs         # Fisher's exact test\n\u2514\u2500\u2500 types.rs         # Variant, BaseCounts\n</code></pre>"},{"location":"reference/architecture/#configuration","title":"Configuration","text":"<p>All settings via <code>GbcmsConfig</code> (Pydantic model):</p> <pre><code>flowchart TB\n    GbcmsConfig --&gt; OutputConfig[Output Settings]\n    GbcmsConfig --&gt; ReadFilters[Read Filters]\n    GbcmsConfig --&gt; QualityThresholds[Quality Thresholds]\n\n    OutputConfig --&gt; D1[output_dir, format, suffix]\n    ReadFilters --&gt; D2[exclude_secondary, exclude_duplicates]\n    QualityThresholds --&gt; D3[\"min_mapq, min_baseq, fragment_qual_threshold\"]\n</code></pre>  Use mouse to pan and zoom  <p>See models/core.py for definitions.</p>"},{"location":"reference/architecture/#full-pipeline-end-to-end-example","title":"Full Pipeline: End-to-End Example","text":"<p>Here's how a single variant is processed through the complete pipeline:</p> <pre><code>sequenceDiagram\n    participant CLI as CLI (Python)\n    participant Pipeline as Pipeline\n    participant Reader as VCF/MAF Reader\n    participant Kernel as Coordinate Kernel\n    participant Rust as Rust Engine\n    participant BAM as BAM File\n\n    CLI-&gt;&gt;Pipeline: run(config)\n    Pipeline-&gt;&gt;Reader: load variants\n    Reader-&gt;&gt;Kernel: normalize coordinates\n    Kernel--&gt;&gt;Reader: 0-based Variant objects\n    Reader--&gt;&gt;Pipeline: List[Variant]\n\n    loop For each BAM sample\n        Pipeline-&gt;&gt;Rust: count_bam(bam, variants, filters)\n        loop For each variant (parallel via Rayon)\n            Rust-&gt;&gt;BAM: fetch(chrom, pos, pos+1)\n            BAM--&gt;&gt;Rust: Iterator of reads\n            loop For each read\n                Note over Rust: Apply filter cascade\n                Note over Rust: Dispatch to type checker\n                Note over Rust: Update read + fragment counts\n            end\n            Note over Rust: Compute Fisher strand bias\n        end\n        Rust--&gt;&gt;Pipeline: Vec[BaseCounts]\n    end\n\n    Pipeline-&gt;&gt;Pipeline: Write output (VCF/MAF)\n</code></pre>  Use mouse to pan and zoom"},{"location":"reference/architecture/#comparison-with-original-gbcms","title":"Comparison with Original GBCMS","text":"Feature Original GBCMS py-gbcms Counting algorithm Region-based chunking, position matching Per-variant CIGAR traversal Complex variants Optional via <code>--generic_counting</code> Always uses haplotype reconstruction MNP handling Not explicit Dedicated <code>check_mnp</code> with contiguity check Fragment counting Optional (<code>--fragment_count</code>), majority-rule Always computed, quality-weighted consensus with discard Positive strand counts Optional (<code>--positive_count</code>) Always computed Strand bias Not computed Fisher's exact test (read + fragment level) Fractional depth <code>--fragment_fractional_weight</code> Not implemented Parallelism OpenMP block-based Rayon per-variant"},{"location":"reference/architecture/#related","title":"Related","text":"<ul> <li>Variant Counting \u2014 How each variant type is counted</li> <li>Input Formats \u2014 VCF and MAF specifications</li> <li>Glossary \u2014 Term definitions</li> </ul>"},{"location":"reference/glossary/","title":"Glossary","text":""},{"location":"reference/glossary/#glossary","title":"Glossary","text":"<p>Technical terms used throughout the documentation.</p>"},{"location":"reference/glossary/#metrics","title":"Metrics","text":"Term Definition VAF Variant Allele Frequency \u2014 <code>AD / (RD + AD)</code> Strand Bias Fisher's exact test for read direction imbalance AD Alternate allele depth (supporting reads) RD Reference allele depth"},{"location":"reference/glossary/#file-formats","title":"File Formats","text":"Term Definition VCF Variant Call Format \u2014 standard variant file MAF Mutation Annotation Format \u2014 annotation-rich variant file BAM Binary Alignment Map \u2014 compressed alignment file BAI BAM Index \u2014 enables random access to BAM FASTA Reference genome sequence file FAI FASTA Index \u2014 enables random access to FASTA"},{"location":"reference/glossary/#quality-scores","title":"Quality Scores","text":"Term Definition MAPQ Mapping Quality \u2014 confidence in read alignment BASEQ Base Quality \u2014 confidence in base call"},{"location":"reference/glossary/#cfdna-terms","title":"cfDNA Terms","text":"Term Definition cfDNA Cell-free DNA \u2014 circulating DNA in plasma ctDNA Circulating tumor DNA \u2014 tumor-derived cfDNA Duplex Reads from both strands of original molecule"},{"location":"reference/glossary/#related","title":"Related","text":"<ul> <li>Architecture \u2014 System design</li> <li>Input Formats \u2014 File specifications</li> </ul>"},{"location":"reference/input-formats/","title":"Input Formats","text":""},{"location":"reference/input-formats/#input-formats","title":"Input Formats","text":"<p>py-gbcms accepts VCF and MAF files as variant input.</p>"},{"location":"reference/input-formats/#vcf-variant-call-format","title":"VCF (Variant Call Format)","text":"<p>Standard VCF format with required fields:</p> <pre><code>#CHROM  POS     ID      REF     ALT     QUAL    FILTER  INFO\nchr1    12345   .       A       T       .       PASS    .\nchr2    67890   .       G       C       .       PASS    .\n</code></pre>"},{"location":"reference/input-formats/#requirements","title":"Requirements","text":"<ul> <li>Tab-separated</li> <li><code>#CHROM</code>, <code>POS</code>, <code>REF</code>, <code>ALT</code> columns required</li> <li>1-based positions</li> </ul>"},{"location":"reference/input-formats/#maf-mutation-annotation-format","title":"MAF (Mutation Annotation Format)","text":"<p>Standard MAF format with required columns:</p> <pre><code>Hugo_Symbol  Chromosome  Start_Position  End_Position  Reference_Allele  Tumor_Seq_Allele2\nTP53         chr17       7577120         7577120       C                 T\nKRAS         chr12       25398284        25398284      G                 A\n</code></pre>"},{"location":"reference/input-formats/#required-columns","title":"Required Columns","text":"Column Description <code>Chromosome</code> Chromosome name <code>Start_Position</code> 1-based start position <code>Reference_Allele</code> Reference allele <code>Tumor_Seq_Allele2</code> Alternate allele"},{"location":"reference/input-formats/#maf-indel-normalization","title":"MAF Indel Normalization","text":"<p>MAF represents indels using <code>-</code> dashes, while py-gbcms internally uses VCF-style anchor-based coordinates. When a MAF file contains insertions (<code>Reference_Allele = -</code>) or deletions (<code>Tumor_Seq_Allele2 = -</code>), py-gbcms automatically converts them at input time.</p> <p>Reference FASTA Required</p> <p>MAF indel conversion requires <code>--fasta</code> to fetch the anchor base from the reference genome. Without it, indel variants cannot be normalized and will be skipped.</p> <pre><code>flowchart TD\n    MAF([\ud83d\udcc4 MAF Row]):::start --&gt; Check{REF or ALT is '-'?}\n    Check --&gt;|No: SNP/MNP| Direct[Use Start_Position as VCF POS]\n    Check --&gt;|Yes: Indel| Type{Which is '-'?}\n\n    Type --&gt;|\"REF = '-'\"| Ins[Insertion]\n    Type --&gt;|\"ALT = '-'\"| Del[Deletion]\n\n    subgraph Insertion\n        Ins --&gt; InsAnchor[\"Anchor = Start_Position\"]\n        InsAnchor --&gt; InsFetch[\"Fetch anchor base from FASTA\"]\n        InsFetch --&gt; InsResult[\"REF = anchor base\\nALT = anchor + inserted seq\"]\n    end\n\n    subgraph Deletion\n        Del --&gt; DelAnchor[\"Anchor = Start_Position \u2212 1\"]\n        DelAnchor --&gt; DelFetch[\"Fetch anchor base from FASTA\"]\n        DelFetch --&gt; DelResult[\"REF = anchor + deleted seq\\nALT = anchor base\"]\n    end\n\n    Direct --&gt; Out([\ud83e\uddec Internal Variant]):::success\n    InsResult --&gt; Out\n    DelResult --&gt; Out\n\n    classDef start fill:#9b59b6,color:#fff,stroke:#7d3c98,stroke-width:2px;\n    classDef success fill:#27ae60,color:#fff,stroke:#1e8449,stroke-width:2px;\n</code></pre>  Use mouse to pan and zoom"},{"location":"reference/input-formats/#insertion-example","title":"Insertion Example","text":"<p>Insert <code>TG</code> after chr1:100 (where the reference base at position 100 is <code>A</code>):</p> Field MAF VCF (internal) Position <code>Start_Position = 100</code> <code>POS = 100</code> REF <code>-</code> <code>A</code> (fetched from FASTA) ALT <code>TG</code> <code>ATG</code> (anchor + inserted seq)"},{"location":"reference/input-formats/#deletion-example","title":"Deletion Example","text":"<p>Delete <code>CG</code> at chr1:101\u2013102 (where the reference base at position 100 is <code>A</code>):</p> Field MAF VCF (internal) Position <code>Start_Position = 101</code> (first deleted base) <code>POS = 100</code> (anchor) REF <code>CG</code> <code>ACG</code> (anchor + deleted seq) ALT <code>-</code> <code>A</code> (anchor only) <p>Position Shift for Deletions</p> <p>For insertions, <code>Start_Position</code> already points to the anchor base. For deletions, <code>Start_Position</code> points to the first deleted base, so py-gbcms shifts back by one position to find the anchor.</p>"},{"location":"reference/input-formats/#variant-left-normalization","title":"Variant Left-Normalization","text":"<p>py-gbcms uses windowed indel detection (\u00b15bp) to handle cases where aligners place indels at different positions in repetitive regions. For this to work correctly, input variants should be left-aligned (left-normalized).</p> <p>Left-Align Your Variants</p> <p>Inconsistently normalized variants reduce the effectiveness of windowed indel detection. While the \u00b15bp window will catch most aligner-shifted indels, left-alignment ensures the anchor position is consistent with standard conventions.</p>"},{"location":"reference/input-formats/#vcf-normalization","title":"VCF Normalization","text":"<p>Use <code>bcftools norm</code> to left-align and normalize VCF variants:</p> <pre><code>bcftools norm -f reference.fa -o normalized.vcf input.vcf\n</code></pre>"},{"location":"reference/input-formats/#maf-normalization","title":"MAF Normalization","text":"<p>MAF files are automatically converted to VCF-style anchor-based coordinates by py-gbcms (see above). Ensure your MAF variants are already left-aligned before input \u2014 most variant annotation pipelines (e.g., <code>vcf2maf</code>) produce left-aligned output by default.</p>"},{"location":"reference/input-formats/#reference-fasta","title":"Reference FASTA","text":"<ul> <li>Must have corresponding <code>.fai</code> index</li> <li>Chromosome names must match VCF/MAF</li> </ul> <pre><code># Create index if missing\nsamtools faidx reference.fa\n</code></pre>"},{"location":"reference/input-formats/#bam-requirements","title":"BAM Requirements","text":"<ul> <li>Must have corresponding <code>.bai</code> index</li> <li>Coordinate-sorted</li> <li>Chromosome names must match reference</li> </ul>"},{"location":"reference/input-formats/#related","title":"Related","text":"<ul> <li>CLI Run Command \u2014 Usage examples</li> <li>Architecture \u2014 How counting works</li> <li>Glossary \u2014 Term definitions</li> </ul>"},{"location":"reference/variant-counting/","title":"Variant Counting","text":""},{"location":"reference/variant-counting/#variant-counting","title":"Variant Counting","text":"<p>How py-gbcms counts reads for each variant type \u2014 with visual examples.</p>"},{"location":"reference/variant-counting/#overview","title":"Overview","text":"<p>For every variant, py-gbcms fetches reads overlapping the variant position from each BAM file, applies read filters, and then dispatches to a type-specific allele checker. Each read is classified as supporting the reference allele, the alternate allele, or neither.</p> <pre><code>flowchart LR\n    Fetch([\ud83d\udce5 Fetch Reads]):::fetch --&gt; Filter([\ud83d\udd0d Apply Filters]):::filter\n    Filter --&gt; Dispatch{Variant Type?}\n    Dispatch --&gt;|SNP| SNP[check_snp]\n    Dispatch --&gt;|Insertion| INS[check_insertion]\n    Dispatch --&gt;|Deletion| DEL[check_deletion]\n    Dispatch --&gt;|MNP| MNP[check_mnp]\n    Dispatch --&gt;|Complex| CPX[check_complex]\n    SNP --&gt; Count([\ud83d\udcca Update Counts]):::count\n    INS --&gt; Count\n    DEL --&gt; Count\n    MNP --&gt; Count\n    CPX --&gt; Count\n\n    classDef fetch fill:#4a90d9,color:#fff,stroke:#2c6fad,stroke-width:2px;\n    classDef filter fill:#e67e22,color:#fff,stroke:#bf6516,stroke-width:2px;\n    classDef count fill:#27ae60,color:#fff,stroke:#1e8449,stroke-width:2px;\n</code></pre>  Use mouse to pan and zoom"},{"location":"reference/variant-counting/#read-filter-pipeline","title":"Read Filter Pipeline","text":"<p>Before any allele checking begins, every read passes through a filter cascade. Reads that fail any enabled filter are discarded. The order matches the Rust engine implementation.</p> <pre><code>flowchart TD\n    Start([\ud83d\udcd6 Read from BAM]):::process\n\n    subgraph Filters [Quality &amp; Alignment Filters]\n        direction TB\n        F1{Duplicate?}:::decision\n        F2{Secondary?}:::decision\n        F3{Supplementary?}:::decision\n        F4{QC Failed?}:::decision\n        F5{Improper pair?}:::decision\n        F6{Contains indel?}:::decision\n        F7{MAPQ \u2265 20?}:::decision\n    end\n\n    Drop{{\u274c Discard Read}}:::discard\n    Pass([\u2705 Pass to Allele Checker]):::success\n\n    Start --&gt; F1\n\n    F1 -- \"Yes\" --&gt; Drop\n    F1 -- \"No\" --&gt; F2\n\n    F2 -- \"Yes\" --&gt; Drop\n    F2 -- \"No\" --&gt; F3\n\n    F3 -- \"Yes\" --&gt; Drop\n    F3 -- \"No\" --&gt; F4\n\n    F4 -- \"Yes\" --&gt; Drop\n    F4 -- \"No\" --&gt; F5\n\n    F5 -- \"Yes\" --&gt; Drop\n    F5 -- \"No\" --&gt; F6\n\n    F6 -- \"Yes\" --&gt; Drop\n    F6 -- \"No\" --&gt; F7\n\n    F7 -- \"Below 20\" --&gt; Drop\n    F7 -- \"Pass\" --&gt; Pass\n\n    classDef process fill:#9b59b6,color:#fff,stroke:#7d3c98,stroke-width:2px;\n    classDef decision fill:#f39c12,color:#fff,stroke:#d68910,stroke-width:2px;\n    classDef discard fill:#e74c3c,color:#fff,stroke:#c0392b,stroke-width:2px;\n    classDef success fill:#27ae60,color:#fff,stroke:#1e8449,stroke-width:2px;\n</code></pre>  Use mouse to pan and zoom  Filter CLI Flag Default SAM Flag Duplicates <code>--filter-duplicates</code> On <code>0x400</code> Secondary <code>--filter-secondary</code> Off <code>0x100</code> Supplementary <code>--filter-supplementary</code> Off <code>0x800</code> QC Failed <code>--filter-qc-failed</code> Off <code>0x200</code> Improper Pair <code>--filter-improper-pair</code> Off <code>0x2</code> (inverted) Indel reads <code>--filter-indel</code> Off CIGAR-based MAPQ threshold <code>--min-mapq</code> 20 \u2014 BASEQ threshold <code>--min-baseq</code> 0 \u2014 (per-type) <p>Filter Non-Primary</p> <p>The original GBCMS has a single <code>--filter_non_primary</code> flag. py-gbcms splits this into <code>--filter-secondary</code> and <code>--filter-supplementary</code> for finer control. Both default to off, matching the original behavior.</p>"},{"location":"reference/variant-counting/#variant-types","title":"Variant Types","text":""},{"location":"reference/variant-counting/#snp-single-nucleotide-polymorphism","title":"SNP (Single Nucleotide Polymorphism)","text":"<p>A single base substitution \u2014 the simplest and most common variant type.</p> Property Value Detection <code>len(REF) == 1 &amp;&amp; len(ALT) == 1</code> Position 0-based index of the substituted base Quality check Base quality at the position must meet <code>--min-baseq</code>"},{"location":"reference/variant-counting/#algorithm-flow","title":"Algorithm Flow","text":"<pre><code>flowchart TD\n    Start([\ud83e\uddec SNP Check]):::start --&gt; Walk[Walk CIGAR to variant pos]\n    Walk --&gt; Found{Position found?}\n    Found --&gt;|No| Neither1([Neither]):::neither\n    Found --&gt;|Yes| BQ{Base quality \u2265 min_baseq?}\n    BQ --&gt;|No| Neither2([Neither]):::neither\n    BQ --&gt;|Yes| Compare[Compare base to REF and ALT]\n    Compare --&gt; IsRef{base == REF?}\n    IsRef --&gt;|Yes| Ref([\u2705 REF]):::ref\n    IsRef --&gt;|No| IsAlt{base == ALT?}\n    IsAlt --&gt;|Yes| Alt([\ud83d\udd34 ALT]):::alt\n    IsAlt --&gt;|No| Neither3([Neither]):::neither\n\n    classDef start fill:#9b59b6,color:#fff,stroke:#7d3c98,stroke-width:2px;\n    classDef ref fill:#27ae60,color:#fff,stroke:#1e8449,stroke-width:2px;\n    classDef alt fill:#e74c3c,color:#fff,stroke:#c0392b,stroke-width:2px;\n    classDef neither fill:#95a5a6,color:#fff,stroke:#7f8c8d,stroke-width:2px;\n</code></pre>  Use mouse to pan and zoom"},{"location":"reference/variant-counting/#visual-example","title":"Visual Example","text":"<pre><code>Variant: chr1:100 C\u2192T (SNP)\n\nReference: 5'\u2500 ...G  A  T  C  G  A  T  C  G  A... \u25003'\n                          98 99 100 101\n                               \u25b2\n                           variant pos\n\nRead 1:    5'\u2500 ...G  A  T [T] G  A  T  C... \u25003'   \u2192 ALT \u2705\n                               \u2191\n                          base=T matches ALT\n\nRead 2:    5'\u2500 ...G  A  T [C] G  A  T  C... \u25003'   \u2192 REF \u2705\n                               \u2191\n                          base=C matches REF\n\nRead 3:    5'\u2500 ...G  A  T [A] G  A  T  C... \u25003'   \u2192 Neither\n                               \u2191\n                          base=A \u2260 REF or ALT\n</code></pre>"},{"location":"reference/variant-counting/#insertion","title":"Insertion","text":"<p>Bases inserted after an anchor position. The anchor is the last reference base before the inserted sequence.</p> Property Value Detection <code>len(REF) == 1 &amp;&amp; len(ALT) &gt; 1</code> Position 0-based index of the anchor base Quality check None (CIGAR-structural check only)"},{"location":"reference/variant-counting/#algorithm-flow_1","title":"Algorithm Flow","text":"<p>The insertion check uses a single CIGAR walk with two strategies: strict match (fast path) and windowed scan (\u00b15bp fallback).</p> <pre><code>flowchart TD\n    Start([\ud83e\uddec Insertion Check]):::start --&gt; Walk[Walk CIGAR left \u2192 right]\n    Walk --&gt; Found{Match block contains anchor?}\n    Found --&gt;|No| WindowCheck\n    Found --&gt;|Yes| AtEnd{Anchor at end of block?}\n    AtEnd --&gt;|No| RefCov[Mark ref coverage]\n    AtEnd --&gt;|Yes| NextOp{Next op is Ins?}\n    NextOp --&gt;|No| RefCov\n    NextOp --&gt;|Yes| Strict{Length + seq match?}\n    Strict --&gt;|Yes| StrictAlt([\ud83d\udd34 ALT - strict]):::alt\n    Strict --&gt;|No| RefCov\n    RefCov --&gt; WindowCheck\n\n    WindowCheck{Ins within \u00b15bp window?}\n    WindowCheck --&gt;|No| Continue[Continue CIGAR walk]\n    WindowCheck --&gt;|Yes| S1{S1: Seq matches?}\n    S1 --&gt;|No| Continue\n    S1 --&gt;|Yes| S3{S3: Anchor base matches ref?}\n    S3 --&gt;|No| Continue\n    S3 --&gt;|Yes| S2[S2: Track closest match]\n    S2 --&gt; Continue\n\n    Continue --&gt; MoreOps{More CIGAR ops?}\n    MoreOps --&gt;|Yes| Walk\n    MoreOps --&gt;|No| Eval{Windowed candidate found?}\n    Eval --&gt;|Yes| WinAlt([\ud83d\udd34 ALT - windowed]):::alt\n    Eval --&gt;|No| HasRef{Read covered anchor?}\n    HasRef --&gt;|Yes| Ref([\u2705 REF]):::ref\n    HasRef --&gt;|No| Neither([Neither]):::neither\n\n    classDef start fill:#9b59b6,color:#fff,stroke:#7d3c98,stroke-width:2px;\n    classDef ref fill:#27ae60,color:#fff,stroke:#1e8449,stroke-width:2px;\n    classDef alt fill:#e74c3c,color:#fff,stroke:#c0392b,stroke-width:2px;\n    classDef neither fill:#95a5a6,color:#fff,stroke:#7f8c8d,stroke-width:2px;\n</code></pre>  Use mouse to pan and zoom"},{"location":"reference/variant-counting/#visual-example_1","title":"Visual Example","text":"<pre><code>Variant: chr1:100 A\u2192ATG (insertion of TG after anchor A)\n\nReference:     5'\u2500 ...C  G  A \u2500\u2500 C  G  T  A... \u25003'\n                          99 100  101 102\n                               \u25b2\n                          anchor pos\n\nRead 1 (ALT, strict):  CIGAR = 5M 2I 5M\n               5'\u2500 ...C  G  A [T  G] C  G  T  A... \u25003'\n                               \u2514\u2500\u2500\u2518\n                          inserted bases at anchor \u2192 ALT \u2705 (strict)\n\nRead 2 (ALT, windowed): CIGAR = 7M 2I 3M\n               5'\u2500 ...C  G  A  C  G [T  G] T  A... \u25003'\n                                          \u2514\u2500\u2500\u2518\n                    insertion shifted +2bp, same seq \u2192 ALT \u2705 (windowed)\n\nRead 3 (REF):  CIGAR = 10M\n               5'\u2500 ...C  G  A  C  G  T  A... \u25003'\n                               \u2191\n                          no insertion after anchor \u2192 REF \u2705\n\nRead 4 (wrong seq): CIGAR = 5M 2I 5M\n               5'\u2500 ...C  G  A [C  C] C  G  T  A... \u25003'\n                               \u2514\u2500\u2500\u2518\n                          insertion bases \u2260 expected TG \u2192 S1 reject\n</code></pre> <p>Why anchor-based?</p> <p>In VCF format, insertions are represented as <code>REF=A, ALT=ATG</code> where the first base <code>A</code> is the anchor \u2014 it's not part of the inserted sequence. py-gbcms uses this anchor to locate where the insertion should occur in the CIGAR string.</p> <p>MAF \u2192 VCF Anchor Conversion</p> <p>MAF format represents indels differently \u2014 using <code>-</code> dashes instead of an anchor base. py-gbcms automatically converts MAF indels to VCF-style anchor-based representation at input time, which requires a reference FASTA (<code>--fasta</code>).</p> <p>Insertion (e.g., insert <code>TG</code> after chr1:100):</p> MAF VCF (internal) Position <code>Start_Position=100</code> (anchor) <code>POS=100</code> REF <code>-</code> <code>A</code> (fetched from FASTA) ALT <code>TG</code> <code>ATG</code> (anchor + inserted seq) <p>Deletion (e.g., delete <code>CG</code> at chr1:101\u2013102):</p> MAF VCF (internal) Position <code>Start_Position=101</code> (first deleted base) <code>POS=100</code> (anchor = base before) REF <code>CG</code> <code>ACG</code> (anchor + deleted seq) ALT <code>-</code> <code>A</code> (anchor only) <p>Note that for deletions, MAF <code>Start_Position</code> points to the first deleted base, not the anchor. py-gbcms shifts back by one position and fetches the preceding base from the FASTA as the anchor.</p> <p>See Input Formats for full details.</p>"},{"location":"reference/variant-counting/#deletion","title":"Deletion","text":"<p>Bases deleted after an anchor position. The logic mirrors insertion but looks for <code>Del</code> CIGAR operations.</p> Property Value Detection <code>len(REF) &gt; 1 &amp;&amp; len(ALT) == 1</code> Position 0-based index of the anchor base Quality check None (CIGAR-structural check only)"},{"location":"reference/variant-counting/#algorithm-flow_2","title":"Algorithm Flow","text":"<p>Same single-walk strategy as insertion, with Safeguard 3 checking deleted reference bases.</p> <pre><code>flowchart TD\n    Start([\ud83e\uddec Deletion Check]):::start --&gt; Walk[Walk CIGAR left \u2192 right]\n    Walk --&gt; Found{Match block contains anchor?}\n    Found --&gt;|No| WindowCheck\n    Found --&gt;|Yes| AtEnd{Anchor at end of block?}\n    AtEnd --&gt;|No| RefCov[Mark ref coverage]\n    AtEnd --&gt;|Yes| NextOp{Next op is Del?}\n    NextOp --&gt;|No| RefCov\n    NextOp --&gt;|Yes| Strict{Length matches?}\n    Strict --&gt;|Yes| StrictAlt([\ud83d\udd34 ALT - strict]):::alt\n    Strict --&gt;|No| RefCov\n    RefCov --&gt; WindowCheck\n\n    WindowCheck{Del within \u00b15bp window?}\n    WindowCheck --&gt;|No| Continue[Continue CIGAR walk]\n    WindowCheck --&gt;|Yes| S1{S1: Del length matches?}\n    S1 --&gt;|No| Continue\n    S1 --&gt;|Yes| S3{S3: Ref bases at shift match?}\n    S3 --&gt;|No| Continue\n    S3 --&gt;|Yes| S2[S2: Track closest match]\n    S2 --&gt; Continue\n\n    Continue --&gt; MoreOps{More CIGAR ops?}\n    MoreOps --&gt;|Yes| Walk\n    MoreOps --&gt;|No| Eval{Windowed candidate found?}\n    Eval --&gt;|Yes| WinAlt([\ud83d\udd34 ALT - windowed]):::alt\n    Eval --&gt;|No| HasRef{Read covered anchor?}\n    HasRef --&gt;|Yes| Ref([\u2705 REF]):::ref\n    HasRef --&gt;|No| Neither([Neither]):::neither\n\n    classDef start fill:#9b59b6,color:#fff,stroke:#7d3c98,stroke-width:2px;\n    classDef ref fill:#27ae60,color:#fff,stroke:#1e8449,stroke-width:2px;\n    classDef alt fill:#e74c3c,color:#fff,stroke:#c0392b,stroke-width:2px;\n    classDef neither fill:#95a5a6,color:#fff,stroke:#7f8c8d,stroke-width:2px;\n</code></pre>  Use mouse to pan and zoom"},{"location":"reference/variant-counting/#visual-example_2","title":"Visual Example","text":"<pre><code>Variant: chr1:100 ACG\u2192A (deletion of CG after anchor A)\n\nReference:     5'\u2500 ...T  G  A  C  G  T  A  C... \u25003'\n                          99 100 101 102\n                               \u25b2\n                          anchor pos\n\nRead 1 (ALT, strict):  CIGAR = 5M 2D 5M\n               5'\u2500 ...T  G  A  \u2500\u2500  \u2500\u2500  T  A  C... \u25003'\n                               \u2514\u2500\u2500\u2500\u2500\u2500\u2518\n                          2bp deletion at anchor \u2192 ALT \u2705 (strict)\n\nRead 2 (ALT, windowed): CIGAR = 7M 2D 3M\n               5'\u2500 ...T  G  A  C  G  T  \u2500\u2500  \u2500\u2500  A  C... \u25003'\n                                              \u2514\u2500\u2500\u2500\u2500\u2500\u2518\n                  deletion shifted +2bp, same length, ref matches \u2192 ALT \u2705 (windowed)\n                  (S3 verifies ref bases at shifted pos match deleted 'CG')\n\nRead 3 (REF):  CIGAR = 12M\n               5'\u2500 ...T  G  A  C  G  T  A  C... \u25003'\n                               \u2191\n                          no deletion after anchor \u2192 REF \u2705\n\nRead 4 (wrong length): CIGAR = 5M 3D 5M\n               5'\u2500 ...T  G  A  \u2500\u2500  \u2500\u2500  \u2500\u2500  A  C... \u25003'\n                               \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                          3bp deletion \u2260 expected 2bp \u2192 S1 reject\n</code></pre>"},{"location":"reference/variant-counting/#mnp-multi-nucleotide-polymorphism","title":"MNP (Multi-Nucleotide Polymorphism)","text":"<p>Multiple adjacent bases substituted simultaneously. Think of it as multiple SNPs happening at consecutive positions.</p> Property Value Detection <code>len(REF) == len(ALT) &amp;&amp; len(REF) &gt; 1</code> Position 0-based index of the first substituted base Quality check Every base in the MNP region must meet <code>--min-baseq</code>"},{"location":"reference/variant-counting/#algorithm-flow_3","title":"Algorithm Flow","text":"<pre><code>flowchart TD\n    Start([\ud83e\uddec MNP Check]):::start --&gt; Find[Find read position of first base]\n    Find --&gt; Found{Position found?}\n    Found --&gt;|No| Neither1([Neither]):::neither\n    Found --&gt;|Yes| Cover{Read covers entire MNP region?}\n    Cover --&gt;|No| Neither2([Neither]):::neither\n    Cover --&gt;|Yes| Loop[For each position in MNP region]\n\n    subgraph PerBase [Per-Base Validation]\n        direction TB\n        BQ{Base quality \u2265 min_baseq?}\n        Track[Compare base to REF and ALT]\n        More{More positions?}\n    end\n\n    Loop --&gt; BQ\n    BQ --&gt;|No| Neither3([Neither]):::neither\n    BQ --&gt;|Yes| Track\n    Track --&gt; More\n    More --&gt;|Yes| BQ\n    More --&gt;|No| Contig{No indels within MNP region?}\n\n    Contig --&gt;|Indel found| Neither4([Neither]):::neither\n    Contig --&gt;|Contiguous| Final{All bases match?}\n    Final --&gt;|All match ALT| Alt([\ud83d\udd34 ALT]):::alt\n    Final --&gt;|All match REF| Ref([\u2705 REF]):::ref\n    Final --&gt;|Mixed| Neither5([Neither]):::neither\n\n    classDef start fill:#9b59b6,color:#fff,stroke:#7d3c98,stroke-width:2px;\n    classDef ref fill:#27ae60,color:#fff,stroke:#1e8449,stroke-width:2px;\n    classDef alt fill:#e74c3c,color:#fff,stroke:#c0392b,stroke-width:2px;\n    classDef neither fill:#95a5a6,color:#fff,stroke:#7f8c8d,stroke-width:2px;\n</code></pre>  Use mouse to pan and zoom"},{"location":"reference/variant-counting/#visual-example_3","title":"Visual Example","text":"<pre><code>Variant: chr1:100 AT\u2192CG (2-base MNP)\n\nReference:     5'\u2500 ...G  A  T  A  T  G  C... \u25003'\n                          99 100 101\n                              \u25b2\u2500\u2500\u2500\u25b2\n                           MNP region\n\nRead 1 (ALT):  5'\u2500 ...G  A  T [C  G] G  C... \u25003'   \u2192 ALT \u2705\n                              \u2514\u2500\u2500\u2518\n                         both bases match ALT: C=C \u2713, G=G \u2713\n\nRead 2 (REF):  5'\u2500 ...G  A  T [A  T] G  C... \u25003'   \u2192 REF \u2705\n                              \u2514\u2500\u2500\u2518\n                         both bases match REF: A=A \u2713, T=T \u2713\n\nRead 3 (mixed): 5'\u2500 ...G  A  T [C  T] G  C... \u25003'  \u2192 Neither\n                              \u2514\u2500\u2500\u2518\n                         C=ALT[0] \u2713, but T=REF[1] \u2717  (partial match)\n\nRead 4 (indel): CIGAR = 3M 1I 3M\n                5'\u2500 ...G  A  T [C] X [G] G  C... \u25003' \u2192 Neither\n                                   \u2191\n                         indel within MNP region \u2192 fails contiguity check\n</code></pre> <p>Strict matching</p> <p>MNP matching is all-or-nothing: every base must match either REF or ALT. A read with <code>C T</code> at a <code>AT\u2192CG</code> variant (matching the first ALT base but second REF base) is classified as neither \u2014 it's not counted for either allele.</p>"},{"location":"reference/variant-counting/#complex-indel-substitution","title":"Complex (Indel + Substitution)","text":"<p>Variants where REF and ALT differ in both sequence and length. This is the catch-all category that uses a sophisticated haplotype reconstruction algorithm.</p> Property Value Detection Fallback for all other combinations Position 0-based index of the first reference base Quality check Minimum base quality across all reconstructed bases must meet <code>--min-baseq</code>"},{"location":"reference/variant-counting/#algorithm-flow-haplotype-reconstruction","title":"Algorithm Flow \u2014 Haplotype Reconstruction","text":"<pre><code>flowchart TD\n    Start([\ud83e\uddec Complex Check]):::start --&gt; Region[Define genomic region]:::info\n    Region --&gt; Init[Init reconstructed seq + min qual]\n\n    subgraph CIGARWalk [CIGAR Walk]\n        direction TB\n        Walk[Walk each CIGAR op]\n        OpType{CIGAR op type?}\n        Walk --&gt; OpType\n        OpType --&gt;|\"M / = / X\"| Match[Append overlapping bases]\n        OpType --&gt;|\"I\"| InsCheck[Append inserted bases]\n        OpType --&gt;|\"D / N\"| AdvRef[Advance ref_pos only]\n        OpType --&gt;|\"S\"| AdvRead[Advance read_pos only]\n        OpType --&gt;|\"H / P\"| Skip[No action]\n        Match --&gt; Next[Next op]\n        InsCheck --&gt; Next\n        AdvRef --&gt; Next\n        AdvRead --&gt; Next\n        Skip --&gt; Next\n        Next --&gt; More{More CIGAR ops?}\n        More --&gt;|Yes| Walk\n    end\n\n    Init --&gt; Walk\n    More --&gt;|No| Compare\n\n    subgraph Classify [Allele Classification]\n        direction TB\n        Compare[Compare reconstructed seq]\n        Compare --&gt; CmpAlt{Matches ALT?}\n        CmpAlt --&gt;|Yes| QualA{Quality \u2265 min_baseq?}\n        CmpAlt --&gt;|No| CmpRef{Matches REF?}\n        CmpRef --&gt;|Yes| QualR{Quality \u2265 min_baseq?}\n        CmpRef --&gt;|No| Neither3([Neither]):::neither\n    end\n\n    QualA --&gt;|Yes| Alt([\ud83d\udd34 ALT]):::alt\n    QualA --&gt;|No| Neither1([Neither]):::neither\n    QualR --&gt;|Yes| Ref([\u2705 REF]):::ref\n    QualR --&gt;|No| Neither2([Neither]):::neither\n\n    classDef start fill:#9b59b6,color:#fff,stroke:#7d3c98,stroke-width:2px;\n    classDef info fill:#3498db,color:#fff,stroke:#2471a3,stroke-width:2px;\n    classDef ref fill:#27ae60,color:#fff,stroke:#1e8449,stroke-width:2px;\n    classDef alt fill:#e74c3c,color:#fff,stroke:#c0392b,stroke-width:2px;\n    classDef neither fill:#95a5a6,color:#fff,stroke:#7f8c8d,stroke-width:2px;\n</code></pre>  Use mouse to pan and zoom"},{"location":"reference/variant-counting/#worked-example-step-by-step-reconstruction","title":"Worked Example: Step-by-Step Reconstruction","text":"<p>Here's a concrete example showing how the engine reconstructs a read's sequence for a complex variant.</p> <pre><code>Variant: chr1:10 ACG\u2192TT (complex: 3bp REF \u2192 2bp ALT)\nRegion:  [10, 13)   (0-based, half-open)\n</code></pre> <p>Read supporting ALT \u2014 CIGAR: <code>10M 1D 1I 8M</code></p> <pre><code>Step-by-step CIGAR walk:\n\n  CIGAR op    ref_pos  read_pos  Overlap with [10,13)?  Action\n  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500   \u2500\u2500\u2500\u2500\u2500\u2500\u2500  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  10M         0\u219210     0\u219210      [10,10) = none         (just advance)\n  \u26a0\ufe0f Wait \u2014 let's reconsider. 10M covers ref [0,10), read [0,10).\n     overlap with [10,13) = none yet.\n\n  Actually, the 10M goes from ref 0 to 10 (exclusive).\n  After 10M: ref_pos=10, read_pos=10.\n\n  1D          10\u219211    (no read)  ref_pos 10 is in [10,13)\n                                  But Del \u2192 no bases appended, ref advances\n              After: ref_pos=11, read_pos=10\n\n  1I          11       10\u219211     ref_pos=11 is in [10,13]\n                                  Append 1 inserted base from read[10]\n                                  reconstructed = \"T\"\n              After: ref_pos=11, read_pos=11\n\n  8M          11\u219219    11\u219219     overlap [11,13) = 2 bases\n                                  Append read[11] and read[12]\n                                  reconstructed = \"T\" + \"T\" = \"TT\"\n              After: ref_pos=19, read_pos=19\n\n  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  Result: reconstructed = \"TT\"\n          Compare to ALT = \"TT\" \u2192 \u2705 Match! \u2192 ALT\n</code></pre> <p>Read supporting REF \u2014 CIGAR: <code>20M</code></p> <pre><code>  CIGAR op    ref_pos  read_pos  Overlap with [10,13)?  Action\n  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500   \u2500\u2500\u2500\u2500\u2500\u2500\u2500  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  20M         0\u219220     0\u219220      [10,13) = 3 bases\n                                  Append read[10], read[11], read[12]\n                                  reconstructed = \"ACG\"\n\n  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  Result: reconstructed = \"ACG\"\n          Compare to ALT = \"TT\"  \u2192 length 3 \u2260 2 \u2192 no match\n          Compare to REF = \"ACG\" \u2192 \u2705 Match! \u2192 REF\n</code></pre> <p>Auto-detection</p> <p>If a variant's type string is unknown, py-gbcms auto-detects MNPs (equal-length REF/ALT with length &gt; 1) and falls back to the complex haplotype reconstruction for everything else.</p>"},{"location":"reference/variant-counting/#counting-levels","title":"Counting Levels","text":"<p>After allele classification, py-gbcms tracks counts at two levels: individual reads and collapsed fragments.</p>"},{"location":"reference/variant-counting/#read-level-vs-fragment-level","title":"Read-Level vs Fragment-Level","text":"<pre><code>flowchart TD\n    subgraph ReadLevel [\ud83d\udcd6 Read-Level Counting]\n        R1[Read 1 fwd \u2192 ALT]:::altread\n        R2[Read 2 rev \u2192 ALT]:::altread\n        R3[Read 3 fwd \u2192 REF]:::refread\n        R4[Read 4 rev \u2192 REF]:::refread\n        R5[Read 5 fwd \u2192 ALT]:::altread\n        R6[Read 6 rev \u2192 REF]:::refread\n    end\n\n    subgraph FragLevel [\ud83e\uddec Fragment-Level Counting]\n        direction TB\n        F1[Fragment A: R1+R2 \u2192 ALT]:::altfrag\n        F2[Fragment B: R3+R4 \u2192 REF]:::reffrag\n        F3[Fragment C: R5 only \u2192 ALT]:::altfrag\n        F4[Fragment D: R6 only \u2192 REF]:::reffrag\n    end\n\n    R1 --&gt; F1\n    R2 --&gt; F1\n    R3 --&gt; F2\n    R4 --&gt; F2\n    R5 --&gt; F3\n    R6 --&gt; F4\n\n    subgraph Results [\ud83d\udcca Final Counts]\n        ReadCounts[Reads: DP=6  RD=3  AD=3]\n        FragCounts[Fragments: DPF=4  RDF=2  ADF=2]\n    end\n\n    F1 --&gt; FragCounts\n    F2 --&gt; FragCounts\n    F3 --&gt; FragCounts\n    F4 --&gt; FragCounts\n\n    classDef altread fill:#e74c3c15,stroke:#e74c3c;\n    classDef refread fill:#27ae6015,stroke:#27ae60;\n    classDef altfrag fill:#9b59b615,stroke:#9b59b6;\n    classDef reffrag fill:#27ae6015,stroke:#27ae60;\n</code></pre>  Use mouse to pan and zoom"},{"location":"reference/variant-counting/#read-level-metrics","title":"Read-Level Metrics","text":"<p>Each read is counted independently.</p> Metric Description DP Total depth (reads supporting REF or ALT) RD / AD Reference / Alternate read counts DP_fwd / DP_rev Strand-specific total depth RD_fwd / RD_rev Strand-specific reference counts AD_fwd / AD_rev Strand-specific alternate counts"},{"location":"reference/variant-counting/#fragment-counting-algorithm","title":"Fragment Counting Algorithm","text":"<p>Fragment counting collapses read pairs into a single observation per fragment using quality-weighted consensus. Each fragment is tracked internally as a <code>FragmentEvidence</code> struct that records the best base quality seen for REF and ALT across both reads.</p> <pre><code>flowchart TD\n    Start([For each read passing filters]):::start\n    Start --&gt; Hash[\"Hash QNAME \u2192 u64 key\"]\n    Hash --&gt; Observe[\"Record allele + base quality into FragmentEvidence\"]\n    Observe --&gt; Done[After all reads processed]\n    Done --&gt; ForEach[For each unique fragment]\n    ForEach --&gt; HasBoth{Both REF and ALT evidence?}\n    HasBoth --&gt;|No| Direct[Assign to whichever allele was seen]\n    HasBoth --&gt;|Yes| QualCheck{\"Quality difference &gt; threshold?\"}\n    QualCheck --&gt;|\"REF qual &gt;&gt; ALT qual\"| Ref([\u2705 Count as REF]):::ref\n    QualCheck --&gt;|\"ALT qual &gt;&gt; REF qual\"| Alt([\ud83d\udd34 Count as ALT]):::alt\n    QualCheck --&gt;|\"Within threshold\"| Discard([\u26aa Discard \u2014 ambiguous]):::discard\n    Direct --&gt; Count\n    Ref --&gt; Count\n    Alt --&gt; Count\n    Discard --&gt; DPF[\"Still counted in DPF\"]:::info\n    Count[Update RDF / ADF / DPF + strand counts]\n\n    classDef start fill:#3498db,color:#fff,stroke:#2471a3,stroke-width:2px;\n    classDef ref fill:#27ae60,color:#fff,stroke:#1e8449,stroke-width:2px;\n    classDef alt fill:#e74c3c,color:#fff,stroke:#c0392b,stroke-width:2px;\n    classDef discard fill:#95a5a6,color:#fff,stroke:#7f8c8d,stroke-width:2px;\n    classDef info fill:#3498db15,stroke:#3498db;\n</code></pre>  Use mouse to pan and zoom"},{"location":"reference/variant-counting/#quality-weighted-consensus","title":"Quality-Weighted Consensus","text":"<p>When R1 and R2 of a fragment disagree (one supports REF, the other ALT), the engine resolves the conflict using base quality scores:</p> Scenario Condition Result REF wins <code>best_ref_qual &gt; best_alt_qual + threshold</code> Count as REF ALT wins <code>best_alt_qual &gt; best_ref_qual + threshold</code> Count as ALT Ambiguous Quality difference \u2264 threshold Discard (neither REF nor ALT) <p>The threshold is configurable via <code>--fragment-qual-threshold</code> (default: 10).</p> <p>Why discard instead of defaulting to REF?</p> <p>Assigning ambiguous fragments to REF would systematically deflate VAF by inflating the reference count. In cfDNA sequencing where true variants can be at 0.1\u20131% VAF, this bias could mask real mutations. Discarding preserves an unbiased VAF estimate at the cost of slightly reduced power (fewer counted fragments).</p> <p>Quality metric: DPF \u2212 (RDF + ADF)</p> <p>Discarded fragments are still counted in DPF (total fragment depth) but not in RDF or ADF. The gap <code>DPF \u2212 (RDF + ADF)</code> reveals how many ambiguous fragments exist at a locus \u2014 a useful quality signal. A high gap suggests a noisy or error-prone site.</p> Metric Description DPF Fragment depth (all fragments, including discarded) RDF / ADF Reference / Alternate fragment counts (resolved only) RDF_fwd / RDF_rev Strand-specific reference fragment counts ADF_fwd / ADF_rev Strand-specific alternate fragment counts <p>Why fragment counting matters for cfDNA</p> <p>In cfDNA sequencing (like MSK-ACCESS), the same DNA fragment is often sequenced from both ends. Counting reads would double-count each fragment. Fragment-level counting gives a more accurate picture of the number of unique molecules supporting each allele.</p>"},{"location":"reference/variant-counting/#strand-bias-fishers-exact-test","title":"Strand Bias (Fisher's Exact Test)","text":"<p>Strand bias detects when an allele is disproportionately supported by reads on one strand \u2014 a common sequencing artifact.</p> <pre><code>flowchart LR\n    subgraph Table [2\u00d72 Contingency Table]\n        direction TB\n        Header[\"| \u00b7 | Fwd | Rev |\"]\n        RefRow[\"| REF | a | b |\"]\n        AltRow[\"| ALT | c | d |\"]\n    end\n\n    Table --&gt; Fisher([Fisher Exact Test]):::test\n    Fisher --&gt; Pval[SB_pval]\n    Fisher --&gt; OR[SB_OR]\n\n    Pval --&gt; Interpret{p &lt; 0.05?}\n    Interpret --&gt;|Yes| Bias{{\u26a0\ufe0f Possible Strand Bias}}:::warn\n    Interpret --&gt;|No| NoBias([\u2705 No Strand Bias]):::pass\n\n    classDef test fill:#3498db,color:#fff,stroke:#2471a3,stroke-width:2px;\n    classDef warn fill:#e74c3c,color:#fff,stroke:#c0392b,stroke-width:2px;\n    classDef pass fill:#27ae60,color:#fff,stroke:#1e8449,stroke-width:2px;\n</code></pre>  Use mouse to pan and zoom  <p>Computed at both levels:</p> Metric Level Description SB_pval / SB_OR Read Strand bias from individual reads FSB_pval / FSB_OR Fragment Strand bias from collapsed fragments <p>Strand bias example</p> <p>If a variant has <code>AD_fwd=15, AD_rev=1</code>, that's suspicious \u2014 almost all ALT-supporting reads are on the forward strand. Fisher's test would yield a low p-value, flagging this as a potential artifact rather than a true variant.</p>"},{"location":"reference/variant-counting/#related","title":"Related","text":"<ul> <li>Architecture \u2014 System design, full pipeline diagram, and comparison with original GBCMS</li> <li>Input Formats \u2014 VCF and MAF specifications</li> <li>Glossary \u2014 Term definitions</li> <li>CLI Run Command \u2014 All parameter options</li> </ul>"},{"location":"resources/citation/","title":"Citation","text":""},{"location":"resources/citation/#citation","title":"Citation","text":"<p>If you use py-gbcms in your research, please cite:</p>"},{"location":"resources/citation/#software-citation","title":"Software Citation","text":"<pre><code>@software{py-gbcms,\n  author = {Shah, Ronak H.},\n  title = {py-gbcms: High-performance variant counting from BAM files},\n  year = {2024},\n  url = {https://github.com/msk-access/py-gbcms},\n  organization = {Memorial Sloan Kettering Cancer Center}\n}\n</code></pre>"},{"location":"resources/citation/#links","title":"Links","text":"<ul> <li>GitHub: msk-access/py-gbcms</li> <li>PyPI: py-gbcms</li> <li>Documentation: msk-access.github.io/py-gbcms</li> </ul>"},{"location":"resources/citation/#related-projects","title":"Related Projects","text":"<ul> <li>Krewlyzer \u2014 cfDNA fragmentomics analysis</li> <li>MSK-ACCESS \u2014 Liquid biopsy platform</li> </ul>"},{"location":"resources/troubleshooting/","title":"Troubleshooting","text":""},{"location":"resources/troubleshooting/#troubleshooting","title":"Troubleshooting","text":"<p>Common issues and solutions for py-gbcms.</p>"},{"location":"resources/troubleshooting/#installation-issues","title":"Installation Issues","text":""},{"location":"resources/troubleshooting/#rust-compilation-fails","title":"Rust Compilation Fails","text":"<p>Error: <code>error: linker 'cc' not found</code></p> <p>Solution: Install build tools: </p><pre><code># macOS\nxcode-select --install\n\n# Ubuntu/Debian\napt-get install build-essential\n\n# CentOS/RHEL\nyum groupinstall \"Development Tools\"\n</code></pre><p></p>"},{"location":"resources/troubleshooting/#htslib-linking-error","title":"htslib Linking Error","text":"<p>Error: <code>cannot find -lhts</code></p> <p>Solution: The Rust backend compiles htslib statically. Ensure you have: </p><pre><code># Dependencies\napt-get install zlib1g-dev libbz2-dev liblzma-dev libcurl4-openssl-dev\n</code></pre><p></p>"},{"location":"resources/troubleshooting/#runtime-issues","title":"Runtime Issues","text":""},{"location":"resources/troubleshooting/#bai-not-found","title":"BAI Not Found","text":"<p>Error: <code>BAI index not found for sample.bam</code></p> <p>Solution: Create or verify index: </p><pre><code>samtools index sample.bam\n</code></pre><p></p>"},{"location":"resources/troubleshooting/#chromosome-mismatch","title":"Chromosome Mismatch","text":"<p>Error: <code>Chromosome X not found in reference</code></p> <p>Solution: Ensure chromosome naming matches between VCF/MAF, BAM, and FASTA (e.g., <code>chr1</code> vs <code>1</code>).</p>"},{"location":"resources/troubleshooting/#nextflow-issues","title":"Nextflow Issues","text":""},{"location":"resources/troubleshooting/#container-not-found","title":"Container Not Found","text":"<p>Error: <code>Unable to find image 'ghcr.io/msk-access/py-gbcms:latest'</code></p> <p>Solution: Pull manually: </p><pre><code>docker pull ghcr.io/msk-access/py-gbcms:latest\n# or\nsingularity pull docker://ghcr.io/msk-access/py-gbcms:latest\n</code></pre><p></p>"},{"location":"resources/troubleshooting/#task-metrics-error","title":"Task Metrics Error","text":"<p>Error: <code>Command 'ps' required by nextflow to collect task metrics</code></p> <p>This occurs when running containers that lack <code>procps</code>. Use a newer image with procps installed.</p>"},{"location":"resources/troubleshooting/#related","title":"Related","text":"<ul> <li>Installation \u2014 Setup guide</li> <li>Nextflow Parameters \u2014 Resource options</li> </ul>"}]}