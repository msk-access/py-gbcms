<!DOCTYPE html><html class="no-js" lang="en"><head>
<meta charset="utf-8">
<meta content="width=device-width,initial-scale=1" name="viewport">
<meta content="High-performance variant counting from BAM files" name="description">
<meta content="MSK-ACCESS" name="author">
<link href="https://msk-access.github.io/py-gbcms/dev/reference/allele-classification/" rel="canonical">
<link href="../read-filters/" rel="prev">
<link href="../counting-metrics/" rel="next">
<link href="../../assets/images/favicon.png" rel="icon">
<meta content="mkdocs-1.6.1, mkdocs-material-9.7.2" name="generator">
<title>Allele Classification - py-gbcms</title>
<link href="../../assets/stylesheets/main.484c7ddc.min.css" rel="stylesheet">
<link href="../../assets/stylesheets/palette.ab4e12ef.min.css" rel="stylesheet">
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect">
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet">
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<link href="../../css/timeago.css" rel="stylesheet">
<link href="../../stylesheets/extra.css" rel="stylesheet">
<link href="../../assets/stylesheets/panzoom.css" rel="stylesheet">
<script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
<link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"><script src="../../assets/javascripts/glightbox.min.js"></script><style id="glightbox-style">
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color); }
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color); }
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color); }
        </style><meta name="panzoom-theme" content="material">
<meta name="panzoom-data" content='{"selectors": [".d2", ".mermaid"], "initial_zoom_level": 1.0}'> </head>
<body data-md-color-accent="custom" data-md-color-primary="custom" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox">
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox">
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#allele-classification">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<div data-md-color-scheme="default" data-md-component="outdated" hidden="">
</div>
<header class="md-header md-header--shadow" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="py-gbcms" class="md-header__button md-logo" data-md-component="logo" href="../.." title="py-gbcms">
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            py-gbcms
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Allele Classification
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="custom" data-md-color-media="(prefers-color-scheme: light)" data-md-color-primary="custom" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio">
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to dark mode">
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="custom" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary="custom" data-md-color-scheme="slate" id="__palette_1" name="__palette" type="radio">
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to light mode">
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
</form>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text">
<label class="md-search__icon md-icon" for="__search">
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
<div class="md-search__suggest" data-md-component="search-suggest"></div>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/msk-access/py-gbcms" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewBox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg>
</div>
<div class="md-source__repository">
    msk-access/py-gbcms
  </div>
</a>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="py-gbcms" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="py-gbcms">
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
    py-gbcms
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/msk-access/py-gbcms" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewBox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg>
</div>
<div class="md-source__repository">
    msk-access/py-gbcms
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../..">
<span class="md-ellipsis">
    
  
    Home
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_2" type="checkbox">
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../getting-started/">
<span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
</a>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            
  
    Getting Started
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../getting-started/installation/">
<span class="md-ellipsis">
    
  
    Installation
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../getting-started/quickstart/">
<span class="md-ellipsis">
    
  
    Quick Start
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3" type="checkbox">
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../cli/">
<span class="md-ellipsis">
    
  
    CLI Reference
  

    
  </span>
</a>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            
  
    CLI Reference
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../cli/run/">
<span class="md-ellipsis">
    
  
    Run Command
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cli/normalize/">
<span class="md-ellipsis">
    
  
    Normalize Command
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_4" type="checkbox">
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../nextflow/">
<span class="md-ellipsis">
    
  
    Nextflow Pipeline
  

    
  </span>
</a>
<label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_4_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
            
  
    Nextflow Pipeline
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../nextflow/samplesheet/">
<span class="md-ellipsis">
    
  
    Samplesheet
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../nextflow/parameters/">
<span class="md-ellipsis">
    
  
    Parameters
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../nextflow/examples/">
<span class="md-ellipsis">
    
  
    Examples
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_5" type="checkbox">
<label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
<span class="md-ellipsis">
    
  
    How It Works
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_5_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
            
  
    How It Works
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../architecture/">
<span class="md-ellipsis">
    
  
    Architecture
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../input-formats/">
<span class="md-ellipsis">
    
  
    Input Formats
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../variant-normalization/">
<span class="md-ellipsis">
    
  
    Variant Normalization
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../read-filters/">
<span class="md-ellipsis">
    
  
    Read Filters
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox">
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    
  
    Allele Classification
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
<span class="md-ellipsis">
    
  
    Allele Classification
  

    
  </span>
</a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#dispatch">
<span class="md-ellipsis">
      
        Dispatch
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#snp-single-nucleotide-polymorphism">
<span class="md-ellipsis">
      
        SNP (Single Nucleotide Polymorphism)
      
    </span>
</a>
<nav aria-label="SNP (Single Nucleotide Polymorphism)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#algorithm">
<span class="md-ellipsis">
      
        Algorithm
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#visual-example">
<span class="md-ellipsis">
      
        Visual Example
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#insertion">
<span class="md-ellipsis">
      
        Insertion
      
    </span>
</a>
<nav aria-label="Insertion" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#algorithm_1">
<span class="md-ellipsis">
      
        Algorithm
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#windowed-scan-safeguards">
<span class="md-ellipsis">
      
        Windowed Scan Safeguards
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#visual-example_1">
<span class="md-ellipsis">
      
        Visual Example
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#deletion">
<span class="md-ellipsis">
      
        Deletion
      
    </span>
</a>
<nav aria-label="Deletion" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#algorithm_2">
<span class="md-ellipsis">
      
        Algorithm
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#visual-example_2">
<span class="md-ellipsis">
      
        Visual Example
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#mnp-multi-nucleotide-polymorphism">
<span class="md-ellipsis">
      
        MNP (Multi-Nucleotide Polymorphism)
      
    </span>
</a>
<nav aria-label="MNP (Multi-Nucleotide Polymorphism)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#algorithm_3">
<span class="md-ellipsis">
      
        Algorithm
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#contiguity-check">
<span class="md-ellipsis">
      
        Contiguity Check
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#complex-indel-substitution">
<span class="md-ellipsis">
      
        Complex (Indel + Substitution)
      
    </span>
</a>
<nav aria-label="Complex (Indel + Substitution)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#three-phase-algorithm">
<span class="md-ellipsis">
      
        Three-Phase Algorithm
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#phase-1-haplotype-reconstruction">
<span class="md-ellipsis">
      
        Phase 1: Haplotype Reconstruction
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#phase-2-masked-comparison">
<span class="md-ellipsis">
      
        Phase 2: Masked Comparison
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#phase-25-edit-distance">
<span class="md-ellipsis">
      
        Phase 2.5: Edit Distance
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#phase-3-smith-waterman-fallback">
<span class="md-ellipsis">
      
        Phase 3: Smith-Waterman Fallback
      
    </span>
</a>
<nav aria-label="Phase 3: Smith-Waterman Fallback" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#dual-trigger-local-fallback">
<span class="md-ellipsis">
      
        Dual-Trigger Local Fallback
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#limitations">
<span class="md-ellipsis">
      
        Limitations
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#related">
<span class="md-ellipsis">
      
        Related
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../counting-metrics/">
<span class="md-ellipsis">
    
  
    Counting &amp; Metrics
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../glossary/">
<span class="md-ellipsis">
    
  
    Glossary
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_6" type="checkbox">
<label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="">
<span class="md-ellipsis">
    
  
    Development
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_6_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_6">
<span class="md-nav__icon md-icon"></span>
            
  
    Development
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../development/developer-guide/">
<span class="md-ellipsis">
    
  
    Developer Guide
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../development/testing-guide/">
<span class="md-ellipsis">
    
  
    Testing Guide
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../development/release-guide/">
<span class="md-ellipsis">
    
  
    Release Guide
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../development/changelog/">
<span class="md-ellipsis">
    
  
    Changelog
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../development/contributing/">
<span class="md-ellipsis">
    
  
    Contributing
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_7" type="checkbox">
<label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="">
<span class="md-ellipsis">
    
  
    Resources
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_7_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_7">
<span class="md-nav__icon md-icon"></span>
            
  
    Resources
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../resources/troubleshooting/">
<span class="md-ellipsis">
    
  
    Troubleshooting
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../resources/citation/">
<span class="md-ellipsis">
    
  
    Citation
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#dispatch">
<span class="md-ellipsis">
      
        Dispatch
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#snp-single-nucleotide-polymorphism">
<span class="md-ellipsis">
      
        SNP (Single Nucleotide Polymorphism)
      
    </span>
</a>
<nav aria-label="SNP (Single Nucleotide Polymorphism)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#algorithm">
<span class="md-ellipsis">
      
        Algorithm
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#visual-example">
<span class="md-ellipsis">
      
        Visual Example
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#insertion">
<span class="md-ellipsis">
      
        Insertion
      
    </span>
</a>
<nav aria-label="Insertion" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#algorithm_1">
<span class="md-ellipsis">
      
        Algorithm
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#windowed-scan-safeguards">
<span class="md-ellipsis">
      
        Windowed Scan Safeguards
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#visual-example_1">
<span class="md-ellipsis">
      
        Visual Example
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#deletion">
<span class="md-ellipsis">
      
        Deletion
      
    </span>
</a>
<nav aria-label="Deletion" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#algorithm_2">
<span class="md-ellipsis">
      
        Algorithm
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#visual-example_2">
<span class="md-ellipsis">
      
        Visual Example
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#mnp-multi-nucleotide-polymorphism">
<span class="md-ellipsis">
      
        MNP (Multi-Nucleotide Polymorphism)
      
    </span>
</a>
<nav aria-label="MNP (Multi-Nucleotide Polymorphism)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#algorithm_3">
<span class="md-ellipsis">
      
        Algorithm
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#contiguity-check">
<span class="md-ellipsis">
      
        Contiguity Check
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#complex-indel-substitution">
<span class="md-ellipsis">
      
        Complex (Indel + Substitution)
      
    </span>
</a>
<nav aria-label="Complex (Indel + Substitution)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#three-phase-algorithm">
<span class="md-ellipsis">
      
        Three-Phase Algorithm
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#phase-1-haplotype-reconstruction">
<span class="md-ellipsis">
      
        Phase 1: Haplotype Reconstruction
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#phase-2-masked-comparison">
<span class="md-ellipsis">
      
        Phase 2: Masked Comparison
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#phase-25-edit-distance">
<span class="md-ellipsis">
      
        Phase 2.5: Edit Distance
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#phase-3-smith-waterman-fallback">
<span class="md-ellipsis">
      
        Phase 3: Smith-Waterman Fallback
      
    </span>
</a>
<nav aria-label="Phase 3: Smith-Waterman Fallback" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#dual-trigger-local-fallback">
<span class="md-ellipsis">
      
        Dual-Trigger Local Fallback
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#limitations">
<span class="md-ellipsis">
      
        Limitations
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#related">
<span class="md-ellipsis">
      
        Related
      
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<nav aria-label="Navigation" class="md-path">
<ol class="md-path__list">
<li class="md-path__item">
<a class="md-path__link" href="../..">
<span class="md-ellipsis">
    Home
  </span>
</a>
</li>
<li class="md-path__item">
<a class="md-path__link" href="../architecture/">
<span class="md-ellipsis">
    How It Works
  </span>
</a>
</li>
</ol>
</nav>
<article class="md-content__inner md-typeset">
<div><h1 id="allele-classification">Allele Classification<a class="headerlink" href="#allele-classification" title="Permanent link">¬∂</a></h1>
<p>How py-gbcms classifies each read as supporting the <strong>reference</strong> allele, the <strong>alternate</strong> allele, or <strong>neither</strong>.</p>
<div class="admonition tip">
<p class="admonition-title">Detailed Visual Reference (PDF)</p>
<p><embed alt="Allele Classification Visual Guide" src="../../assets/posters/Allele_Classification_factory_cmp.pdf" style="min-height:75vh;width:100%" type="application/pdf"></p>
</div>
<h2 id="dispatch">Dispatch<a class="headerlink" href="#dispatch" title="Permanent link">¬∂</a></h2>
<p>After passing <a href="../read-filters/">read filters</a>, each read is dispatched to a <strong>type-specific</strong> allele checker based on the variant's <strong>allele lengths</strong> (<code>ref_len</code> √ó <code>alt_len</code>), not on the <code>variant_type</code> string. This makes dispatch robust against inconsistent upstream type labels:</p>
<div class="panzoom-box" data-key="none" id="panzoom0" oncontextmenu="return false;">
<nav class="panzoom-nav">
<button class="panzoom-info panzoom-button">
<svg class="panzoom-icon" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
<path d="M464 256A208 208 0 1 0 48 256a208 208 0 1 0 416 0zM0 256a256 256 0 1 1 512 0A256 256 0 1 1 0 256zm169.8-90.7c7.9-22.3 29.1-37.3 52.8-37.3l58.3 0c34.9 0 63.1 28.3 63.1 63.1c0 22.6-12.1 43.5-31.7 54.8L280 264.4c-.2 13-10.9 23.6-24 23.6c-13.3 0-24-10.7-24-24l0-13.5c0-8.6 4.6-16.5 12.1-20.8l44.3-25.4c4.7-2.7 7.6-7.7 7.6-13.1c0-8.4-6.8-15.1-15.1-15.1l-58.3 0c-3.4 0-6.4 2.1-7.5 5.3l-.4 1.2c-4.4 12.5-18.2 19-30.6 14.6s-19-18.2-14.6-30.6l.4-1.2zM224 352a32 32 0 1 1 64 0 32 32 0 1 1 -64 0z"></path>
</svg>
</button><button class="panzoom-reset panzoom-button">
<svg class="panzoom-icon" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
<path d="M125.7 160l50.3 0c17.7 0 32 14.3 32 32s-14.3 32-32 32L48 224c-17.7 0-32-14.3-32-32L16 64c0-17.7 14.3-32 32-32s32 14.3 32 32l0 51.2L97.6 97.6c87.5-87.5 229.3-87.5 316.8 0s87.5 229.3 0 316.8s-229.3 87.5-316.8 0c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0c62.5 62.5 163.8 62.5 226.3 0s62.5-163.8 0-226.3s-163.8-62.5-226.3 0L125.7 160z"></path>
</svg>
</button><button class="panzoom-max panzoom-button">
<svg class="panzoom-icon" viewBox="0 0 448 512" xmlns="http://www.w3.org/2000/svg">
<path d="M32 32C14.3 32 0 46.3 0 64l0 96c0 17.7 14.3 32 32 32s32-14.3 32-32l0-64 64 0c17.7 0 32-14.3 32-32s-14.3-32-32-32L32 32zM64 352c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 96c0 17.7 14.3 32 32 32l96 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-64 0 0-64zM320 32c-17.7 0-32 14.3-32 32s14.3 32 32 32l64 0 0 64c0 17.7 14.3 32 32 32s32-14.3 32-32l0-96c0-17.7-14.3-32-32-32l-96 0zM448 352c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 64-64 0c-17.7 0-32 14.3-32 32s14.3 32 32 32l96 0c17.7 0 32-14.3 32-32l0-96z"></path>
</svg>
</button><button class="panzoom-min panzoom-button panzoom-hidden">
<svg class="panzoom-icon" viewBox="0 0 448 512" xmlns="http://www.w3.org/2000/svg">
<path d="M160 64c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 64-64 0c-17.7 0-32 14.3-32 32s14.3 32 32 32l96 0c17.7 0 32-14.3 32-32l0-96zM32 320c-17.7 0-32 14.3-32 32s14.3 32 32 32l64 0 0 64c0 17.7 14.3 32 32 32s32-14.3 32-32l0-96c0-17.7-14.3-32-32-32l-96 0zM352 64c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 96c0 17.7 14.3 32 32 32l96 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-64 0 0-64zM320 320c-17.7 0-32 14.3-32 32l0 96c0 17.7 14.3 32 32 32s32-14.3 32-32l0-64 64 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-96 0z"></path>
</svg>
</button>
</nav>
<pre class="mermaid"><code>flowchart LR
    Fetch([üì• Fetch Reads]):::fetch --&gt; Filter([üîç Apply Filters]):::filter
    Filter --&gt; Dispatch{"ref_len √ó alt_len?"}
    Dispatch --&gt;|"1 √ó 1"| SNP[check_snp]
    Dispatch --&gt;|"N √ó N"| MNP[check_mnp]
    Dispatch --&gt;|"1 √ó N"| INS[check_insertion]
    Dispatch --&gt;|"N √ó 1"| DEL[check_deletion]
    Dispatch --&gt;|"else"| CPX[check_complex]
    MNP -.-&gt;|"inconclusive"| CPX
    INS -.-&gt;|"Phase 3 fallback"| CPX
    DEL -.-&gt;|"fallback (CIGAR mismatch)"| CPX
    SNP --&gt; Count([üìä Update Counts]):::count
    INS --&gt; Count
    DEL --&gt; Count
    MNP --&gt; Count
    CPX --&gt; Count

    classDef fetch fill:#4a90d9,color:#fff,stroke:#2c6fad,stroke-width:2px;
    classDef filter fill:#e67e22,color:#fff,stroke:#bf6516,stroke-width:2px;
    classDef count fill:#27ae60,color:#fff,stroke:#1e8449,stroke-width:2px;
</code></pre>
<div class="panzoom-info-box panzoom-info-box-bottom panzoom-hidden">
Use mouse to pan and zoom
</div>
</div>
<div class="admonition info">
<p class="admonition-title">Allele-Length Routing</p>
<p>Dispatch uses <code>ref_allele.len()</code> and <code>alt_allele.len()</code> to determine the variant class. This means even if upstream callers emit inconsistent type strings (e.g., <code>"COMPLEX"</code> for what is really a pure deletion after normalization), the correct checker is always selected.</p>
</div>
<hr>
<h2 id="snp-single-nucleotide-polymorphism">SNP (Single Nucleotide Polymorphism)<a class="headerlink" href="#snp-single-nucleotide-polymorphism" title="Permanent link">¬∂</a></h2>
<p>A single base substitution ‚Äî the simplest and most common variant type.</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Property</th>
<th style="text-align: left;">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">Detection</td>
<td style="text-align: left;"><code>len(REF) == 1 &amp;&amp; len(ALT) == 1</code></td>
</tr>
<tr>
<td style="text-align: left;">Position</td>
<td style="text-align: left;">0-based index of the substituted base</td>
</tr>
<tr>
<td style="text-align: left;">Quality check</td>
<td style="text-align: left;">Base quality at the position must meet <code>--min-baseq</code></td>
</tr>
</tbody>
</table>
<h3 id="algorithm">Algorithm<a class="headerlink" href="#algorithm" title="Permanent link">¬∂</a></h3>
<div class="panzoom-box" data-key="none" id="panzoom0" oncontextmenu="return false;">
<nav class="panzoom-nav">
<button class="panzoom-info panzoom-button">
<svg class="panzoom-icon" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
<path d="M464 256A208 208 0 1 0 48 256a208 208 0 1 0 416 0zM0 256a256 256 0 1 1 512 0A256 256 0 1 1 0 256zm169.8-90.7c7.9-22.3 29.1-37.3 52.8-37.3l58.3 0c34.9 0 63.1 28.3 63.1 63.1c0 22.6-12.1 43.5-31.7 54.8L280 264.4c-.2 13-10.9 23.6-24 23.6c-13.3 0-24-10.7-24-24l0-13.5c0-8.6 4.6-16.5 12.1-20.8l44.3-25.4c4.7-2.7 7.6-7.7 7.6-13.1c0-8.4-6.8-15.1-15.1-15.1l-58.3 0c-3.4 0-6.4 2.1-7.5 5.3l-.4 1.2c-4.4 12.5-18.2 19-30.6 14.6s-19-18.2-14.6-30.6l.4-1.2zM224 352a32 32 0 1 1 64 0 32 32 0 1 1 -64 0z"></path>
</svg>
</button><button class="panzoom-reset panzoom-button">
<svg class="panzoom-icon" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
<path d="M125.7 160l50.3 0c17.7 0 32 14.3 32 32s-14.3 32-32 32L48 224c-17.7 0-32-14.3-32-32L16 64c0-17.7 14.3-32 32-32s32 14.3 32 32l0 51.2L97.6 97.6c87.5-87.5 229.3-87.5 316.8 0s87.5 229.3 0 316.8s-229.3 87.5-316.8 0c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0c62.5 62.5 163.8 62.5 226.3 0s62.5-163.8 0-226.3s-163.8-62.5-226.3 0L125.7 160z"></path>
</svg>
</button><button class="panzoom-max panzoom-button">
<svg class="panzoom-icon" viewBox="0 0 448 512" xmlns="http://www.w3.org/2000/svg">
<path d="M32 32C14.3 32 0 46.3 0 64l0 96c0 17.7 14.3 32 32 32s32-14.3 32-32l0-64 64 0c17.7 0 32-14.3 32-32s-14.3-32-32-32L32 32zM64 352c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 96c0 17.7 14.3 32 32 32l96 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-64 0 0-64zM320 32c-17.7 0-32 14.3-32 32s14.3 32 32 32l64 0 0 64c0 17.7 14.3 32 32 32s32-14.3 32-32l0-96c0-17.7-14.3-32-32-32l-96 0zM448 352c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 64-64 0c-17.7 0-32 14.3-32 32s14.3 32 32 32l96 0c17.7 0 32-14.3 32-32l0-96z"></path>
</svg>
</button><button class="panzoom-min panzoom-button panzoom-hidden">
<svg class="panzoom-icon" viewBox="0 0 448 512" xmlns="http://www.w3.org/2000/svg">
<path d="M160 64c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 64-64 0c-17.7 0-32 14.3-32 32s14.3 32 32 32l96 0c17.7 0 32-14.3 32-32l0-96zM32 320c-17.7 0-32 14.3-32 32s14.3 32 32 32l64 0 0 64c0 17.7 14.3 32 32 32s32-14.3 32-32l0-96c0-17.7-14.3-32-32-32l-96 0zM352 64c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 96c0 17.7 14.3 32 32 32l96 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-64 0 0-64zM320 320c-17.7 0-32 14.3-32 32l0 96c0 17.7 14.3 32 32 32s32-14.3 32-32l0-64 64 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-96 0z"></path>
</svg>
</button>
</nav>
<pre class="mermaid"><code>flowchart TD
    Start([üß¨ SNP Check]):::start --&gt; Walk[Walk CIGAR to variant pos]
    Walk --&gt; Found{Position found?}
    Found --&gt;|No| Neither1([Neither]):::neither
    Found --&gt;|Yes| BQ{Base quality ‚â• min_baseq?}
    BQ --&gt;|No| Neither2([Neither]):::neither
    BQ --&gt;|Yes| Compare[Compare base to REF and ALT]
    Compare --&gt; IsRef{base == REF?}
    IsRef --&gt;|Yes| Ref([‚úÖ REF]):::ref
    IsRef --&gt;|No| IsAlt{base == ALT?}
    IsAlt --&gt;|Yes| Alt([üî¥ ALT]):::alt
    IsAlt --&gt;|No| Neither3([Neither]):::neither

    classDef start fill:#9b59b6,color:#fff,stroke:#7d3c98,stroke-width:2px;
    classDef ref fill:#27ae60,color:#fff,stroke:#1e8449,stroke-width:2px;
    classDef alt fill:#e74c3c,color:#fff,stroke:#c0392b,stroke-width:2px;
    classDef neither fill:#95a5a6,color:#fff,stroke:#7f8c8d,stroke-width:2px;
</code></pre>
<div class="panzoom-info-box panzoom-info-box-bottom panzoom-hidden">
Use mouse to pan and zoom
</div>
</div>
<h3 id="visual-example">Visual Example<a class="headerlink" href="#visual-example" title="Permanent link">¬∂</a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>Variant: chr1:100 C‚ÜíT (SNP)
<a href="#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a>
<a href="#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a>Reference: 5'‚îÄ ...G  A  T  C  G  A  T  C  G  A... ‚îÄ3'
<a href="#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a>                          98 99 100 101
<a href="#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a>                               ‚ñ≤
<a href="#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a>                           variant pos
<a href="#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a>
<a href="#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a>Read 1:    5'‚îÄ ...G  A  T [T] G  A  T  C... ‚îÄ3'   ‚Üí ALT ‚úÖ
<a href="#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a>                               ‚Üë
<a href="#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a>                          base=T matches ALT
<a href="#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a>
<a href="#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a>Read 2:    5'‚îÄ ...G  A  T [C] G  A  T  C... ‚îÄ3'   ‚Üí REF ‚úÖ
<a href="#__codelineno-0-13" id="__codelineno-0-13" name="__codelineno-0-13"></a>                               ‚Üë
<a href="#__codelineno-0-14" id="__codelineno-0-14" name="__codelineno-0-14"></a>                          base=C matches REF
<a href="#__codelineno-0-15" id="__codelineno-0-15" name="__codelineno-0-15"></a>
<a href="#__codelineno-0-16" id="__codelineno-0-16" name="__codelineno-0-16"></a>Read 3:    5'‚îÄ ...G  A  T [A] G  A  T  C... ‚îÄ3'   ‚Üí Neither
<a href="#__codelineno-0-17" id="__codelineno-0-17" name="__codelineno-0-17"></a>                               ‚Üë
<a href="#__codelineno-0-18" id="__codelineno-0-18" name="__codelineno-0-18"></a>                          base=A ‚â† REF or ALT
</code></pre></div>
<hr>
<h2 id="insertion">Insertion<a class="headerlink" href="#insertion" title="Permanent link">¬∂</a></h2>
<p>Bases inserted after an <strong>anchor</strong> position. The anchor is the last reference base before the inserted sequence.</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Property</th>
<th style="text-align: left;">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">Detection</td>
<td style="text-align: left;"><code>len(REF) == 1 &amp;&amp; len(ALT) &gt; 1</code></td>
</tr>
<tr>
<td style="text-align: left;">Position</td>
<td style="text-align: left;">0-based index of the <strong>anchor</strong> base</td>
</tr>
<tr>
<td style="text-align: left;">Quality check</td>
<td style="text-align: left;">Quality-masked sequence comparison</td>
</tr>
</tbody>
</table>
<h3 id="algorithm_1">Algorithm<a class="headerlink" href="#algorithm_1" title="Permanent link">¬∂</a></h3>
<p>The insertion check uses a <strong>single CIGAR walk</strong> with four detection strategies:</p>
<div class="panzoom-box" data-key="none" id="panzoom0" oncontextmenu="return false;">
<nav class="panzoom-nav">
<button class="panzoom-info panzoom-button">
<svg class="panzoom-icon" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
<path d="M464 256A208 208 0 1 0 48 256a208 208 0 1 0 416 0zM0 256a256 256 0 1 1 512 0A256 256 0 1 1 0 256zm169.8-90.7c7.9-22.3 29.1-37.3 52.8-37.3l58.3 0c34.9 0 63.1 28.3 63.1 63.1c0 22.6-12.1 43.5-31.7 54.8L280 264.4c-.2 13-10.9 23.6-24 23.6c-13.3 0-24-10.7-24-24l0-13.5c0-8.6 4.6-16.5 12.1-20.8l44.3-25.4c4.7-2.7 7.6-7.7 7.6-13.1c0-8.4-6.8-15.1-15.1-15.1l-58.3 0c-3.4 0-6.4 2.1-7.5 5.3l-.4 1.2c-4.4 12.5-18.2 19-30.6 14.6s-19-18.2-14.6-30.6l.4-1.2zM224 352a32 32 0 1 1 64 0 32 32 0 1 1 -64 0z"></path>
</svg>
</button><button class="panzoom-reset panzoom-button">
<svg class="panzoom-icon" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
<path d="M125.7 160l50.3 0c17.7 0 32 14.3 32 32s-14.3 32-32 32L48 224c-17.7 0-32-14.3-32-32L16 64c0-17.7 14.3-32 32-32s32 14.3 32 32l0 51.2L97.6 97.6c87.5-87.5 229.3-87.5 316.8 0s87.5 229.3 0 316.8s-229.3 87.5-316.8 0c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0c62.5 62.5 163.8 62.5 226.3 0s62.5-163.8 0-226.3s-163.8-62.5-226.3 0L125.7 160z"></path>
</svg>
</button><button class="panzoom-max panzoom-button">
<svg class="panzoom-icon" viewBox="0 0 448 512" xmlns="http://www.w3.org/2000/svg">
<path d="M32 32C14.3 32 0 46.3 0 64l0 96c0 17.7 14.3 32 32 32s32-14.3 32-32l0-64 64 0c17.7 0 32-14.3 32-32s-14.3-32-32-32L32 32zM64 352c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 96c0 17.7 14.3 32 32 32l96 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-64 0 0-64zM320 32c-17.7 0-32 14.3-32 32s14.3 32 32 32l64 0 0 64c0 17.7 14.3 32 32 32s32-14.3 32-32l0-96c0-17.7-14.3-32-32-32l-96 0zM448 352c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 64-64 0c-17.7 0-32 14.3-32 32s14.3 32 32 32l96 0c17.7 0 32-14.3 32-32l0-96z"></path>
</svg>
</button><button class="panzoom-min panzoom-button panzoom-hidden">
<svg class="panzoom-icon" viewBox="0 0 448 512" xmlns="http://www.w3.org/2000/svg">
<path d="M160 64c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 64-64 0c-17.7 0-32 14.3-32 32s14.3 32 32 32l96 0c17.7 0 32-14.3 32-32l0-96zM32 320c-17.7 0-32 14.3-32 32s14.3 32 32 32l64 0 0 64c0 17.7 14.3 32 32 32s32-14.3 32-32l0-96c0-17.7-14.3-32-32-32l-96 0zM352 64c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 96c0 17.7 14.3 32 32 32l96 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-64 0 0-64zM320 320c-17.7 0-32 14.3-32 32l0 96c0 17.7 14.3 32 32 32s32-14.3 32-32l0-64 64 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-96 0z"></path>
</svg>
</button>
</nav>
<pre class="mermaid"><code>flowchart TD
    Start([üß¨ Insertion Check]):::start --&gt; Walk[Walk CIGAR left ‚Üí right]
    Walk --&gt; Found{Match block contains anchor?}
    Found --&gt;|No| WindowCheck
    Found --&gt;|Yes| Backward{Anchor at start of block AND prev op is Ins?}
    Backward --&gt;|Yes| BWMatch{Length + seq match? quality-masked}
    BWMatch --&gt;|Yes| BWAlt([üî¥ ALT - backward]):::alt
    BWMatch --&gt;|No| AtEnd
    Backward --&gt;|No| AtEnd{Anchor at end of block?}
    AtEnd --&gt;|No| RefCov[Mark ref coverage]
    AtEnd --&gt;|Yes| NextOp{Next op is Ins?}
    NextOp --&gt;|No| RefCov
    NextOp --&gt;|Yes| Strict{"Length + seq match? (quality-masked)"}
    Strict --&gt;|Yes| StrictAlt([üî¥ ALT - strict]):::alt
    Strict --&gt;|No| RefCov
    RefCov --&gt; WindowCheck

    WindowCheck{Ins within ¬±5bp window?}
    WindowCheck --&gt;|No| Continue[Continue CIGAR walk]
    WindowCheck --&gt;|Yes| S1{"S1: Seq matches? (quality-masked)"}
    S1 --&gt;|No| LenMatch{"Same length?"}
    LenMatch --&gt;|Yes| FlagP3["Flag for Phase 3"]:::fallback
    LenMatch --&gt;|No| Continue
    S1 --&gt;|Yes| S3{S3: Anchor base matches ref?}
    S3 --&gt;|No| Continue
    S3 --&gt;|Yes| S2[S2: Track closest match]
    S2 --&gt; Continue

    Continue --&gt; MoreOps{More CIGAR ops?}
    MoreOps --&gt;|Yes| Walk
    MoreOps --&gt;|No| Eval{Windowed candidate found?}
    Eval --&gt;|Yes| WinAlt([üî¥ ALT - windowed]):::alt
    Eval --&gt;|No| P3Check{"Phase 3 flagged<br>AND ref coverage?"}
    P3Check --&gt;|Yes| Complex([üîÑ check_complex<br>Phase 3 SW]):::fallback
    P3Check --&gt;|No| HasRef{Read covered anchor?}
    HasRef --&gt;|Yes| Ref([‚úÖ REF]):::ref
    HasRef --&gt;|No| Neither([Neither]):::neither

    classDef start fill:#9b59b6,color:#fff,stroke:#7d3c98,stroke-width:2px;
    classDef ref fill:#27ae60,color:#fff,stroke:#1e8449,stroke-width:2px;
    classDef alt fill:#e74c3c,color:#fff,stroke:#c0392b,stroke-width:2px;
    classDef neither fill:#95a5a6,color:#fff,stroke:#7f8c8d,stroke-width:2px;
    classDef fallback fill:#f39c12,color:#fff,stroke:#d68910,stroke-width:2px;
</code></pre>
<div class="panzoom-info-box panzoom-info-box-bottom panzoom-hidden">
Use mouse to pan and zoom
</div>
</div>
<h3 id="windowed-scan-safeguards">Windowed Scan Safeguards<a class="headerlink" href="#windowed-scan-safeguards" title="Permanent link">¬∂</a></h3>
<p>Three layers of validation prevent false-positive windowed matches:</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Safeguard</th>
<th style="text-align: left;">Check</th>
<th style="text-align: left;">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>S1</strong></td>
<td style="text-align: left;">Inserted sequence matches expected ALT bases (quality-masked)</td>
<td style="text-align: left;">Prevents matching unrelated insertions</td>
</tr>
<tr>
<td style="text-align: left;"><strong>S2</strong></td>
<td style="text-align: left;">Closest match wins (minimum distance from anchor)</td>
<td style="text-align: left;">When multiple candidates exist, picks the most likely</td>
</tr>
<tr>
<td style="text-align: left;"><strong>S3</strong></td>
<td style="text-align: left;">Reference base at shifted anchor matches original anchor base</td>
<td style="text-align: left;">Ensures the shifted position is biologically equivalent</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Phase 3 Haplotype Fallback</p>
<p>When the windowed scan finds an insertion that matches in <strong>length</strong> but not <strong>sequence</strong> (e.g., aligner represents the biological event with shifted bases in a repeat), the engine flags <code>has_nearby_length_match</code> and falls back to <code>check_complex</code> for <strong>Smith-Waterman arbitration</strong>. This ensures ambiguous cases are resolved by haplotype comparison rather than strict sequence matching.</p>
</div>
<h3 id="visual-example_1">Visual Example<a class="headerlink" href="#visual-example_1" title="Permanent link">¬∂</a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>Variant: chr1:100 A‚ÜíATG (insertion of TG after anchor A)
<a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a>
<a href="#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a>Reference:     5'‚îÄ ...C  G  A ‚îÄ‚îÄ C  G  T  A... ‚îÄ3'
<a href="#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a>                          99 100  101 102
<a href="#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a>                               ‚ñ≤
<a href="#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a>                          anchor pos
<a href="#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a>
<a href="#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a>Read 1 (ALT, strict):  CIGAR = 5M 2I 5M
<a href="#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a>               5'‚îÄ ...C  G  A [T  G] C  G  T  A... ‚îÄ3'
<a href="#__codelineno-1-10" id="__codelineno-1-10" name="__codelineno-1-10"></a>                               ‚îî‚îÄ‚îÄ‚îò
<a href="#__codelineno-1-11" id="__codelineno-1-11" name="__codelineno-1-11"></a>                          inserted bases at anchor ‚Üí ALT ‚úÖ (strict)
<a href="#__codelineno-1-12" id="__codelineno-1-12" name="__codelineno-1-12"></a>
<a href="#__codelineno-1-13" id="__codelineno-1-13" name="__codelineno-1-13"></a>Read 2 (ALT, windowed): CIGAR = 7M 2I 3M
<a href="#__codelineno-1-14" id="__codelineno-1-14" name="__codelineno-1-14"></a>               5'‚îÄ ...C  G  A  C  G [T  G] T  A... ‚îÄ3'
<a href="#__codelineno-1-15" id="__codelineno-1-15" name="__codelineno-1-15"></a>                                          ‚îî‚îÄ‚îÄ‚îò
<a href="#__codelineno-1-16" id="__codelineno-1-16" name="__codelineno-1-16"></a>                    insertion shifted +2bp, same seq ‚Üí ALT ‚úÖ (windowed)
<a href="#__codelineno-1-17" id="__codelineno-1-17" name="__codelineno-1-17"></a>
<a href="#__codelineno-1-18" id="__codelineno-1-18" name="__codelineno-1-18"></a>Read 3 (REF):  CIGAR = 10M
<a href="#__codelineno-1-19" id="__codelineno-1-19" name="__codelineno-1-19"></a>               5'‚îÄ ...C  G  A  C  G  T  A... ‚îÄ3'
<a href="#__codelineno-1-20" id="__codelineno-1-20" name="__codelineno-1-20"></a>                               ‚Üë
<a href="#__codelineno-1-21" id="__codelineno-1-21" name="__codelineno-1-21"></a>                          no insertion after anchor ‚Üí REF ‚úÖ
</code></pre></div>
<hr>
<h2 id="deletion">Deletion<a class="headerlink" href="#deletion" title="Permanent link">¬∂</a></h2>
<p>Bases deleted after an <strong>anchor</strong> position. Mirrors insertion but looks for <code>Del</code> CIGAR operations.</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Property</th>
<th style="text-align: left;">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">Detection</td>
<td style="text-align: left;"><code>len(REF) &gt; 1 &amp;&amp; len(ALT) == 1</code></td>
</tr>
<tr>
<td style="text-align: left;">Position</td>
<td style="text-align: left;">0-based index of the <strong>anchor</strong> base</td>
</tr>
<tr>
<td style="text-align: left;">Quality check</td>
<td style="text-align: left;">Quality-masked ref-context comparison</td>
</tr>
</tbody>
</table>
<h3 id="algorithm_2">Algorithm<a class="headerlink" href="#algorithm_2" title="Permanent link">¬∂</a></h3>
<p>Same single-walk strategy as insertion, with three additional features:</p>
<ol>
<li>
<p><strong>Reciprocal overlap matching</strong> ‚Äî For large deletions (‚â•50bp), if the CIGAR shows a deletion at the anchor but with a different length, py-gbcms accepts it if the reciprocal overlap is ‚â•50% (SV-caller standard, used by SURVIVOR):</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a>reciprocal_overlap = min(expected, found) / max(expected, found)
<a href="#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a>Accept if expected_del ‚â• 50bp AND reciprocal_overlap ‚â• 0.50
</code></pre></div>
</li>
<li>
<p><strong>Interior REF guard</strong> ‚Äî For large deletions (‚â•50bp), reads that start <em>inside</em> the deleted region are classified as REF directly, without falling back to Smith-Waterman. This prevents overcounting caused by the SW aligner's bias toward shorter ALT haplotypes.</p>
</li>
<li>
<p><strong>Haplotype fallback</strong> ‚Äî When no CIGAR match is found and the read doesn't cover the anchor, falls back to <code>check_complex</code> for haplotype-based comparison.</p>
</li>
</ol>
<div class="panzoom-box" data-key="none" id="panzoom0" oncontextmenu="return false;">
<nav class="panzoom-nav">
<button class="panzoom-info panzoom-button">
<svg class="panzoom-icon" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
<path d="M464 256A208 208 0 1 0 48 256a208 208 0 1 0 416 0zM0 256a256 256 0 1 1 512 0A256 256 0 1 1 0 256zm169.8-90.7c7.9-22.3 29.1-37.3 52.8-37.3l58.3 0c34.9 0 63.1 28.3 63.1 63.1c0 22.6-12.1 43.5-31.7 54.8L280 264.4c-.2 13-10.9 23.6-24 23.6c-13.3 0-24-10.7-24-24l0-13.5c0-8.6 4.6-16.5 12.1-20.8l44.3-25.4c4.7-2.7 7.6-7.7 7.6-13.1c0-8.4-6.8-15.1-15.1-15.1l-58.3 0c-3.4 0-6.4 2.1-7.5 5.3l-.4 1.2c-4.4 12.5-18.2 19-30.6 14.6s-19-18.2-14.6-30.6l.4-1.2zM224 352a32 32 0 1 1 64 0 32 32 0 1 1 -64 0z"></path>
</svg>
</button><button class="panzoom-reset panzoom-button">
<svg class="panzoom-icon" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
<path d="M125.7 160l50.3 0c17.7 0 32 14.3 32 32s-14.3 32-32 32L48 224c-17.7 0-32-14.3-32-32L16 64c0-17.7 14.3-32 32-32s32 14.3 32 32l0 51.2L97.6 97.6c87.5-87.5 229.3-87.5 316.8 0s87.5 229.3 0 316.8s-229.3 87.5-316.8 0c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0c62.5 62.5 163.8 62.5 226.3 0s62.5-163.8 0-226.3s-163.8-62.5-226.3 0L125.7 160z"></path>
</svg>
</button><button class="panzoom-max panzoom-button">
<svg class="panzoom-icon" viewBox="0 0 448 512" xmlns="http://www.w3.org/2000/svg">
<path d="M32 32C14.3 32 0 46.3 0 64l0 96c0 17.7 14.3 32 32 32s32-14.3 32-32l0-64 64 0c17.7 0 32-14.3 32-32s-14.3-32-32-32L32 32zM64 352c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 96c0 17.7 14.3 32 32 32l96 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-64 0 0-64zM320 32c-17.7 0-32 14.3-32 32s14.3 32 32 32l64 0 0 64c0 17.7 14.3 32 32 32s32-14.3 32-32l0-96c0-17.7-14.3-32-32-32l-96 0zM448 352c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 64-64 0c-17.7 0-32 14.3-32 32s14.3 32 32 32l96 0c17.7 0 32-14.3 32-32l0-96z"></path>
</svg>
</button><button class="panzoom-min panzoom-button panzoom-hidden">
<svg class="panzoom-icon" viewBox="0 0 448 512" xmlns="http://www.w3.org/2000/svg">
<path d="M160 64c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 64-64 0c-17.7 0-32 14.3-32 32s14.3 32 32 32l96 0c17.7 0 32-14.3 32-32l0-96zM32 320c-17.7 0-32 14.3-32 32s14.3 32 32 32l64 0 0 64c0 17.7 14.3 32 32 32s32-14.3 32-32l0-96c0-17.7-14.3-32-32-32l-96 0zM352 64c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 96c0 17.7 14.3 32 32 32l96 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-64 0 0-64zM320 320c-17.7 0-32 14.3-32 32l0 96c0 17.7 14.3 32 32 32s32-14.3 32-32l0-64 64 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-96 0z"></path>
</svg>
</button>
</nav>
<pre class="mermaid"><code>flowchart TD
    Start([üß¨ Deletion Check]):::start --&gt; Walk[Walk CIGAR left ‚Üí right]
    Walk --&gt; Found{Match block contains anchor?}
    Found --&gt;|No| WindowCheck
    Found --&gt;|Yes| AtEnd{Anchor at end of block?}
    AtEnd --&gt;|No| RefCov[Mark ref coverage]
    AtEnd --&gt;|Yes| NextOp{Next op is Del?}
    NextOp --&gt;|No| RefCov
    NextOp --&gt;|Yes| LenCheck{Length matches?}
    LenCheck --&gt;|Yes| StrictAlt([üî¥ ALT - strict]):::alt
    LenCheck --&gt;|No| RecipCheck{"‚â•50bp AND overlap ‚â•50%?"}
    RecipCheck --&gt;|Yes| TolAlt([üî¥ ALT - tolerant]):::alt
    RecipCheck --&gt;|No| Fallback1([üîÑ check_complex]):::fallback
    RefCov --&gt; WindowCheck

    WindowCheck{Del within ¬±5bp window?}
    WindowCheck --&gt;|No| Continue[Continue walk]
    WindowCheck --&gt;|Yes| S1{S1: Length check}
    S1 --&gt;|Match| S3{"S3: Ref bases match?"}
    S1 --&gt;|"‚â•50bp + overlap ‚â•50%"| S2Track[S2: Track closest]
    S1 --&gt;|No match| Continue
    S3 --&gt;|Yes| S2[S2: Track closest]
    S3 --&gt;|No| Continue
    S2Track --&gt; Continue
    S2 --&gt; Continue

    Continue --&gt; MoreOps{More ops?}
    MoreOps --&gt;|Yes| Walk
    MoreOps --&gt;|No| Eval{Windowed match?}
    Eval --&gt;|Yes| WinAlt([üî¥ ALT]):::alt
    Eval --&gt;|No| Interior{"Interior read?<br>(‚â•50bp del, read starts inside span)"}
    Interior --&gt;|Yes| IntRef([‚úÖ REF - interior]):::ref
    Interior --&gt;|No| HasRef{Anchor covered?}
    HasRef --&gt;|Yes| Ref([‚úÖ REF]):::ref
    HasRef --&gt;|No| Fallback2([üîÑ check_complex]):::fallback

    classDef start fill:#9b59b6,color:#fff,stroke:#7d3c98,stroke-width:2px;
    classDef ref fill:#27ae60,color:#fff,stroke:#1e8449,stroke-width:2px;
    classDef alt fill:#e74c3c,color:#fff,stroke:#c0392b,stroke-width:2px;
    classDef neither fill:#95a5a6,color:#fff,stroke:#7f8c8d,stroke-width:2px;
    classDef fallback fill:#f39c12,color:#fff,stroke:#d68910,stroke-width:2px;
</code></pre>
<div class="panzoom-info-box panzoom-info-box-bottom panzoom-hidden">
Use mouse to pan and zoom
</div>
</div>
<div class="admonition warning">
<p class="admonition-title">Interior REF Guard</p>
<p>For deletions &gt;50bp, reads that fall <strong>entirely within</strong> the deleted region would be incorrectly classified as ALT by Smith-Waterman (because the short ALT haplotype aligns better than the long REF haplotype). The interior REF guard catches these reads early and classifies them as REF before they reach Phase 3.</p>
</div>
<h3 id="visual-example_2">Visual Example<a class="headerlink" href="#visual-example_2" title="Permanent link">¬∂</a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a>Variant: chr1:100 ACG‚ÜíA (deletion of CG after anchor A)
<a href="#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a>
<a href="#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a>Reference:     5'‚îÄ ...T  G  A  C  G  T  A  C... ‚îÄ3'
<a href="#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a>                          99 100 101 102
<a href="#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a>                               ‚ñ≤
<a href="#__codelineno-3-6" id="__codelineno-3-6" name="__codelineno-3-6"></a>                          anchor pos
<a href="#__codelineno-3-7" id="__codelineno-3-7" name="__codelineno-3-7"></a>
<a href="#__codelineno-3-8" id="__codelineno-3-8" name="__codelineno-3-8"></a>Read 1 (ALT, strict):  CIGAR = 5M 2D 5M
<a href="#__codelineno-3-9" id="__codelineno-3-9" name="__codelineno-3-9"></a>               5'‚îÄ ...T  G  A  ‚îÄ‚îÄ  ‚îÄ‚îÄ  T  A  C... ‚îÄ3'
<a href="#__codelineno-3-10" id="__codelineno-3-10" name="__codelineno-3-10"></a>                               ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
<a href="#__codelineno-3-11" id="__codelineno-3-11" name="__codelineno-3-11"></a>                          2bp deletion at anchor ‚Üí ALT ‚úÖ (strict)
<a href="#__codelineno-3-12" id="__codelineno-3-12" name="__codelineno-3-12"></a>
<a href="#__codelineno-3-13" id="__codelineno-3-13" name="__codelineno-3-13"></a>Read 2 (ALT, windowed): CIGAR = 7M 2D 3M
<a href="#__codelineno-3-14" id="__codelineno-3-14" name="__codelineno-3-14"></a>               5'‚îÄ ...T  G  A  C  G  T  ‚îÄ‚îÄ  ‚îÄ‚îÄ  A  C... ‚îÄ3'
<a href="#__codelineno-3-15" id="__codelineno-3-15" name="__codelineno-3-15"></a>                                              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
<a href="#__codelineno-3-16" id="__codelineno-3-16" name="__codelineno-3-16"></a>                  deletion shifted +2bp, same length, ref matches ‚Üí ALT ‚úÖ (windowed)
<a href="#__codelineno-3-17" id="__codelineno-3-17" name="__codelineno-3-17"></a>
<a href="#__codelineno-3-18" id="__codelineno-3-18" name="__codelineno-3-18"></a>Read 3 (REF):  CIGAR = 12M
<a href="#__codelineno-3-19" id="__codelineno-3-19" name="__codelineno-3-19"></a>               5'‚îÄ ...T  G  A  C  G  T  A  C... ‚îÄ3'
<a href="#__codelineno-3-20" id="__codelineno-3-20" name="__codelineno-3-20"></a>                               ‚Üë
<a href="#__codelineno-3-21" id="__codelineno-3-21" name="__codelineno-3-21"></a>                          no deletion after anchor ‚Üí REF ‚úÖ
</code></pre></div>
<hr>
<h2 id="mnp-multi-nucleotide-polymorphism">MNP (Multi-Nucleotide Polymorphism)<a class="headerlink" href="#mnp-multi-nucleotide-polymorphism" title="Permanent link">¬∂</a></h2>
<p>Multiple adjacent bases substituted simultaneously.</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Property</th>
<th style="text-align: left;">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">Detection</td>
<td style="text-align: left;"><code>len(REF) == len(ALT) &amp;&amp; len(REF) &gt; 1</code></td>
</tr>
<tr>
<td style="text-align: left;">Position</td>
<td style="text-align: left;">0-based index of the first substituted base</td>
</tr>
<tr>
<td style="text-align: left;">Quality check</td>
<td style="text-align: left;"><strong>Every</strong> base in the MNP region must meet <code>--min-baseq</code></td>
</tr>
</tbody>
</table>
<h3 id="algorithm_3">Algorithm<a class="headerlink" href="#algorithm_3" title="Permanent link">¬∂</a></h3>
<div class="panzoom-box" data-key="none" id="panzoom0" oncontextmenu="return false;">
<nav class="panzoom-nav">
<button class="panzoom-info panzoom-button">
<svg class="panzoom-icon" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
<path d="M464 256A208 208 0 1 0 48 256a208 208 0 1 0 416 0zM0 256a256 256 0 1 1 512 0A256 256 0 1 1 0 256zm169.8-90.7c7.9-22.3 29.1-37.3 52.8-37.3l58.3 0c34.9 0 63.1 28.3 63.1 63.1c0 22.6-12.1 43.5-31.7 54.8L280 264.4c-.2 13-10.9 23.6-24 23.6c-13.3 0-24-10.7-24-24l0-13.5c0-8.6 4.6-16.5 12.1-20.8l44.3-25.4c4.7-2.7 7.6-7.7 7.6-13.1c0-8.4-6.8-15.1-15.1-15.1l-58.3 0c-3.4 0-6.4 2.1-7.5 5.3l-.4 1.2c-4.4 12.5-18.2 19-30.6 14.6s-19-18.2-14.6-30.6l.4-1.2zM224 352a32 32 0 1 1 64 0 32 32 0 1 1 -64 0z"></path>
</svg>
</button><button class="panzoom-reset panzoom-button">
<svg class="panzoom-icon" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
<path d="M125.7 160l50.3 0c17.7 0 32 14.3 32 32s-14.3 32-32 32L48 224c-17.7 0-32-14.3-32-32L16 64c0-17.7 14.3-32 32-32s32 14.3 32 32l0 51.2L97.6 97.6c87.5-87.5 229.3-87.5 316.8 0s87.5 229.3 0 316.8s-229.3 87.5-316.8 0c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0c62.5 62.5 163.8 62.5 226.3 0s62.5-163.8 0-226.3s-163.8-62.5-226.3 0L125.7 160z"></path>
</svg>
</button><button class="panzoom-max panzoom-button">
<svg class="panzoom-icon" viewBox="0 0 448 512" xmlns="http://www.w3.org/2000/svg">
<path d="M32 32C14.3 32 0 46.3 0 64l0 96c0 17.7 14.3 32 32 32s32-14.3 32-32l0-64 64 0c17.7 0 32-14.3 32-32s-14.3-32-32-32L32 32zM64 352c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 96c0 17.7 14.3 32 32 32l96 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-64 0 0-64zM320 32c-17.7 0-32 14.3-32 32s14.3 32 32 32l64 0 0 64c0 17.7 14.3 32 32 32s32-14.3 32-32l0-96c0-17.7-14.3-32-32-32l-96 0zM448 352c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 64-64 0c-17.7 0-32 14.3-32 32s14.3 32 32 32l96 0c17.7 0 32-14.3 32-32l0-96z"></path>
</svg>
</button><button class="panzoom-min panzoom-button panzoom-hidden">
<svg class="panzoom-icon" viewBox="0 0 448 512" xmlns="http://www.w3.org/2000/svg">
<path d="M160 64c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 64-64 0c-17.7 0-32 14.3-32 32s14.3 32 32 32l96 0c17.7 0 32-14.3 32-32l0-96zM32 320c-17.7 0-32 14.3-32 32s14.3 32 32 32l64 0 0 64c0 17.7 14.3 32 32 32s32-14.3 32-32l0-96c0-17.7-14.3-32-32-32l-96 0zM352 64c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 96c0 17.7 14.3 32 32 32l96 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-64 0 0-64zM320 320c-17.7 0-32 14.3-32 32l0 96c0 17.7 14.3 32 32 32s32-14.3 32-32l0-64 64 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-96 0z"></path>
</svg>
</button>
</nav>
<pre class="mermaid"><code>flowchart TD
    Start([üß¨ MNP Check]):::start --&gt; Find[Find read position of first base]
    Find --&gt; Found{Position found?}
    Found --&gt;|No| Fallback1([Fallback ‚Üí check_complex]):::fallback
    Found --&gt;|Yes| Cover{Read covers entire MNP region?}
    Cover --&gt;|No| Fallback2([Fallback ‚Üí check_complex]):::fallback
    Cover --&gt;|Yes| Loop[For each position in MNP region]

    subgraph PerBase [Per-Base Validation]
        direction TB
        BQ{Base quality ‚â• min_baseq?}
        Track[Compare base to REF and ALT]
        More{More positions?}
    end

    Loop --&gt; BQ
    BQ --&gt;|No| Fallback3([Fallback ‚Üí check_complex]):::fallback
    BQ --&gt;|Yes| Track
    Track --&gt; More
    More --&gt;|Yes| BQ
    More --&gt;|No| Contig{No indels within MNP region?}

    Contig --&gt;|Indel found| Fallback4([Fallback ‚Üí check_complex]):::fallback
    Contig --&gt;|Contiguous| Final{All bases match?}
    Final --&gt;|All match ALT| Alt([üî¥ ALT]):::alt
    Final --&gt;|All match REF| Ref([‚úÖ REF]):::ref
    Final --&gt;|Mixed| Fallback5([Fallback ‚Üí check_complex]):::fallback

    classDef start fill:#9b59b6,color:#fff,stroke:#7d3c98,stroke-width:2px;
    classDef ref fill:#27ae60,color:#fff,stroke:#1e8449,stroke-width:2px;
    classDef alt fill:#e74c3c,color:#fff,stroke:#c0392b,stroke-width:2px;
    classDef fallback fill:#f39c12,color:#fff,stroke:#e67e22,stroke-width:2px;
</code></pre>
<div class="panzoom-info-box panzoom-info-box-bottom panzoom-hidden">
Use mouse to pan and zoom
</div>
</div>
<div class="admonition info">
<p class="admonition-title">Strict Matching with Complex Fallback</p>
<p>MNP strict matching is <strong>all-or-nothing</strong>: every base must match either REF or ALT. A read with <code>C T</code> at a <code>AT‚ÜíCG</code> variant (first base matches ALT, second matches REF) is <strong>inconclusive</strong> in the strict check. However, instead of being discarded, the read <strong>falls back to <code>check_complex</code></strong> (Phase 2 quality-masked comparison ‚Üí Phase 2.5 edit distance ‚Üí Phase 3 local SW). This prevents sensitivity loss in noisy samples (<abbr title="Circulating tumor DNA - Tumor-derived cfDNA fragments">ctDNA</abbr>, FFPE) where a single low-quality base would otherwise reject the entire read.</p>
</div>
<h3 id="contiguity-check">Contiguity Check<a class="headerlink" href="#contiguity-check" title="Permanent link">¬∂</a></h3>
<p>After checking all bases, py-gbcms verifies that no <strong>indels</strong> exist within the MNP region by comparing the read positions of the first and last MNP base. If the distance doesn't equal <code>len - 1</code>, an insertion or deletion interrupted the MNP ‚Üí classified as <strong>neither</strong>.</p>
<hr>
<h2 id="complex-indel-substitution">Complex (Indel + Substitution)<a class="headerlink" href="#complex-indel-substitution" title="Permanent link">¬∂</a></h2>
<p>Variants where REF and ALT differ in both sequence <strong>and</strong> length. Uses a sophisticated <strong>three-phase</strong> algorithm with quality-aware matching and Smith-Waterman fallback.</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Property</th>
<th style="text-align: left;">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">Detection</td>
<td style="text-align: left;">Fallback for all other combinations</td>
</tr>
<tr>
<td style="text-align: left;">Position</td>
<td style="text-align: left;">0-based index of the first reference base</td>
</tr>
<tr>
<td style="text-align: left;">Quality check</td>
<td style="text-align: left;">Masked comparison ‚Äî bases below <code>--min-baseq</code> are masked</td>
</tr>
</tbody>
</table>
<h3 id="three-phase-algorithm">Three-Phase Algorithm<a class="headerlink" href="#three-phase-algorithm" title="Permanent link">¬∂</a></h3>
<div class="panzoom-box" data-key="none" id="panzoom0" oncontextmenu="return false;">
<nav class="panzoom-nav">
<button class="panzoom-info panzoom-button">
<svg class="panzoom-icon" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
<path d="M464 256A208 208 0 1 0 48 256a208 208 0 1 0 416 0zM0 256a256 256 0 1 1 512 0A256 256 0 1 1 0 256zm169.8-90.7c7.9-22.3 29.1-37.3 52.8-37.3l58.3 0c34.9 0 63.1 28.3 63.1 63.1c0 22.6-12.1 43.5-31.7 54.8L280 264.4c-.2 13-10.9 23.6-24 23.6c-13.3 0-24-10.7-24-24l0-13.5c0-8.6 4.6-16.5 12.1-20.8l44.3-25.4c4.7-2.7 7.6-7.7 7.6-13.1c0-8.4-6.8-15.1-15.1-15.1l-58.3 0c-3.4 0-6.4 2.1-7.5 5.3l-.4 1.2c-4.4 12.5-18.2 19-30.6 14.6s-19-18.2-14.6-30.6l.4-1.2zM224 352a32 32 0 1 1 64 0 32 32 0 1 1 -64 0z"></path>
</svg>
</button><button class="panzoom-reset panzoom-button">
<svg class="panzoom-icon" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
<path d="M125.7 160l50.3 0c17.7 0 32 14.3 32 32s-14.3 32-32 32L48 224c-17.7 0-32-14.3-32-32L16 64c0-17.7 14.3-32 32-32s32 14.3 32 32l0 51.2L97.6 97.6c87.5-87.5 229.3-87.5 316.8 0s87.5 229.3 0 316.8s-229.3 87.5-316.8 0c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0c62.5 62.5 163.8 62.5 226.3 0s62.5-163.8 0-226.3s-163.8-62.5-226.3 0L125.7 160z"></path>
</svg>
</button><button class="panzoom-max panzoom-button">
<svg class="panzoom-icon" viewBox="0 0 448 512" xmlns="http://www.w3.org/2000/svg">
<path d="M32 32C14.3 32 0 46.3 0 64l0 96c0 17.7 14.3 32 32 32s32-14.3 32-32l0-64 64 0c17.7 0 32-14.3 32-32s-14.3-32-32-32L32 32zM64 352c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 96c0 17.7 14.3 32 32 32l96 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-64 0 0-64zM320 32c-17.7 0-32 14.3-32 32s14.3 32 32 32l64 0 0 64c0 17.7 14.3 32 32 32s32-14.3 32-32l0-96c0-17.7-14.3-32-32-32l-96 0zM448 352c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 64-64 0c-17.7 0-32 14.3-32 32s14.3 32 32 32l96 0c17.7 0 32-14.3 32-32l0-96z"></path>
</svg>
</button><button class="panzoom-min panzoom-button panzoom-hidden">
<svg class="panzoom-icon" viewBox="0 0 448 512" xmlns="http://www.w3.org/2000/svg">
<path d="M160 64c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 64-64 0c-17.7 0-32 14.3-32 32s14.3 32 32 32l96 0c17.7 0 32-14.3 32-32l0-96zM32 320c-17.7 0-32 14.3-32 32s14.3 32 32 32l64 0 0 64c0 17.7 14.3 32 32 32s32-14.3 32-32l0-96c0-17.7-14.3-32-32-32l-96 0zM352 64c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 96c0 17.7 14.3 32 32 32l96 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-64 0 0-64zM320 320c-17.7 0-32 14.3-32 32l0 96c0 17.7 14.3 32 32 32s32-14.3 32-32l0-64 64 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-96 0z"></path>
</svg>
</button>
</nav>
<pre class="mermaid"><code>flowchart TD
    Start([üß¨ Complex Check]):::start
    Start --&gt; Phase1

    subgraph Phase1 [Phase 1: Haplotype Reconstruction]
        direction TB
        Walk[Walk CIGAR to reconstruct<br>read sequence for variant region]
        Walk --&gt; Ops{CIGAR op type?}
        Ops --&gt;|M/=/X| Match[Append overlapping bases + quals]
        Ops --&gt;|I| Ins[Append inserted bases + quals]
        Ops --&gt;|D/N| Del[Advance ref_pos only]
        Ops --&gt;|S| SC{Overlaps variant?}
        SC --&gt;|Yes| SCAdd[Append soft-clipped bases]
        SC --&gt;|No| SCSkip[Skip]
    end

    Phase1 --&gt; LargeGuard{"ref_len &gt; 50 AND<br>recon &lt; 10% of ref?"}
    LargeGuard --&gt;|Yes| SkipP2[Skip Phase 2<br>unreliable]:::neither
    LargeGuard --&gt;|No| Phase2

    subgraph Phase2 ["Phase 2: Masked Comparison"]
        direction TB
        LenCheck{Recon length matches?}
        LenCheck --&gt;|"ALT and REF"| CaseA["Case A: Dual compare<br>+ ambiguity detection"]
        LenCheck --&gt;|"ALT only"| CaseB["Case B: ALT-only compare"]
        LenCheck --&gt;|"REF only"| CaseC["Case C: REF-only compare"]
        LenCheck --&gt;|Neither| NoMatch[No match]
    end

    CaseA --&gt; Ambig{"Reliable bases<br>match BOTH?"}
    Ambig --&gt;|Yes| Neither1([Neither - ambiguous]):::neither
    Ambig --&gt;|No| Matches

    Matches{Which allele matches?}
    Matches --&gt;|ALT| Alt1([üî¥ ALT]):::alt
    Matches --&gt;|REF| Ref1([‚úÖ REF]):::ref
    Matches --&gt;|Neither| NoMatch

    CaseB --&gt; AltMatch{"0 mismatches on<br>reliable bases?"}
    AltMatch --&gt;|Yes| Alt2([üî¥ ALT]):::alt
    AltMatch --&gt;|No| NoMatch

    CaseC --&gt; RefMatch{"0 mismatches on<br>reliable bases?"}
    RefMatch --&gt;|Yes| Ref2([‚úÖ REF]):::ref
    RefMatch --&gt;|No| NoMatch

    SkipP2 --&gt; Phase25
    NoMatch --&gt; Phase25

    subgraph Phase25 ["Phase 2.5: Edit Distance"]
        direction TB
        ReconLen{"recon_len ‚â• 2?"}
        ReconLen --&gt;|No| SkipED[Skip to Phase 3]
        ReconLen --&gt;|Yes| EditDist["Compute Levenshtein distance<br>to REF and ALT alleles"]
        EditDist --&gt; EDMargin{"&gt;1 edit margin?"}
        EDMargin --&gt;|"ALT closer"| Alt25([üî¥ ALT]):::alt
        EDMargin --&gt;|"REF closer"| Ref25([‚úÖ REF]):::ref
        EDMargin --&gt;|"Ambiguous"| SkipED
    end

    SkipED --&gt; Phase3

    subgraph Phase3 ["Phase 3: Smith-Waterman Fallback"]
        direction TB
        PreFilter{"is_worth_realignment?<br>(indels/clips near window)"}
        PreFilter --&gt;|No| Neither2([Neither]):::neither
        PreFilter --&gt;|Yes| Extract[Extract raw read window]
        Extract --&gt; SW["Semiglobal SW alignment<br>vs REF and ALT haplotypes"]
        SW --&gt; Margin{"Score difference ‚â• 2?"}
        Margin --&gt;|"Confident call"| ConfCheck
        Margin --&gt;|"Within margin"| Neither3([Neither]):::neither

        ConfCheck{"Dual trigger?<br>(borderline OR poor)"}
        ConfCheck --&gt;|"No"| ConfResult
        ConfCheck --&gt;|"Yes"| LocalSW["Local SW alignment<br>(soft-clips bad flanks)"]
        LocalSW --&gt; LocalMargin{"Score difference ‚â• 2?"}
        LocalMargin --&gt;|ALT wins| Alt3b([üî¥ ALT]):::alt
        LocalMargin --&gt;|REF wins| Ref3b([‚úÖ REF]):::ref
        LocalMargin --&gt;|"Within margin"| Neither4([Neither]):::neither

        ConfResult{Which allele wins?}
        ConfResult --&gt;|ALT| Alt3([üî¥ ALT]):::alt
        ConfResult --&gt;|REF| Ref3([‚úÖ REF]):::ref
    end

    classDef start fill:#9b59b6,color:#fff,stroke:#7d3c98,stroke-width:2px;
    classDef ref fill:#27ae60,color:#fff,stroke:#1e8449,stroke-width:2px;
    classDef alt fill:#e74c3c,color:#fff,stroke:#c0392b,stroke-width:2px;
    classDef neither fill:#95a5a6,color:#fff,stroke:#7f8c8d,stroke-width:2px;
</code></pre>
<div class="panzoom-info-box panzoom-info-box-bottom panzoom-hidden">
Use mouse to pan and zoom
</div>
</div>
<h3 id="phase-1-haplotype-reconstruction">Phase 1: Haplotype Reconstruction<a class="headerlink" href="#phase-1-haplotype-reconstruction" title="Permanent link">¬∂</a></h3>
<p>Walks the CIGAR to rebuild what the read shows for the genomic region <code>[pos, pos + ref_len)</code>. Each CIGAR operation contributes differently:</p>
<table>
<thead>
<tr>
<th style="text-align: left;">CIGAR Op</th>
<th style="text-align: left;">Action</th>
<th style="text-align: left;">Example</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">M / = / X</td>
<td style="text-align: left;">Append overlapping bases and qualities</td>
<td style="text-align: left;">Standard aligned bases</td>
</tr>
<tr>
<td style="text-align: left;">I</td>
<td style="text-align: left;">Append inserted bases if <code>ref_pos</code> is within variant region</td>
<td style="text-align: left;">Captures insertions</td>
</tr>
<tr>
<td style="text-align: left;">D / N</td>
<td style="text-align: left;">Advance <code>ref_pos</code> without appending</td>
<td style="text-align: left;">Deletions skip</td>
</tr>
<tr>
<td style="text-align: left;">S</td>
<td style="text-align: left;">Append if <code>ref_pos</code> overlaps variant window</td>
<td style="text-align: left;">Recovers soft-clipped evidence</td>
</tr>
<tr>
<td style="text-align: left;">H / P</td>
<td style="text-align: left;">No action</td>
<td style="text-align: left;">Hard clips have no sequence</td>
</tr>
</tbody>
</table>
<h3 id="phase-2-masked-comparison">Phase 2: Masked Comparison<a class="headerlink" href="#phase-2-masked-comparison" title="Permanent link">¬∂</a></h3>
<p>Instead of exact matching, bases with quality below <code>--min-baseq</code> are <strong>masked out</strong> ‚Äî they cannot vote for either allele. Three cases based on reconstructed sequence length:</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Case</th>
<th style="text-align: left;">Condition</th>
<th style="text-align: left;">Behavior</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>A</strong></td>
<td style="text-align: left;"><code>recon == alt == ref</code> length</td>
<td style="text-align: left;">Dual compare + ambiguity detection</td>
</tr>
<tr>
<td style="text-align: left;"><strong>B</strong></td>
<td style="text-align: left;"><code>recon == alt</code> length only</td>
<td style="text-align: left;">ALT-only masked compare</td>
</tr>
<tr>
<td style="text-align: left;"><strong>C</strong></td>
<td style="text-align: left;"><code>recon == ref</code> length only</td>
<td style="text-align: left;">REF-only masked compare</td>
</tr>
</tbody>
</table>
<div class="admonition important">
<p class="admonition-title">Ambiguity Detection (Case A)</p>
<p>When reliable bases match <strong>both</strong> REF and ALT (possible when they differ only at masked positions), the read is discarded rather than guessed. This prevents false calls at positions where low-quality bases happen to match one allele.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Large-REF Guard</p>
<p>For variants with REF &gt;50bp, if the reconstruction is &lt;10% of the REF length (e.g., 1bp recon for a 1024bp deletion), Phase 2 is skipped entirely. A tiny reconstruction would trivially match a short ALT allele, causing overcounting. Phase 3 SW handles these correctly.</p>
</div>
<h3 id="phase-25-edit-distance">Phase 2.5: Edit Distance<a class="headerlink" href="#phase-25-edit-distance" title="Permanent link">¬∂</a></h3>
<p>When Phase 2's strict length comparison fails (Case A/B/C don't match), py-gbcms measures the <strong>Levenshtein edit distance</strong> between the reconstruction and each allele. This catches cases where the reconstruction is off by 1-2 bases due to an incomplete variant definition:</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Parameter</th>
<th style="text-align: left;">Value</th>
<th style="text-align: left;">Rationale</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">Margin</td>
<td style="text-align: left;">&gt;1 edit</td>
<td style="text-align: left;">Prevents noise on very short strings</td>
</tr>
<tr>
<td style="text-align: left;">Min recon length</td>
<td style="text-align: left;">2 bases</td>
<td style="text-align: left;">Single-base reconstructions are too short for reliable edit distance</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Phase 2.5 is Supplementary</p>
<p>Phase 2.5 helps edge cases with longer reconstructions. For variants like EPHA7 where the strict reconstruction is only 1bp (<code>"C"</code>), the <code>recon_len &gt;= 2</code> guard skips Phase 2.5 entirely ‚Äî the fix comes from Phase 3's local fallback instead.</p>
</div>
<h3 id="phase-3-smith-waterman-fallback">Phase 3: Smith-Waterman Fallback<a class="headerlink" href="#phase-3-smith-waterman-fallback" title="Permanent link">¬∂</a></h3>
<p>When Phase 2 and Phase 2.5 both fail, the engine expands to the full <code>ref_context</code> window and performs <strong>dual-haplotype Smith-Waterman alignment</strong> (inspired by <a href="https://doi.org/10.1093/bioinformatics/btab601">indelpost</a>):</p>
<ol>
<li><strong>Build haplotypes</strong>: <code>REF_hap = left_ctx + REF + right_ctx</code>, <code>ALT_hap = left_ctx + ALT + right_ctx</code></li>
<li><strong>Mask</strong>: Replace low-quality bases with <code>N</code> (scores 0 against any base)</li>
<li><strong>Align</strong>: Semiglobal alignment ‚Äî read (query) is fully consumed, haplotype (text) has free overhangs</li>
<li><strong>Score</strong>: ALT wins if <code>alt_score ‚â• ref_score + 2</code>; REF wins if <code>ref_score ‚â• alt_score + 2</code></li>
<li><strong>Dual-trigger check</strong>: For indel/complex variants, if the semiglobal result is low-confidence, retry with local alignment</li>
</ol>
<table>
<thead>
<tr>
<th style="text-align: left;">Parameter</th>
<th style="text-align: left;">Value</th>
<th style="text-align: left;">Rationale</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">Scoring</td>
<td style="text-align: left;">+1 match, ‚àí1 mismatch</td>
<td style="text-align: left;">Standard</td>
</tr>
<tr>
<td style="text-align: left;">N vs anything</td>
<td style="text-align: left;">0</td>
<td style="text-align: left;">Low-quality bases don't bias</td>
</tr>
<tr>
<td style="text-align: left;">Gap open</td>
<td style="text-align: left;">‚àí5</td>
<td style="text-align: left;">Affine gap penalties</td>
</tr>
<tr>
<td style="text-align: left;">Gap extend</td>
<td style="text-align: left;">‚àí1</td>
<td style="text-align: left;">Affine gap penalties</td>
</tr>
<tr>
<td style="text-align: left;">Score margin</td>
<td style="text-align: left;">‚â•2</td>
<td style="text-align: left;">Prevents ambiguous calls</td>
</tr>
<tr>
<td style="text-align: left;">Min usable bases</td>
<td style="text-align: left;">3</td>
<td style="text-align: left;">Reads with &lt;3 usable bases are skipped</td>
</tr>
</tbody>
</table>
<h4 id="dual-trigger-local-fallback">Dual-Trigger Local Fallback<a class="headerlink" href="#dual-trigger-local-fallback" title="Permanent link">¬∂</a></h4>
<p>For <strong>complex variants</strong> (both alleles &gt; 1bp with different lengths), semiglobal alignment can produce confident but incorrect calls when the <abbr title="Mutation Annotation Format - Standard mutation annotation file format">MAF</abbr>/<abbr title="Variant Call Format - Standard variant call file format">VCF</abbr> definition is incomplete (e.g., a complex variant missing an adjacent SNV). The ALT haplotype then has a "frameshifted flank" ‚Äî right-context bases that don't match the biological read. Semiglobal forces gap penalties through this invalid flank.</p>
<blockquote>
<p>[!NOTE]
The dual-trigger only applies to <strong>complex</strong> variants (e.g., <code>TCC‚ÜíCT</code>, <code>ATGA‚ÜíCATG</code>), not to pure insertions or deletions. Pure indels are well-handled by semiglobal alignment, and applying local fallback would risk false positives in homopolymer regions.</p>
</blockquote>
<p>Two conditions detect low-confidence semiglobal results:</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Trigger</th>
<th style="text-align: left;">Condition</th>
<th style="text-align: left;">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Borderline</strong></td>
<td style="text-align: left;"><code>abs(alt_score - ref_score) ‚â§ margin + 1</code></td>
<td style="text-align: left;">Score difference barely decisive</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Poor quality</strong></td>
<td style="text-align: left;"><code>max(scores) &lt; read_len / 2</code></td>
<td style="text-align: left;">Both haplotypes heavily penalized</td>
</tr>
</tbody>
</table>
<p>When <strong>either</strong> trigger fires, the engine retries with <strong>local alignment</strong> (<code>Aligner::local()</code>), which soft-clips the bad flank and finds the best matching substring without penalizing overhangs on either side.</p>
<div class="admonition tip">
<p class="admonition-title">Performance: Pre-Filter</p>
<p>To avoid expensive O(n√óm) alignment on clean REF reads (~80-90% at any locus), <code>is_worth_realignment()</code> checks if the read has soft-clips, indels, or mismatches near the variant window. Clean M-only reads are skipped.</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Performance: Aligner Reuse</p>
<p>SW aligners are created <strong>once per variant</strong> in <code>count_single_variant()</code> and reused for all reads. The <code>bio::alignment::pairwise::Aligner</code> reuses internal DP buffers, avoiding repeated heap allocation.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Raw Read Window Extraction</p>
<p>Phase 3 uses <code>extract_raw_read_window()</code> instead of CIGAR-projected extraction. For complex variants (e.g., <code>TCC‚ÜíCT</code> represented as <code>DEL+INS</code> in CIGAR), CIGAR projection produces a hybrid sequence matching neither haplotype. Raw extraction returns the contiguous read bases that SW can correctly classify.</p>
</div>
<hr>
<h2 id="limitations">Limitations<a class="headerlink" href="#limitations" title="Permanent link">¬∂</a></h2>
<ol>
<li>
<p><strong>Windowed scan range</strong> ‚Äî Indels shifted beyond the context padding from their expected position won't be detected by the CIGAR-based check. Phase 3 SW can catch some of these via <code>ref_context</code>, but only if the read shows evidence (indels/clips) near the variant. <a href="../variant-normalization/#adaptive-context-padding">Adaptive context padding</a> (enabled by default) automatically increases the window in repeat regions where shifted indels are most common.</p>
</li>
<li>
<p><strong>Score margin ‚â• 2</strong> ‚Äî The SW margin is fixed at 2 points (using <code>&gt;=</code>). Very short variants in highly repetitive regions may produce ambiguous scores.</p>
</li>
<li>
<p><strong>Soft-clip recovery</strong> ‚Äî Phase 1 includes soft-clipped bases that overlap the variant window, but only when <code>ref_pos</code> is within the variant region. Soft clips at the edge of reads far from the variant are not considered.</p>
</li>
<li>
<p><strong>MNP strict matching</strong> ‚Äî MNP strict matching is all-or-nothing, but inconclusive reads fall back to the complex variant classification chain (Phase 2 ‚Üí 2.5 ‚Üí 3). The fallback rescues reads with low-quality bases or partial matches that strict matching would reject.</p>
</li>
<li>
<p><strong>Incomplete variant definitions</strong> ‚Äî When the <abbr title="Mutation Annotation Format - Standard mutation annotation file format">MAF</abbr>/<abbr title="Variant Call Format - Standard variant call file format">VCF</abbr> represents a complex event incompletely (e.g., <code>TCC‚ÜíCT</code> omitting an adjacent SNV), reads may carry a different CIGAR signature than expected. The dual-trigger local fallback in Phase 3 mitigates this by soft-clipping "frameshifted flanks" caused by the definition mismatch.</p>
</li>
</ol>
<hr>
<h2 id="related">Related<a class="headerlink" href="#related" title="Permanent link">¬∂</a></h2>
<ul>
<li><a href="../variant-normalization/">Variant Normalization</a> ‚Äî How variants are prepared before classification</li>
<li><a href="../read-filters/">Read Filters</a> ‚Äî Which reads reach the allele checker</li>
<li><a href="../counting-metrics/">Counting &amp; Metrics</a> ‚Äî How classifications become counts</li>
<li><a href="../glossary/">Glossary</a> ‚Äî Term definitions</li>
</ul>
<!-- Abbreviation definitions for py-gbcms documentation -->
<!-- These provide hover tooltips for technical acronyms -->
<p><span hidden="">abbreviations</span></p></div>
<aside class="md-source-file">
<span class="md-source-file__fact">
<span class="md-icon" title="Last update">
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"></path></svg>
</span>
<span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago" title="February 19, 2026 23:58:14 UTC"><span class="timeago" datetime="2026-02-19T23:58:14+00:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="February 19, 2026 23:58:14 UTC">2026-02-19</span>
</span>
<span class="md-source-file__fact">
<span class="md-icon" title="Created">
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"></path></svg>
</span>
<span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago" title="February 18, 2026 21:59:37 UTC"><span class="timeago" datetime="2026-02-18T21:59:37+00:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="February 18, 2026 21:59:37 UTC">2026-02-18</span>
</span>
</aside>
</article>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Back to top
</button>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
<div class="md-copyright__highlight">
      Developed by <a href="https://github.com/rhshah">Ronak H Shah</a> @ 
<a href="https://www.mskcc.org">MSKCC</a> | 
Built with <a href="https://antigravity.google/">Antigravity</a> | 
<a href="https://github.com/msk-access/py-gbcms/blob/main/LICENSE">AGPL-3.0</a>
</div>
</div>
<div class="md-social">
<a class="md-social__link" href="https://github.com/msk-access/py-gbcms" rel="noopener" target="_blank" title="github.com">
<svg viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg>
</a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.instant", "navigation.tracking", "navigation.sections", "navigation.expand", "navigation.top", "navigation.indexes", "navigation.path", "toc.follow", "content.code.copy", "content.code.annotate", "search.suggest", "search.highlight"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"default": "stable", "provider": "mike"}}</script>
<script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
<script src="../../js/timeago.min.js"></script>
<script src="../../js/timeago_mkdocs_material.js"></script>
<script src="../../javascripts/mathjax.js"></script>
<script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
<script src="../../assets/javascripts/panzoom.min.js"></script>
<script src="../../assets/javascripts/zoompan.js"></script>
<script type="module">import mermaid from "https://unpkg.com/mermaid@11.4.0/dist/mermaid.esm.min.mjs";
window.mermaidConfig = {default: {
    startOnLoad: false
}};</script>
<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(()=>{ lightbox.reload(); });
</script></body></html>