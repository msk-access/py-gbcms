{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"Introduction","text":"<p>gbcms (Get Base Counts Multi-Sample) is a high-performance tool for extracting base counts and variant metrics from BAM files. It is designed for accuracy, speed, and ease of use in bioinformatics pipelines.</p>"},{"location":"#key-features","title":"Key Features","text":"<ul> <li>Rust-Powered Engine: Core counting logic is implemented in Rust for maximum performance and memory efficiency.</li> <li>Accurate Variant Handling: <ul> <li>Full support for VCF and MAF input formats.</li> <li>Rigorous normalization of indels and complex variants using the reference genome.</li> <li>Validation of input variants against the reference FASTA.</li> </ul> </li> <li>Comprehensive Metrics:<ul> <li>Standard depth (DP), reference depth (RD), and alternate depth (AD).</li> <li>Strand-specific counts (Forward/Reverse).</li> <li>Fragment-level counts (deduplicated by fragment ID).</li> <li>Variant Allele Fractions (VAF) at read and fragment levels.</li> <li>Strand Bias Statistics: Fisher's Exact Test p-values (<code>FSB_PVAL</code>) and Odds Ratios (<code>FSB_OR</code>) calculated at the fragment level.</li> </ul> </li> <li>Modern CLI: User-friendly command-line interface with rich output and progress bars.</li> <li>Flexible Input: Support for single BAMs, lists of BAMs (File of Files), and automatic sample naming.</li> </ul>"},{"location":"#architecture","title":"Architecture","text":"<p>gbcms uses a hybrid Python/Rust architecture: *   Python (v2): Handles CLI, input parsing (VCF/MAF), orchestration, and output formatting. *   Rust: Performs the computationally intensive task of iterating over reads, piling up bases, and calculating statistics.</p>"},{"location":"#next-steps","title":"Next Steps","text":"<ul> <li>Install gbcms</li> <li>Learn how to use the CLI</li> <li>Understand Input/Output formats</li> </ul>"},{"location":"CHANGELOG/","title":"Changelog","text":"<p>All notable changes to this project will be documented in this file.</p> <p>The format is based on Keep a Changelog, and this project adheres to Semantic Versioning.</p>"},{"location":"CHANGELOG/#200-2025-11-21","title":"[2.0.0] - 2025-11-21","text":""},{"location":"CHANGELOG/#major-rewrite","title":"\ud83d\ude80 Major Rewrite","text":"<p>Version 2.0.0 represents a complete rewrite of py-gbcms with a focus on performance, correctness, and modern architecture.</p>"},{"location":"CHANGELOG/#added","title":"\u2728 Added","text":""},{"location":"CHANGELOG/#core-features","title":"Core Features","text":"<ul> <li>Rust-based Counting Engine: Hybrid Python/Rust architecture for 20x+ performance improvement</li> <li>Strand Bias Statistics: Fisher's exact test p-values and odds ratios for both reads (<code>SB_PVAL</code>, <code>SB_OR</code>) and fragments (<code>FSB_PVAL</code>, <code>FSB_OR</code>)</li> <li>Fragment-Level Counting: Majority-rule fragment counting with strand-specific counts (<code>RDF</code>, <code>ADF</code>)</li> <li>Variant Allele Fractions: Read-level (<code>VAF</code>) and fragment-level (<code>FAF</code>) allele fraction calculations</li> <li>Thread Control: Explicit control over parallelism via <code>--threads</code> argument (default: 1)</li> </ul>"},{"location":"CHANGELOG/#inputoutput","title":"Input/Output","text":"<ul> <li>VCF Output Format: Standard VCF with comprehensive INFO and FORMAT fields</li> <li>MAF Output Format: Extended MAF with custom columns for strand counts and statistics</li> <li>Column Preservation: Input MAF columns are preserved in output</li> <li>Multiple BAM Support: Process multiple samples via <code>--bam-list</code> or repeated <code>--bam</code> arguments</li> <li>Sample ID Override: Explicit sample naming via <code>--bam sample_id:path</code> syntax</li> </ul>"},{"location":"CHANGELOG/#filters","title":"Filters","text":"<ul> <li><code>--filter-duplicates</code>: Filter duplicate reads (default: enabled)</li> <li><code>--filter-secondary</code>: Filter secondary alignments</li> <li><code>--filter-supplementary</code>: Filter supplementary alignments</li> <li><code>--filter-qc-failed</code>: Filter reads that failed QC</li> <li><code>--filter-improper-pair</code>: Filter improperly paired reads</li> <li><code>--filter-indel</code>: Filter reads with indels in CIGAR</li> </ul>"},{"location":"CHANGELOG/#cli-usability","title":"CLI &amp; Usability","text":"<ul> <li>Modern CLI: Built with Typer and Rich for beautiful terminal output</li> <li>Progress Tracking: Real-time progress bars and status indicators</li> <li>Direct Invocation: Use <code>gbcms run</code> instead of <code>python -m gbcms.cli</code></li> <li>Output Customization: <code>--suffix</code> flag for output filename customization</li> <li>Flexible Input: Support for both VCF and MAF input formats</li> </ul>"},{"location":"CHANGELOG/#infrastructure","title":"Infrastructure","text":"<ul> <li>Docker Support: Production-ready multi-stage Dockerfile with optimized layers</li> <li>Type Safety: Full type annotations with mypy support</li> <li>Type Stubs: Provided <code>.pyi</code> stub file for Rust extension</li> <li>Comprehensive Tests: Extended test suite with accuracy and filter validation</li> <li>CI/CD: GitHub Actions workflows for testing, linting, and releases</li> </ul>"},{"location":"CHANGELOG/#changed","title":"\ud83d\udd04 Changed","text":""},{"location":"CHANGELOG/#architecture","title":"Architecture","text":"<ul> <li>Migrated from pure Python to hybrid Python/Rust architecture</li> <li>Core counting logic implemented in Rust using <code>rust-htslib</code></li> <li>Data parallelism over variants with per-thread BAM readers</li> </ul>"},{"location":"CHANGELOG/#output-formats","title":"Output Formats","text":"<ul> <li>VCF FORMAT fields: Strand-specific counts now use comma-separated values (e.g., <code>RD=5,3</code> for forward,reverse)</li> <li>MAF columns: Standardized column names (<code>t_ref_count_forward</code>, <code>t_alt_count_reverse</code>, etc.)</li> <li>Coordinate System: Internal 0-based indexing with correct conversion for VCF (1-based) and MAF output</li> </ul>"},{"location":"CHANGELOG/#performance","title":"Performance","text":"<ul> <li>Speed: 20x+ faster than v1.x on typical datasets</li> <li>Memory: Efficient per-thread BAM readers with minimal overhead</li> <li>Scalability: Configurable thread pool for optimal resource usage</li> </ul>"},{"location":"CHANGELOG/#dependencies","title":"Dependencies","text":"<ul> <li>Python: Updated to require Python \u22653.10</li> <li>Rust: pyo3 0.27.1, rust-htslib 0.51.0, statrs 0.18.0</li> <li>Python Packages: pysam \u22650.21.0, typer \u22650.9.0, rich \u226513.0.0, pydantic \u22652.0.0</li> </ul>"},{"location":"CHANGELOG/#removed","title":"\ud83d\uddd1\ufe0f Removed","text":"<ul> <li>Legacy Python Counting: Pure Python implementation removed in favor of Rust</li> <li>Old CLI: Deprecated <code>python -m gbcms.cli</code> entry point</li> <li>Unused Dependencies: Removed <code>cyvcf2</code> and <code>numba</code> (no longer needed)</li> <li>Pre-commit Hooks: Removed in favor of explicit linting in CI</li> </ul>"},{"location":"CHANGELOG/#fixed","title":"\ud83d\udc1b Fixed","text":"<ul> <li>Correct handling of complex variants (MNPs, DelIns)</li> <li>Proper strand assignment for fragment counting</li> <li>Reference validation against FASTA for all variant types</li> <li>Thread-safe BAM access with per-thread readers</li> </ul>"},{"location":"CHANGELOG/#documentation","title":"\ud83d\udcda Documentation","text":"<ul> <li>Complete rewrite of all documentation</li> <li>New guides: <code>INSTALLATION.md</code>, <code>CLI_FEATURES.md</code>, <code>INPUT_OUTPUT.md</code></li> <li>Comprehensive API documentation</li> <li>Docker usage examples</li> <li>Contributing guidelines updated</li> </ul>"},{"location":"CHANGELOG/#technical-details","title":"\ud83d\udd27 Technical Details","text":""},{"location":"CHANGELOG/#rust-components","title":"Rust Components","text":"<ul> <li><code>gbcms_rs</code>: PyO3-based extension module</li> <li>Fisher's exact test via <code>statrs</code> crate</li> <li>Rayon-based parallelism with configurable thread pools</li> <li>Safe memory management with Rust's ownership model</li> </ul>"},{"location":"CHANGELOG/#testing","title":"Testing","text":"<ul> <li>16 comprehensive test cases</li> <li>Accuracy validation with synthetic BAM files</li> <li>Filter validation for all read flag combinations</li> <li>Integration tests with real-world data</li> </ul>"},{"location":"CHANGELOG/#breaking-changes","title":"\u26a0\ufe0f Breaking Changes","text":"<p>Version 2.0.0 is not backward compatible with 1.x. Key breaking changes:</p> <ol> <li>CLI syntax: Use <code>gbcms run</code> instead of <code>python -m gbcms.cli</code></li> <li>Output format: VCF/MAF column structures have changed</li> <li>Default behavior: Only duplicate filtering enabled by default (was: all filters)</li> <li>Dependencies: Requires Rust toolchain for installation from source</li> <li>Python version: Minimum Python 3.10 (was: 3.8)</li> </ol>"},{"location":"CHANGELOG/#installation","title":"\ud83d\udce6 Installation","text":"<pre><code># From PyPI (includes pre-built wheels)\npip install py-gbcms\n\n# From source (requires Rust)\npip install git+https://github.com/msk-access/py-gbcms.git\n\n# Docker\ndocker pull ghcr.io/msk-access/py-gbcms:2.0.0\n</code></pre>"},{"location":"CHANGELOG/#acknowledgments","title":"\ud83d\ude4f Acknowledgments","text":"<p>This rewrite was designed and implemented with a focus on correctness, performance, and modern best practices in bioinformatics software development.</p>"},{"location":"CHANGELOG/#1x-legacy","title":"[1.x] - Legacy","text":"<p>Previous versions (1.x) used a pure Python implementation. See git history for details.</p>"},{"location":"CLI_FEATURES/","title":"CLI Reference","text":"<p>The primary entry point for gbcms is the <code>run</code> command.</p> <pre><code>gbcms run [OPTIONS]\n</code></pre>"},{"location":"CLI_FEATURES/#arguments","title":"Arguments","text":"Option Short Description Required <code>--variants</code> <code>-v</code> Path to VCF or MAF file containing variants to count. Yes <code>--fasta</code> <code>-f</code> Path to the reference genome FASTA file. Yes <code>--output-dir</code> <code>-o</code> Directory where output files will be written. Yes <code>--bam</code> <code>-b</code> Path to a BAM file. Can be used multiple times. Supports <code>ID:path</code> format. No* <code>--bam-list</code> <code>-L</code> Path to a file containing a list of BAM paths (one per line, optional ID column). No* <code>--format</code> Output format: <code>vcf</code> or <code>maf</code>. Default: <code>vcf</code>. No <code>--suffix</code> <code>-S</code> Suffix to append to output filename (e.g. <code>.genotyped</code>). No <code>--threads</code> <code>-t</code> Number of threads. Default: <code>1</code>. No <code>--min-mapq</code> Minimum mapping quality (MAPQ) to include a read. Default: <code>20</code>. No <code>--min-baseq</code> Minimum base quality to count a base. Default: <code>0</code>. No <code>--filter-duplicates</code> Filter duplicate reads. Default: <code>True</code>. No <code>--filter-qc-failed</code> Filter reads failing platform/vendor quality checks. Default: <code>False</code>. No <code>--filter-improper-pair</code> Filter reads that are not marked as proper pairs. Default: <code>False</code>. No <code>--filter-indel</code> Filter reads containing insertions or deletions. Default: <code>False</code>. No <code>--filter-secondary</code> Filter secondary alignments. Default: <code>False</code>. No <code>--filter-supplementary</code> Filter supplementary alignments. Default: <code>False</code>. No <p>* At least one of <code>--bam</code> or <code>--bam-list</code> must be provided.</p>"},{"location":"CLI_FEATURES/#examples","title":"Examples","text":""},{"location":"CLI_FEATURES/#1-single-sample-vcf-output","title":"1. Single Sample, VCF Output","text":"<pre><code>gbcms run \\\n    --variants input.vcf \\\n    --fasta reference.fa \\\n    --bam sample1.bam \\\n    --output-dir results \\\n    --format vcf\n</code></pre>"},{"location":"CLI_FEATURES/#2-multiple-samples-maf-output","title":"2. Multiple Samples, MAF Output","text":"<pre><code>gbcms run \\\n    --variants input.maf \\\n    --fasta reference.fa \\\n    --bam sample1.bam \\\n    --bam sample2.bam \\\n    --output-dir results \\\n    --format maf\n</code></pre>"},{"location":"CLI_FEATURES/#3-file-of-files-fof","title":"3. File of Files (FoF)","text":"<p>If you have many BAM files, list them in a text file (e.g., <code>bams.txt</code>):</p> <pre><code>SampleID1   /path/to/sample1.bam\nSampleID2   /path/to/sample2.bam\n</code></pre> <p>Then run:</p> <pre><code>gbcms run \\\n    --variants input.vcf \\\n    --fasta reference.fa \\\n    --bam-list bams.txt \\\n    --output-dir results\n</code></pre>"},{"location":"CONTRIBUTING/","title":"Contributing to GetBaseCounts","text":"<p>Thank you for your interest in contributing to GetBaseCounts! This document provides guidelines and instructions for contributing.</p>"},{"location":"CONTRIBUTING/#development-setup","title":"Development Setup","text":"<ol> <li> <p>Clone the repository <pre><code>git clone https://github.com/msk-access/py-gbcms.git\ncd py-gbcms\n</code></pre></p> </li> <li> <p>Install uv (if not already installed)    <pre><code>curl -LsSf https://astral.sh/uv/install.sh | sh\n</code></pre></p> </li> <li> <p>Install development dependencies <pre><code>uv pip install -e \".[dev]\"\n</code></pre></p> </li> </ol>"},{"location":"CONTRIBUTING/#development-workflow","title":"Development Workflow","text":""},{"location":"CONTRIBUTING/#running-tests","title":"Running Tests","text":"<pre><code># Run all tests\npytest\n\n# Run with coverage\npytest --cov=gbcms --cov-report=html\n\n# Run specific test file\npytest tests/test_counter.py\n\n# Run with verbose output\npytest -v\n</code></pre>"},{"location":"CONTRIBUTING/#code-quality","title":"Code Quality","text":"<pre><code># Format code\nblack src/ tests/\n\n# Lint code\nruff check src/ tests/\n\n# Fix linting issues automatically\nruff check --fix src/ tests/\n\n# Type checking\nmypy src/\n</code></pre>"},{"location":"CONTRIBUTING/#building-and-testing-docker","title":"Building and Testing Docker","text":"<pre><code># Build Docker image\ndocker build -t gbcms:latest .\n</code></pre>"},{"location":"CONTRIBUTING/#code-style","title":"Code Style","text":"<ul> <li>Follow PEP 8 style guidelines</li> <li>Use type hints for all function signatures</li> <li>Write docstrings for all public functions and classes</li> <li>Keep functions focused and single-purpose</li> <li>Maximum line length: 100 characters</li> </ul>"},{"location":"CONTRIBUTING/#testing-guidelines","title":"Testing Guidelines","text":"<ul> <li>Write tests for all new features</li> <li>Maintain or improve code coverage</li> <li>Use descriptive test names</li> <li>Use fixtures for common test setup</li> <li>Test edge cases and error conditions</li> </ul>"},{"location":"CONTRIBUTING/#pull-request-process","title":"Pull Request Process","text":"<ol> <li> <p>Create a feature branch <pre><code>git checkout -b feature/your-feature-name\n</code></pre></p> </li> <li> <p>Make your changes</p> </li> <li>Write code following the style guidelines</li> <li>Add tests for new functionality</li> <li> <p>Update documentation as needed</p> </li> <li> <p>Run tests and linters <pre><code>make test\nmake lint\n</code></pre></p> </li> <li> <p>Commit your changes <pre><code>git add .\ngit commit -m \"Description of your changes\"\n</code></pre></p> </li> <li> <p>Push to your fork <pre><code>git push origin feature/your-feature-name\n</code></pre></p> </li> <li> <p>Create a Pull Request</p> </li> <li>Provide a clear description of the changes</li> <li>Reference any related issues</li> <li>Ensure all CI checks pass</li> </ol>"},{"location":"CONTRIBUTING/#reporting-issues","title":"Reporting Issues","text":"<p>When reporting issues, please include:</p> <ul> <li>Python version</li> <li>Operating system</li> <li>Steps to reproduce</li> <li>Expected behavior</li> <li>Actual behavior</li> <li>Error messages or logs</li> </ul>"},{"location":"CONTRIBUTING/#feature-requests","title":"Feature Requests","text":"<p>We welcome feature requests! Please:</p> <ul> <li>Check if the feature already exists</li> <li>Provide a clear use case</li> <li>Describe the expected behavior</li> <li>Consider submitting a PR if you can implement it</li> </ul>"},{"location":"CONTRIBUTING/#code-of-conduct","title":"Code of Conduct","text":"<ul> <li>Be respectful and inclusive</li> <li>Welcome newcomers</li> <li>Focus on constructive feedback</li> <li>Help others learn and grow</li> </ul>"},{"location":"CONTRIBUTING/#questions","title":"Questions?","text":"<p>Feel free to open an issue for questions or reach out to the maintainers.</p> <p>Thank you for contributing!</p>"},{"location":"INPUT_OUTPUT/","title":"Input &amp; Output Formats","text":""},{"location":"INPUT_OUTPUT/#input-formats","title":"Input Formats","text":""},{"location":"INPUT_OUTPUT/#variants","title":"Variants","text":"<p>gbcms supports VCF and MAF formats for defining the variants to count. It handles: *   SNPs: Single Nucleotide Polymorphisms. *   MNPs: Multi-Nucleotide Polymorphisms. *   Insertions: Pure insertions. *   Deletions: Pure deletions. *   Complex: Mixed variants (e.g., DelIns, SNP+Indel). These are handled via Haplotype Reconstruction, where the read's sequence is reconstructed and compared to the ALT allele.</p> <ul> <li>VCF (<code>.vcf</code>, <code>.vcf.gz</code>): Standard format. Coordinates are 1-based.</li> <li>MAF (<code>.maf</code>): Mutation Annotation Format.<ul> <li>Requirement: When using MAF input, you must provide the reference FASTA. gbcms uses the FASTA to normalize MAF indels (which often use <code>-</code>) into the VCF-style anchor-based representation required for accurate counting.</li> </ul> </li> </ul>"},{"location":"INPUT_OUTPUT/#alignments","title":"Alignments","text":"<ul> <li>BAM (<code>.bam</code>): Standard binary alignment map format. Must be indexed (<code>.bai</code>).</li> </ul>"},{"location":"INPUT_OUTPUT/#output-formats","title":"Output Formats","text":"<p>gbcms produces one output file per input BAM sample, named <code>{sample_name}.{ext}</code>.</p>"},{"location":"INPUT_OUTPUT/#vcf-output-format-vcf","title":"VCF Output (<code>--format vcf</code>)","text":"<p>A standard VCF file containing the input variants with added FORMAT fields for counts.</p> <p>Header Fields: *   <code>DP</code>: Total Depth (<code>ref_total,alt_total</code>) *   <code>RD</code>: Reference Read Depth (<code>fwd,rev</code>) *   <code>AD</code>: Alternate Read Depth (<code>fwd,rev</code>) *   <code>RDF</code>: Reference Fragment Depth (<code>fwd,rev</code>) *   <code>ADF</code>: Alternate Fragment Depth (<code>fwd,rev</code>) *   <code>VAF</code>: Variant Allele Fraction (Read Level) *   <code>FAF</code>: Variant Allele Fraction (Fragment Level) *   <code>SB_PVAL</code>: Fisher's Exact Test p-value for strand bias (read-level). *   <code>SB_OR</code>: Odds Ratio for strand bias (read-level). *   <code>FSB_PVAL</code>: Fisher's Exact Test p-value for strand bias (fragment-level). *   <code>FSB_OR</code>: Odds Ratio for strand bias (fragment-level).</p>"},{"location":"INPUT_OUTPUT/#maf-output-format-maf","title":"MAF Output (<code>--format maf</code>)","text":"<p>A tab-separated file containing standard GDC MAF columns plus custom count columns.</p> <p>Standard Columns: *   <code>Hugo_Symbol</code>, <code>Chromosome</code>, <code>Start_Position</code>, <code>End_Position</code>, <code>Reference_Allele</code>, <code>Tumor_Seq_Allele2</code>, <code>Tumor_Sample_Barcode</code>, <code>t_depth</code>, <code>t_ref_count</code>, <code>t_alt_count</code>.</p> <p>Custom Columns: *   <code>t_ref_count_forward</code>, <code>t_ref_count_reverse</code> *   <code>t_alt_count_forward</code>, <code>t_alt_count_reverse</code> *   <code>t_ref_count_fragment_forward</code>, <code>t_ref_count_fragment_reverse</code> *   <code>t_alt_count_fragment_forward</code>, <code>t_alt_count_fragment_reverse</code> *   <code>t_vaf</code>: Variant Allele Fraction (Read Level) *   <code>t_vaf_fragment</code>: Variant Allele Fraction (Fragment Level) *   <code>vcf_region</code>: <code>CHROM:POS:REF:ALT</code> (VCF-style representation). *   <code>fsb_pval</code>: Fisher's Exact Test p-value for strand bias. *   <code>fsb_or</code>: Odds Ratio for strand bias.</p>"},{"location":"INSTALLATION/","title":"Installation","text":"<p>gbcms requires a Python environment and the Rust toolchain to build the core engine.</p>"},{"location":"INSTALLATION/#prerequisites","title":"Prerequisites","text":"<ul> <li>Python: 3.10 or higher</li> <li>Rust: Latest stable version (install via rustup)</li> </ul>"},{"location":"INSTALLATION/#installing-from-source","title":"Installing from Source","text":"<ol> <li> <p>Clone the repository:     <pre><code>git clone https://github.com/msk-access/py-gbcms.git\ncd py-gbcms\n</code></pre></p> </li> <li> <p>Create a virtual environment (recommended):     <pre><code>python -m venv .venv\nsource .venv/bin/activate\n</code></pre></p> </li> <li> <p>Install dependencies and build:     This command will install Python dependencies and compile the Rust extension (<code>gbcms_rs</code>).     <pre><code>pip install .\n</code></pre></p> <p>Note: If you are developing, use <code>pip install -e .</code> for editable mode.</p> </li> </ol>"},{"location":"INSTALLATION/#verifying-installation","title":"Verifying Installation","text":"<p>Run the help command to verify that the CLI is accessible:</p> <pre><code>gbcms --help\n</code></pre> <p>You should see the help message for the <code>gbcms</code> command.</p>"},{"location":"INSTALLATION/#using-docker","title":"Using Docker","text":"<p>Docker is the recommended way to run gbcms to ensure a consistent environment.</p>"},{"location":"INSTALLATION/#1-build-the-image","title":"1. Build the Image","text":"<pre><code>docker build -t gbcms:latest .\n</code></pre>"},{"location":"INSTALLATION/#2-run-with-docker","title":"2. Run with Docker","text":"<p>When running with Docker, you need to mount your data directories so the container can access them.</p> <pre><code>docker run --rm \\\n    -v /path/to/data:/data \\\n    gbcms:latest \\\n    run \\\n    --variants /data/variants.vcf \\\n    --fasta /data/reference.fa \\\n    --bam /data/sample.bam \\\n    --output-dir /data/output\n</code></pre> <p>Note: All paths passed to <code>gbcms</code> must be paths inside the container (e.g., <code>/data/...</code>).</p>"},{"location":"SUMMARY/","title":"Table of Contents","text":"<ul> <li>Introduction</li> </ul>"},{"location":"SUMMARY/#getting-started","title":"Getting Started","text":"<ul> <li>Installation</li> <li>Quick Start</li> </ul>"},{"location":"SUMMARY/#usage","title":"Usage","text":"<ul> <li>CLI Reference</li> <li>Input &amp; Output Formats</li> <li>Advanced Usage</li> </ul>"},{"location":"SUMMARY/#development","title":"Development","text":"<ul> <li>Contributing</li> <li>Architecture</li> <li>Changelog</li> </ul>"},{"location":"SUMMARY/#links","title":"Links","text":"<ul> <li>GitHub Repository</li> <li>PyPI Package</li> <li>GHCR Package</li> </ul>"},{"location":"advanced-usage/","title":"Advanced Usage","text":""},{"location":"advanced-usage/#thread-configuration","title":"Thread Configuration","text":"<p>Control parallelism with the <code>--threads</code> argument:</p> <pre><code># Single-threaded (default, safest)\ngbcms run ... --threads 1\n\n# Multi-threaded for faster processing\ngbcms run ... --threads 4\n\n# Use all available cores\ngbcms run ... --threads 0\n</code></pre> <p>How it works: - Variants are processed in parallel - Each thread has its own BAM reader - Thread-safe random access to BAM files</p>"},{"location":"advanced-usage/#custom-sample-ids","title":"Custom Sample IDs","text":"<p>Override the default sample ID (derived from BAM filename):</p> <pre><code># CLI argument\ngbcms run ... --bam \"MySampleID:/path/to/sample.bam\"\n\n# BAM list file\ncat bams.txt\nTumorSample    /data/tumor.bam\nNormalSample   /data/normal.bam\n</code></pre> <p>Sample IDs are used in: - Output filenames: <code>{sample_id}{suffix}.{format}</code> - VCF sample columns - MAF <code>Tumor_Sample_Barcode</code> field</p>"},{"location":"advanced-usage/#output-customization","title":"Output Customization","text":""},{"location":"advanced-usage/#custom-suffixes","title":"Custom Suffixes","text":"<pre><code>gbcms run ... --suffix .genotyped\n# Output: sample.genotyped.vcf\n</code></pre>"},{"location":"advanced-usage/#output-directory-structure","title":"Output Directory Structure","text":"<pre><code>gbcms run --output-dir results/batch1/\n# Creates: results/batch1/{sample_id}.vcf\n</code></pre>"},{"location":"advanced-usage/#filter-combinations","title":"Filter Combinations","text":""},{"location":"advanced-usage/#strict-quality-filters","title":"Strict Quality Filters","text":"<pre><code>gbcms run ... \\\n  --min-mapping-quality 30 \\\n  --min-base-quality 20 \\\n  --filter-duplicates \\\n  --filter-secondary \\\n  --filter-supplementary \\\n  --filter-qc-failed\n</code></pre>"},{"location":"advanced-usage/#paired-end-only","title":"Paired-End Only","text":"<pre><code>gbcms run ... \\\n  --filter-improper-pair\n</code></pre>"},{"location":"advanced-usage/#exclude-reads-with-indels","title":"Exclude Reads with Indels","text":"<pre><code>gbcms run ... \\\n  --filter-indel\n</code></pre>"},{"location":"advanced-usage/#docker-usage","title":"Docker Usage","text":""},{"location":"advanced-usage/#basic-run","title":"Basic Run","text":"<pre><code>docker run -v /data:/data ghcr.io/msk-access/py-gbcms:2.0.0 \\\n  gbcms run \\\n  --fasta /data/reference.fa \\\n  --bam /data/sample.bam \\\n  --variants /data/variants.vcf \\\n  --output-dir /data/results/\n</code></pre>"},{"location":"advanced-usage/#interactive-mode","title":"Interactive Mode","text":"<pre><code>docker run -it -v /data:/data ghcr.io/msk-access/py-gbcms:2.0.0 bash\n# Inside container:\ngbcms run ...\n</code></pre>"},{"location":"advanced-usage/#performance-tips","title":"Performance Tips","text":""},{"location":"advanced-usage/#1-index-your-files","title":"1. Index Your Files","text":"<p>Ensure all input files are indexed: <pre><code>samtools index sample.bam\nsamtools faidx reference.fa\ntabix -p vcf variants.vcf.gz  # For compressed VCF\n</code></pre></p>"},{"location":"advanced-usage/#2-optimal-thread-count","title":"2. Optimal Thread Count","text":"<ul> <li>Small datasets (&lt;10K variants): 1-2 threads</li> <li>Medium datasets (10K-100K): 4-8 threads</li> <li>Large datasets (&gt;100K): 8-16 threads</li> </ul>"},{"location":"advanced-usage/#3-batch-processing","title":"3. Batch Processing","text":"<p>Process multiple samples in parallel using shell:</p> <pre><code># GNU Parallel\nparallel -j 4 gbcms run --fasta ref.fa --variants vars.vcf --bam {} --output-dir results/ ::: *.bam\n\n# Simple loop\nfor bam in *.bam; do\n  gbcms run --fasta ref.fa --variants vars.vcf --bam $bam --output-dir results/ &amp;\ndone\nwait\n</code></pre>"},{"location":"advanced-usage/#troubleshooting","title":"Troubleshooting","text":""},{"location":"advanced-usage/#bam-index-missing","title":"BAM Index Missing","text":"<pre><code>Error: Could not open BAM index\n</code></pre> <p>Solution: <pre><code>samtools index your_file.bam\n</code></pre></p>"},{"location":"advanced-usage/#chromosome-mismatch","title":"Chromosome Mismatch","text":"<pre><code>Warning: BAM may not contain variant chromosomes\n</code></pre> <p>Cause: VCF uses <code>chr1</code> but BAM uses <code>1</code> (or vice versa)</p> <p>Solution: Ensure consistent chromosome naming between files</p>"},{"location":"advanced-usage/#out-of-memory","title":"Out of Memory","text":"<p>Solution: Reduce thread count: <pre><code>gbcms run ... --threads 1\n</code></pre></p>"},{"location":"advanced-usage/#slow-performance","title":"Slow Performance","text":"<p>Checklist: - \u2705 Files are indexed - \u2705 Using multiple threads - \u2705 BAM files are on fast storage (SSD, not NFS) - \u2705 Variant list is pre-filtered</p>"},{"location":"advanced-usage/#integration-examples","title":"Integration Examples","text":""},{"location":"advanced-usage/#nextflow-pipeline","title":"Nextflow Pipeline","text":"<pre><code>process countBases {\n  input:\n    tuple val(sample_id), path(bam), path(bai)\n    path reference\n    path variants\n\n  output:\n    path \"${sample_id}.vcf\"\n\n  script:\n  \"\"\"\n  gbcms run \\\n    --fasta ${reference} \\\n    --bam ${bam} \\\n    --variants ${variants} \\\n    --output-dir . \\\n    --threads ${task.cpus}\n  \"\"\"\n}\n</code></pre>"},{"location":"advanced-usage/#snakemake-workflow","title":"Snakemake Workflow","text":"<pre><code>rule count_bases:\n    input:\n        bam=\"data/{sample}.bam\",\n        bai=\"data/{sample}.bam.bai\",\n        ref=\"reference.fa\",\n        vcf=\"variants.vcf\"\n    output:\n        \"results/{sample}.vcf\"\n    threads: 4\n    shell:\n        \"\"\"\n        gbcms run \\\n          --fasta {input.ref} \\\n          --bam {input.bam} \\\n          --variants {input.vcf} \\\n          --output-dir results/ \\\n          --threads {threads}\n        \"\"\"\n</code></pre>"},{"location":"advanced-usage/#environment-variables","title":"Environment Variables","text":"<p>Currently, py-gbcms does not use environment variables for configuration. All settings are passed via CLI arguments.</p>"},{"location":"architecture/","title":"Architecture","text":""},{"location":"architecture/#overview","title":"Overview","text":"<p>py-gbcms 2.0 uses a hybrid Python/Rust architecture for optimal performance and usability.</p> <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502          Python Layer (CLI)             \u2502\n\u2502  - Typer CLI                            \u2502\n\u2502  - Rich UI                              \u2502\n\u2502  - Input validation                     \u2502\n\u2502  - Output formatting                    \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n             \u2502\n             \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502      Python I/O Layer (pysam)           \u2502\n\u2502  - VCF/MAF reading                      \u2502\n\u2502  - Reference validation                 \u2502\n\u2502  - VCF/MAF writing                      \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n             \u2502\n             \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502    Rust Counting Engine (gbcms_rs)     \u2502\n\u2502  - BAM access (rust-htslib)             \u2502\n\u2502  - Parallel processing (rayon)          \u2502\n\u2502  - Fisher's exact test (statrs)         \u2502\n\u2502  - Fragment counting                    \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"architecture/#components","title":"Components","text":""},{"location":"architecture/#1-python-cli-srcgbcms","title":"1. Python CLI (<code>src/gbcms/</code>)","text":"<p>Modules: - <code>cli.py</code> - Typer-based command-line interface - <code>pipeline.py</code> - Main orchestration logic - <code>models/core.py</code> - Pydantic configuration models</p> <p>Responsibilities: - Parse command-line arguments - Validate configuration - Coordinate input/output - Display progress to user</p>"},{"location":"architecture/#2-python-io-srcgbcmsio","title":"2. Python I/O (<code>src/gbcms/io/</code>)","text":"<p>Modules: - <code>input.py</code> - VCF/MAF readers, reference validation - <code>output.py</code> - VCF/MAF writers</p> <p>Key Classes: - <code>VcfReader</code> - Parse VCF files via pysam - <code>MafReader</code> - Parse MAF files, normalize indels - <code>ReferenceChecker</code> - Validate variants against FASTA - <code>VcfWriter</code> - Write VCF with custom FORMAT fields - <code>MafWriter</code> - Write MAF with preserved columns</p>"},{"location":"architecture/#3-rust-counting-engine-srcgbcms_rs","title":"3. Rust Counting Engine (<code>src/gbcms_rs/</code>)","text":"<p>Modules: - <code>lib.rs</code> - PyO3 Python bindings - <code>types.rs</code> - Variant and BaseCounts structs - <code>counting.rs</code> - Core counting logic - <code>stats.rs</code> - Fisher's exact test</p> <p>Key Functions: - <code>count_bam()</code> - Main entry point, parallelizes over variants - <code>count_single_variant()</code> - Process one variant - <code>check_allele()</code> - Determine if read matches ref/alt - <code>fisher_exact_test()</code> - Calculate strand bias statistics</p>"},{"location":"architecture/#data-flow","title":"Data Flow","text":""},{"location":"architecture/#input-processing","title":"Input Processing","text":"<pre><code>VCF/MAF file\n    \u2502\n    \u251c\u2500\u2192 Parse with pysam\n    \u2502\n    \u251c\u2500\u2192 Convert to internal Variant model (0-based)\n    \u2502\n    \u2514\u2500\u2192 Validate against FASTA reference\n</code></pre>"},{"location":"architecture/#counting","title":"Counting","text":"<pre><code>Variants (Python list)\n    \u2502\n    \u251c\u2500\u2192 Convert to Rust Variant structs\n    \u2502\n    \u251c\u2500\u2192 Pass to count_bam() with BAM path\n    \u2502\n    \u251c\u2500\u2192 Rayon parallel iteration over variants\n    \u2502   \u2502\n    \u2502   \u251c\u2500\u2192 Thread 1: Process variants 0, 4, 8...\n    \u2502   \u251c\u2500\u2192 Thread 2: Process variants 1, 5, 9...\n    \u2502   \u251c\u2500\u2192 Thread 3: Process variants 2, 6, 10...\n    \u2502   \u2514\u2500\u2192 Thread 4: Process variants 3, 7, 11...\n    \u2502\n    \u2514\u2500\u2192 Return BaseCounts list to Python\n</code></pre>"},{"location":"architecture/#output-writing","title":"Output Writing","text":"<pre><code>BaseCounts (Rust structs)\n    \u2502\n    \u251c\u2500\u2192 Convert back to Python\n    \u2502\n    \u251c\u2500\u2192 Calculate VAF/FAF\n    \u2502\n    \u251c\u2500\u2192 Format for VCF/MAF\n    \u2502\n    \u2514\u2500\u2192 Write to file\n</code></pre>"},{"location":"architecture/#threading-model","title":"Threading Model","text":""},{"location":"architecture/#data-parallelism","title":"Data Parallelism","text":"<p>py-gbcms uses data parallelism over variants:</p> <ol> <li>The variant list is split across threads</li> <li>Each thread initializes its own BAM reader</li> <li>Each thread processes its assigned variants independently</li> <li>No shared state between threads (thread-safe)</li> </ol>"},{"location":"architecture/#why-per-thread-bam-readers","title":"Why Per-Thread BAM Readers?","text":"<ul> <li>Thread Safety: rust-htslib's <code>IndexedReader</code> is not <code>Sync</code></li> <li>Random Access: Each variant may be on a different chromosome</li> <li>Independence: No coordination needed between threads</li> <li>Correctness: Avoids race conditions</li> </ul>"},{"location":"architecture/#configuration","title":"Configuration","text":"<pre><code># Default: single-threaded (safest)\n--threads 1\n\n# Multi-threaded (4 workers)\n--threads 4\n\n# Use all cores\n--threads 0  # Auto-detect CPU count\n</code></pre>"},{"location":"architecture/#memory-usage","title":"Memory Usage","text":""},{"location":"architecture/#per-sample-memory","title":"Per-Sample Memory","text":"<ul> <li>BAM Index: Loaded once per thread (~10-50 MB)</li> <li>Variant List: Shared across threads (~1 KB per variant)</li> <li>Read Buffer: Per-thread, minimal (rust-htslib manages)</li> </ul>"},{"location":"architecture/#estimation","title":"Estimation","text":"<pre><code>Memory \u2248 (BAM Index Size \u00d7 Threads) + (Variant Count \u00d7 1 KB)\n</code></pre> <p>Example: - 10,000 variants - 4 threads - 30 MB BAM index</p> <pre><code>Memory = (30 MB \u00d7 4) + (10K \u00d7 1 KB)\n       = 120 MB + 10 MB\n       = 130 MB\n</code></pre>"},{"location":"architecture/#coordinate-systems","title":"Coordinate Systems","text":""},{"location":"architecture/#internal-0-based","title":"Internal: 0-based","text":"<p>All internal operations use 0-based, half-open coordinates: - Position 0 is the first base - Ranges are <code>[start, end)</code> (end is exclusive)</p>"},{"location":"architecture/#vcf-output-1-based","title":"VCF Output: 1-based","text":"<p>VCF format uses 1-based, inclusive coordinates: - Position 1 is the first base - Conversion: <code>vcf_pos = internal_pos + 1</code></p>"},{"location":"architecture/#maf-output-1-based","title":"MAF Output: 1-based","text":"<p>MAF format uses 1-based, inclusive coordinates: - <code>Start_Position</code> = <code>internal_pos + 1</code> - <code>End_Position</code> = <code>internal_pos + len(ref)</code></p>"},{"location":"architecture/#error-handling","title":"Error Handling","text":""},{"location":"architecture/#python-layer","title":"Python Layer","text":"<ul> <li>Input validation via Pydantic</li> <li>File existence checks</li> <li>User-friendly error messages</li> </ul>"},{"location":"architecture/#rust-layer","title":"Rust Layer","text":"<ul> <li>Result types for error propagation</li> <li>Convert Rust errors to Python exceptions</li> <li>Detailed error context</li> </ul>"},{"location":"architecture/#performance-optimizations","title":"Performance Optimizations","text":"<ol> <li>Rust for Hot Path: Counting loop in Rust</li> <li>Parallel Processing: Rayon thread pool</li> <li>Efficient BAM Access: rust-htslib with htslib C library</li> <li>Minimal Copies: Zero-copy where possible</li> <li>Release Builds: Optimized compilation (<code>--release</code>)</li> </ol>"},{"location":"architecture/#testing-strategy","title":"Testing Strategy","text":""},{"location":"architecture/#unit-tests-rust","title":"Unit Tests (Rust)","text":"<ul> <li>Allele matching logic</li> <li>Fisher's exact test</li> <li>Coordinate conversions</li> </ul>"},{"location":"architecture/#integration-tests-python","title":"Integration Tests (Python)","text":"<ul> <li>End-to-end pipeline</li> <li>VCF/MAF parsing and writing</li> <li>Filter validation</li> <li>Multi-sample processing</li> </ul>"},{"location":"architecture/#accuracy-tests","title":"Accuracy Tests","text":"<ul> <li>Synthetic BAM files with known counts</li> <li>Validate exact counts for SNPs, indels, MNPs</li> <li>Filter behavior verification</li> </ul>"},{"location":"quick-start/","title":"Quick Start","text":""},{"location":"quick-start/#basic-usage","title":"Basic Usage","text":"<p>Get started with py-gbcms in minutes.</p>"},{"location":"quick-start/#1-installation","title":"1. Installation","text":"<pre><code>pip install py-gbcms\n</code></pre>"},{"location":"quick-start/#2-prepare-your-data","title":"2. Prepare Your Data","text":"<p>You'll need: - Reference FASTA: Indexed genome reference (<code>.fa</code> + <code>.fa.fai</code>) - BAM File(s): Aligned reads (<code>.bam</code> + <code>.bam.bai</code>) - Variants: VCF or MAF file with variants to count</p>"},{"location":"quick-start/#3-run-your-first-command","title":"3. Run Your First Command","text":"<p>Single BAM, VCF output:</p> <pre><code>gbcms run \\\n  --fasta reference.fa \\\n  --bam sample.bam \\\n  --variants variants.vcf \\\n  --output-dir results/\n</code></pre> <p>Multiple BAMs, MAF output:</p> <pre><code>gbcms run \\\n  --fasta reference.fa \\\n  --bam tumor.bam \\\n  --bam normal.bam \\\n  --variants variants.maf \\\n  --format maf \\\n  --output-dir results/\n</code></pre>"},{"location":"quick-start/#4-check-your-results","title":"4. Check Your Results","text":"<p>Output files are named: <code>{sample_id}{suffix}.{format}</code></p> <pre><code>ls results/\n# sample.vcf\n# tumor.maf\n# normal.maf\n</code></pre>"},{"location":"quick-start/#common-patterns","title":"Common Patterns","text":""},{"location":"quick-start/#processing-multiple-samples","title":"Processing Multiple Samples","text":"<p>Create a BAM list file (<code>bams.txt</code>):</p> <pre><code>SampleA  /path/to/sampleA.bam\nSampleB  /path/to/sampleB.bam\nSampleC  /path/to/sampleC.bam\n</code></pre> <p>Run:</p> <pre><code>gbcms run \\\n  --fasta reference.fa \\\n  --bam-list bams.txt \\\n  --variants variants.vcf \\\n  --output-dir results/\n</code></pre>"},{"location":"quick-start/#filtering-options","title":"Filtering Options","text":"<pre><code>gbcms run ... \\\n  --min-mapping-quality 20 \\\n  --min-base-quality 10 \\\n  --filter-duplicates \\\n  --filter-secondary \\\n  --filter-supplementary\n</code></pre>"},{"location":"quick-start/#performance-tuning","title":"Performance Tuning","text":"<pre><code># Use 4 threads for faster processing\ngbcms run ... --threads 4\n\n# Custom output naming\ngbcms run ... --suffix .counted\n</code></pre>"},{"location":"quick-start/#next-steps","title":"Next Steps","text":"<ul> <li>Learn about all CLI options</li> <li>Understand input/output formats</li> <li>Explore advanced usage</li> </ul>"}]}